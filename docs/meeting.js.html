<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>meeting.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Controller_Schedule.html">Controller/Schedule</a><ul class='methods'><li data-type='method'><a href="module-Controller_Schedule.html#~calibrateTimezone">calibrateTimezone</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupCVWaitList">cleanupCVWaitList</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupDropin">cleanupDropin</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~downloadIDImages">downloadIDImages</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~followUp">followUp</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~generateInvoices">generateInvoices</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~scheduleNextRun">scheduleNextRun</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendNotifications">sendNotifications</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-Controller_authentication.html">Controller/authentication</a></li><li><a href="module-Controller_button.html">Controller/button</a><ul class='methods'><li data-type='method'><a href="module-Controller_button.html#~statusButoon">statusButoon</a></li></ul></li><li><a href="module-Controller_camera.html">Controller/camera</a><ul class='methods'><li data-type='method'><a href="module-Controller_camera.html#~countRecords">countRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~createCameraZone">createCameraZone</a></li><li data-type='method'><a href="module-Controller_camera.html#~createNewCamera">createNewCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~editCamera">editCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~enableCamera">enableCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~generateStreamURL">generateStreamURL</a></li><li data-type='method'><a href="module-Controller_camera.html#~getKinesesStreamingUrl">getKinesesStreamingUrl</a></li><li data-type='method'><a href="module-Controller_camera.html#~getNextMonitorId">getNextMonitorId</a></li><li data-type='method'><a href="module-Controller_camera.html#~getRecords">getRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~getToken">getToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~pad">pad</a></li><li data-type='method'><a href="module-Controller_camera.html#~refreshToken">refreshToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~reloadCameraStreams">reloadCameraStreams</a></li><li data-type='method'><a href="module-Controller_camera.html#~removeCamera">removeCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~triggerCameraStreams">triggerCameraStreams</a></li></ul></li><li><a href="module-Controller_contact.html">Controller/contact</a><ul class='methods'><li data-type='method'><a href="module-Controller_contact.html#~convertJsonToCsv">convertJsonToCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~getById">getById</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContact">getContact</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContactSub">getContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~getUpdate">getUpdate</a></li><li data-type='method'><a href="module-Controller_contact.html#~toCsv">toCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~updateContactSub">updateContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~validateIdLoad">validateIdLoad</a></li></ul></li><li><a href="module-Controller_dashboard.html">Controller/dashboard</a><ul class='methods'><li data-type='method'><a href="module-Controller_dashboard.html#~getDashboardStats">getDashboardStats</a></li></ul></li><li><a href="module-Controller_invoices.html">Controller/invoices</a><ul class='methods'><li data-type='method'><a href="module-Controller_invoices.html#~createInvoice">createInvoice</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoices">viewInvoices</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesById">viewInvoicesById</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesByUser">viewInvoicesByUser</a></li></ul></li><li><a href="module-Controller_keypad.html">Controller/keypad</a><ul class='methods'><li data-type='method'><a href="module-Controller_keypad.html#~createPasscode">createPasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~deletePasscode">deletePasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~listPasscodes">listPasscodes</a></li></ul></li><li><a href="module-Controller_lock_august_index.html">Controller/lock/august/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~lockStatus">lockStatus</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_lock_august_token.html">Controller/lock/august/token</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_token.html#~confirm">confirm</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~session">session</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~validate">validate</a></li></ul></li><li><a href="module-Controller_lock_index.html">Controller/lock/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_index.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getStatus">getStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~sendCommand">sendCommand</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~toggleLock">toggleLock</a></li></ul></li><li><a href="module-Controller_lock_switchbot.html">Controller/lock/switchbot</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_meeting.html">Controller/meeting</a><ul class='methods'><li data-type='method'><a href="module-Controller_meeting.html#~meetingStats">meetingStats</a></li><li data-type='method'><a href="module-Controller_meeting.html#~sendTempCommand">sendTempCommand</a></li></ul></li><li><a href="module-Controller_notification.html">Controller/notification</a><ul class='methods'><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationEmail">sendConfirmationEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationSMS">sendConfirmationSMS</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendEmail">sendEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendSms">sendSms</a></li></ul></li><li><a href="module-Controller_order.html">Controller/order</a><ul class='methods'><li data-type='method'><a href="module-Controller_order.html#~createAndNotify">createAndNotify</a></li><li data-type='method'><a href="module-Controller_order.html#~formatOrderDetails">formatOrderDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~formatUserDetails">formatUserDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~updateAndNotify">updateAndNotify</a></li></ul></li><li><a href="module-Controller_property.html">Controller/property</a><ul class='methods'><li data-type='method'><a href="module-Controller_property.html#~assignPropertyToUser">assignPropertyToUser</a></li><li data-type='method'><a href="module-Controller_property.html#~calcAvailability">calcAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~calcMonthAvailability">calcMonthAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~cloneProperty">cloneProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~getSinglePublicProperty">getSinglePublicProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~makeBook">makeBook</a></li><li data-type='method'><a href="module-Controller_property.html#~newProperty">newProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesPublic">propertiesPublic</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesUser">propertiesUser</a></li><li data-type='method'><a href="module-Controller_property.html#~property">property</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyAssignList">propertyAssignList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyList">propertyList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyListCustomSearch">propertyListCustomSearch</a></li><li data-type='method'><a href="module-Controller_property.html#~updateProperty">updateProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~updatePropertyKit">updatePropertyKit</a></li></ul></li><li><a href="module-Controller_shipment.html">Controller/shipment</a><ul class='methods'><li data-type='method'><a href="module-Controller_shipment.html#~formattedShipment">formattedShipment</a></li><li data-type='method'><a href="module-Controller_shipment.html#~sendShipmentNotification">sendShipmentNotification</a></li></ul></li><li><a href="module-Controller_transactions.html">Controller/transactions</a><ul class='methods'><li data-type='method'><a href="module-Controller_transactions.html#~createTransaction">createTransaction</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByHardware">viewTransactionByHardware</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionById">viewTransactionById</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByProperty">viewTransactionByProperty</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactions">viewTransactions</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">meeting.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Handles all meeting related operations.
 * @module Controller/meeting
 */
const Meeting = require("../models/meeting");
const Kit = require("../models/kit");
const Hardware = require("../models/hardware");

const dayjs = require('dayjs');
const ObjectId = require('mongoose').Types.ObjectId;

const switchbotController = require('../helpers/switchbot');
const augustController = require('./lock/august/index');

/**
 * Retrieves meeting statistics for a specific property.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 */
const meetingStats = async (req, res) => {
  try {
    const now = dayjs();
    const lastWeekDate = now.subtract(1, 'week');
    let start = Math.round(new Date().getTime() / 86400000) * 86400000;

    const startThisDay = now.startOf('day');
    const endThisDay = now.endOf('day');

    const startThisWeek = now.startOf('week');
    const endThisWeek = now.endOf('week');

    const startLastWeek = lastWeekDate.startOf('week');
    const endLastWeek = lastWeekDate.endOf('week');

    const firstMeeting = await Meeting.find({ property: req.params.propId }).sort({ startTime: 1 })
    const firstMeetingDate = (firstMeeting.length > 0 &amp;&amp; firstMeeting[0].startTime) ? firstMeeting[0].startTime : null

    const lastMeeting = await Meeting.find({ property: req.params.propId, }).sort({ startTime: -1 })
    const lastMeetingDate = (lastMeeting.length > 0 &amp;&amp; lastMeeting[0].startTime) ? lastMeeting[0].startTime : null

    const thisDayCurrent = await Meeting.find({
      property: req.params.propId,
      $and: [
        { startTime: { $gt: startThisDay.valueOf() } },
        { stopTime: { $lt: now.valueOf() } }
      ],
      status: { $ne: 'cancelled' }
    }).count();
    const thisDay = await Meeting.find({
      property: req.params.propId,
      $and: [
        { startTime: { $gt: startThisDay.valueOf() } },
        { stopTime: { $lt: endThisDay.valueOf() } }
      ],
      status: { $ne: 'cancelled' }
    }).count();

    const thisWeekCurrent = await Meeting.find({
      property: req.params.propId,
      $and: [
        { startTime: { $gt: startThisWeek.valueOf() } },
        { stopTime: { $lt: now.valueOf() } }
      ],
      status: { $ne: 'cancelled' }
    }).count();
    const thisWeek = await Meeting.find({
      property: req.params.propId,
      $and: [
        { startTime: { $gt: startThisWeek.valueOf() } },
        { stopTime: { $lt: endThisWeek.valueOf() } }
      ],
      status: { $ne: 'cancelled' }
    }).count();

    const lastWeek = await Meeting.find({
      property: req.params.propId,
      $and: [
        { startTime: { $gt: startLastWeek.valueOf() } },
        { stopTime: { $lt: endLastWeek.valueOf() } }
      ]
    }).count();

    const future = await Meeting.find({
      property: req.params.propId,
      $and: [
        { startTime: { $gt: start - 86400000 } },
      ],
      status: { $ne: 'cancelled' }
    }).count();

    const totalMeetings = await Meeting.find({ property: req.params.propId, status: { $ne: 'cancelled' } }).count();

    res.json({
      today: { soFar: thisDayCurrent, total: thisDay },
      thisWeek: { soFar: thisWeekCurrent, total: thisWeek },
      lastWeek: lastWeek,
      sinceStart: { date: firstMeetingDate, total: totalMeetings },
      future: { date: lastMeetingDate, total: future }
    });
  } catch (error) {
    console.log(error);
    res.send(error);
  }
}

/**
 * Sends a temporary command to a lock associated with a meeting.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 * @param {Function} next - The next middleware function.
 */
async function sendTempCommand(req, res, next) {
  const { id, kitId } = req.params

  const meeting = await Meeting.findById(id)

  const { startTime, stopTime } = meeting

  if (!meeting) return res.status(403).json({ error: 'Meeting not found' })

  const now = new Date().getTime()

  if (now &lt; startTime) return res.status(400).json({ error: 'The booking has not started' })
  if (now > stopTime) return res.status(400).json({ error: 'The booking has expired' })

  Hardware.findOne({
    kit: kitId,
    category: 'lock',
    status: 'active'
  }).populate('account').exec(function (err, hardware) {

    if (!hardware) {
      return res.status(403).end();
    }

    if (hardware.lock.vendor === 'august') {
      const authData = {
        token: hardware.account.token,
      }
      const command = req.params.action.toLowerCase();
      augustController.sendCommand(hardware.lock.id, command, authData)
        .then(response => {
          if ((response.status === 'kAugLockState_Unlocked' &amp;&amp; command === 'unlock') || (response.status === 'kAugLockState_Locked' &amp;&amp; command === 'lock')) {
            createTransaction({
              action: command,
              type: 'webpage',
              byModel: 'User',
              by: hardware.user,
              hardware: hardware._id,
              property: hardware.property
            })
          }
          res.send(command);
        }).catch((err) => {
          console.log(err);
        })
    } else if (hardware.lock.vendor === 'switchbot') {
      const authData = {
        token: hardware.account.token,
        secret: hardware.account.secret,
        t: Date.now(),
        nonce: uuidv4()
      }
      const command = req.params.action.toLowerCase();
      switchbotController.sendCommand(hardware.lock.id, command, 'default', authData)
        .then(response => {
          if (response.message === 'success') {
            createTransaction({
              action: command,
              type: 'webpage',
              byModel: 'User',
              by: hardware.user,
              hardware: hardware._id,
              property: hardware.property
            });
          }
          res.send(command);
        }).catch((err) => {
          console.log(err);
        })
    }
  });

  // let query = {
  //     _id: id,
  //     user: req.user._id,
  //     category: 'lock',
  //     status: 'active'
  // }
  // if (req.user.orgs) {
  //     query.user = req.user.orgs;
  // }
  // Hardware.findOne(query).populate('account').exec(function (err, hardware) {

  //     if (!hardware) {
  //         return res.status(403).end();
  //     }

  //     if (hardware.lock.vendor === 'august') {
  //         const authData = {
  //             token: hardware.account.token,
  //         }
  //         const command = req.params.action.toLowerCase();
  //         augustController.sendCommand(hardware.lock.id, command, authData)
  //             .then(response => {
  //                 if ((response.status === 'kAugLockState_Unlocked' &amp;&amp; command === 'unlock') || (response.status === 'kAugLockState_Locked' &amp;&amp; command === 'lock')) {
  //                     createTransaction({
  //                         action: command,
  //                         type: 'webpage',
  //                         byModel: 'User',
  //                         by: hardware.user,
  //                         hardware: hardware._id,
  //                         property: hardware.property
  //                     })
  //                 }
  //                 res.send(command);
  //             }).catch((err) => {
  //                 console.log(err);
  //             })
  //     } else if (hardware.lock.vendor === 'switchbot') {
  //         const authData = {
  //             token: hardware.account.token,
  //             secret: hardware.account.secret,
  //             t: Date.now(),
  //             nonce: uuidv4()
  //         }
  //         const command = req.params.action.toLowerCase();
  //         switchbotController.sendCommand(hardware.lock.id, command, 'default', authData)
  //             .then(response => {
  //                 if (response.message === 'success') {
  //                     createTransaction({
  //                         action: command,
  //                         type: 'webpage',
  //                         byModel: 'User',
  //                         by: hardware.user,
  //                         hardware: hardware._id,
  //                         property: hardware.property
  //                     });
  //                 }
  //                 res.send(command);
  //             }).catch((err) => {
  //                 console.log(err);
  //             })
  //     }
  // });
}

module.exports = {
  meetingStats: meetingStats,
  sendTempCommand
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 12:27:25 GMT-0700 (北美太平洋夏令时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
