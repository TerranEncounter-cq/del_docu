<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>schedule.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Controller_Schedule.html">Controller/Schedule</a><ul class='methods'><li data-type='method'><a href="module-Controller_Schedule.html#~calibrateTimezone">calibrateTimezone</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupCVWaitList">cleanupCVWaitList</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupDropin">cleanupDropin</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~downloadIDImages">downloadIDImages</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~followUp">followUp</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~generateInvoices">generateInvoices</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~scheduleNextRun">scheduleNextRun</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendNotifications">sendNotifications</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-Controller_authentication.html">Controller/authentication</a></li><li><a href="module-Controller_button.html">Controller/button</a><ul class='methods'><li data-type='method'><a href="module-Controller_button.html#~statusButoon">statusButoon</a></li></ul></li><li><a href="module-Controller_camera.html">Controller/camera</a><ul class='methods'><li data-type='method'><a href="module-Controller_camera.html#~countRecords">countRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~createCameraZone">createCameraZone</a></li><li data-type='method'><a href="module-Controller_camera.html#~createNewCamera">createNewCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~editCamera">editCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~enableCamera">enableCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~generateStreamURL">generateStreamURL</a></li><li data-type='method'><a href="module-Controller_camera.html#~getKinesesStreamingUrl">getKinesesStreamingUrl</a></li><li data-type='method'><a href="module-Controller_camera.html#~getNextMonitorId">getNextMonitorId</a></li><li data-type='method'><a href="module-Controller_camera.html#~getRecords">getRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~getToken">getToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~pad">pad</a></li><li data-type='method'><a href="module-Controller_camera.html#~refreshToken">refreshToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~reloadCameraStreams">reloadCameraStreams</a></li><li data-type='method'><a href="module-Controller_camera.html#~removeCamera">removeCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~triggerCameraStreams">triggerCameraStreams</a></li></ul></li><li><a href="module-Controller_contact.html">Controller/contact</a><ul class='methods'><li data-type='method'><a href="module-Controller_contact.html#~convertJsonToCsv">convertJsonToCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~getById">getById</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContact">getContact</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContactSub">getContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~getUpdate">getUpdate</a></li><li data-type='method'><a href="module-Controller_contact.html#~toCsv">toCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~updateContactSub">updateContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~validateIdLoad">validateIdLoad</a></li></ul></li><li><a href="module-Controller_dashboard.html">Controller/dashboard</a><ul class='methods'><li data-type='method'><a href="module-Controller_dashboard.html#~getDashboardStats">getDashboardStats</a></li></ul></li><li><a href="module-Controller_invoices.html">Controller/invoices</a><ul class='methods'><li data-type='method'><a href="module-Controller_invoices.html#~createInvoice">createInvoice</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoices">viewInvoices</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesById">viewInvoicesById</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesByUser">viewInvoicesByUser</a></li></ul></li><li><a href="module-Controller_keypad.html">Controller/keypad</a><ul class='methods'><li data-type='method'><a href="module-Controller_keypad.html#~createPasscode">createPasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~deletePasscode">deletePasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~listPasscodes">listPasscodes</a></li></ul></li><li><a href="module-Controller_lock_august_index.html">Controller/lock/august/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~lockStatus">lockStatus</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_lock_august_token.html">Controller/lock/august/token</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_token.html#~confirm">confirm</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~session">session</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~validate">validate</a></li></ul></li><li><a href="module-Controller_lock_index.html">Controller/lock/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_index.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getStatus">getStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~sendCommand">sendCommand</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~toggleLock">toggleLock</a></li></ul></li><li><a href="module-Controller_lock_switchbot.html">Controller/lock/switchbot</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_meeting.html">Controller/meeting</a><ul class='methods'><li data-type='method'><a href="module-Controller_meeting.html#~meetingStats">meetingStats</a></li><li data-type='method'><a href="module-Controller_meeting.html#~sendTempCommand">sendTempCommand</a></li></ul></li><li><a href="module-Controller_notification.html">Controller/notification</a><ul class='methods'><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationEmail">sendConfirmationEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationSMS">sendConfirmationSMS</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendEmail">sendEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendSms">sendSms</a></li></ul></li><li><a href="module-Controller_order.html">Controller/order</a><ul class='methods'><li data-type='method'><a href="module-Controller_order.html#~createAndNotify">createAndNotify</a></li><li data-type='method'><a href="module-Controller_order.html#~formatOrderDetails">formatOrderDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~formatUserDetails">formatUserDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~updateAndNotify">updateAndNotify</a></li></ul></li><li><a href="module-Controller_property.html">Controller/property</a><ul class='methods'><li data-type='method'><a href="module-Controller_property.html#~assignPropertyToUser">assignPropertyToUser</a></li><li data-type='method'><a href="module-Controller_property.html#~calcAvailability">calcAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~calcMonthAvailability">calcMonthAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~cloneProperty">cloneProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~getSinglePublicProperty">getSinglePublicProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~makeBook">makeBook</a></li><li data-type='method'><a href="module-Controller_property.html#~newProperty">newProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesPublic">propertiesPublic</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesUser">propertiesUser</a></li><li data-type='method'><a href="module-Controller_property.html#~property">property</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyAssignList">propertyAssignList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyList">propertyList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyListCustomSearch">propertyListCustomSearch</a></li><li data-type='method'><a href="module-Controller_property.html#~updateProperty">updateProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~updatePropertyKit">updatePropertyKit</a></li></ul></li><li><a href="module-Controller_shipment.html">Controller/shipment</a><ul class='methods'><li data-type='method'><a href="module-Controller_shipment.html#~formattedShipment">formattedShipment</a></li><li data-type='method'><a href="module-Controller_shipment.html#~sendShipmentNotification">sendShipmentNotification</a></li></ul></li><li><a href="module-Controller_transactions.html">Controller/transactions</a><ul class='methods'><li data-type='method'><a href="module-Controller_transactions.html#~createTransaction">createTransaction</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByHardware">viewTransactionByHardware</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionById">viewTransactionById</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByProperty">viewTransactionByProperty</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactions">viewTransactions</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">schedule.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Handles the scheduling of notifications, reminders, and other actions.
 * @module Controller/Schedule
 */
const fs = require('fs');
const maxBy = require("lodash/maxBy");
const dayjs = require('dayjs')
const { v4: uuidv4 } = require('uuid');
const Meeting = require('../models/meeting');
const Contact = require('../models/contact');
const Hardware = require('../models/hardware');
const Property = require('../models/property');
const Users = require('../models/user');
const notification = require('../controllers/notification');
const { createInvoice, viewInvoicesByUser } = require('./invoices')
const async = require('async');
const { relativeTimeConversion, downloadImage } = require('../helpers/utils')
const switchbotController = require('../helpers/switchbot');
const eventEmitter = require('../events/emitter');
const { generateReminderEmail } = require('../helpers/emailGeneration');
const { sendInstructions, sendReminder } = require('../helpers/notifications');

/**
 * Sends notifications for meetings based on their status and scheduled times.
 * This function checks for meetings that need reminders, instructions, or follow-ups sent.
 * It handles sending reminders and instructions to users and contacts.
 */
async function sendNotifications() {
  console.log("STARTING NOTIFICATIONS");
  try {
    // Find all meetings that need notifications sent
    const now = new Date().getTime();
    const meetings = await Meeting.find({
      status: 'active',
      '$or': [
        { 'reminder.sendAt': { $lte: now, $ne: null }, 'reminder.sent': { $ne: true } },
        { 'instructions.sendAt': { $lte: now, $ne: null }, 'instructions.sent': { $ne: true } },
        { 'followUp.sendAt': { $lte: now, $ne: null }, 'followUp.sent': { $ne: true } }
      ]
    }).populate('property', 'address unit timeInstructions propertyManager leasingAgent')
      .populate('contact', 'email subscription firstName lastName')
      .populate('user', 'email company settings')
      .exec();

    console.log(`${meetings.length} meetings found`)

    async.eachLimit(meetings, 10, async (meeting, cb) => {
      try {
        if (meeting.reminder.sendAt &lt;= now &amp;&amp; !meeting.reminder.sent) {
          await sendReminder(meeting);
        }
        if (meeting.instructions.sendAt &lt;= now &amp;&amp; !meeting.instructions.sent) {
          console.log("SENDING INSTRUCTIONS UP")
          await sendInstructions(meeting);
        }
        if (meeting.followUp.sendAt &lt;= now &amp;&amp; !meeting.followUp.sent) {
          console.log("SENDING FOLLOW UP")
          // await sendFollowUp(meeting);
        }
      } catch (err) {
        console.error(err);
      }
    }, (err) => {
      if (err) {
        console.error("Error processing notifications: ", err);
      } else {
        console.log("Finished processing notifications");
      }
    });
  } catch (err) {
    console.error("Error fetching meetings: ", err);
  }

  scheduleNextRun();
}


function startReminders() {

  // setInterval(function () {
  //   console.log("STARTING REMINDERS")
  //   let randomeDelay = Math.random() * 10 + 1;
  //   setTimeout(function () {
  //     Users.find({}, { 'email': 1, 'settings.notifications.followUp': 1, 'company': 1 }, (errUsers, users) => {
  //       if (errUsers) {
  //         console.log(errUsers);
  //       } else {
  //         users.forEach((user) => {
  //           Meeting.find({
  //             '$or': [
  //               { user: user._id, },
  //               { allowedAgents: user._id }
  //             ],
  //             '$and': [
  //               { startTime: { $gt: new Date().getTime() } },
  //               { startTime: { $lt: new Date().getTime() + (user.settings.notifications.reminder.time) } }
  //             ],
  //             'reminder.sent': {
  //               $ne: true
  //             },
  //             'status': 'active'
  //           })
  //             .limit(100)
  //             .populate('property', 'address unit timeInstructions propertyManager leasingAgent')
  //             .populate('contact', 'email subscription')
  //             .exec(function (err, meetings) {
  //               // console.log(`user(${user.email}) meeting reminders : ${meetings.length}`);
  //               async.eachLimit(meetings, 10, function (meeting, cb) {
  //                 if (!meeting.property || !meeting.contact) {
  //                   return cb();
  //                 }

  //                 let calibration = new Date();
  //                 let serverOffset = calibration.getTimezoneOffset() * 60 * 1000;
  //                 let offset = user.settings.meetings.timezone * 60 * 60 * 1000;


  //                 let pointer = new Date(offset + meeting.startTime + serverOffset);

  //                 // should make a generic template for this
  //                 let agentName = `${user.firstName} ${user.lastName}`;
  //                 let address = `${meeting.property.address.toString()}`;
  //                 let unit = meeting.property.unit;
  //                 let date = `${pointer.toDateString()}`;
  //                 let time = `${pointer.toLocaleTimeString()} (GMT ${user.settings.meetings.timezone})`;
  //                 let phone = user.settings.customerSupportPhone &amp;&amp; user.settings.customerSupportPhone.length ? `at ${user.settings.customerSupportPhone}` : '';

  //                 if (meeting.localDateTime &amp;&amp; meeting.localDateTime.length) {
  //                   time = meeting.localDateTime;
  //                   date = '';
  //                 }

  //                 let body = `
  //                                       ${address} is scheduled for ${date} at ${time}.&lt;br>&lt;br>

  //                                       We will send you instructions ${relativeTimeConversion(meeting.property.timeInstructions)} before your appointment.&lt;br>&lt;br>


  //                                       ${user.settings.notifications.reminder.status ?
  //                     user.settings.notifications.reminder.text.replace(/(?:\r\n|\r|\n)/g, '&lt;br>') + '&lt;br>&lt;br>' : ''
  //                   }

  //                                       If you wish to cancel or reschedule, please use this link:&lt;br>
  //                                       Reschedule link: https://app.delet.ai/book/${property._id}/meeting/${meeting._id}&lt;br>
  //                                       Cancel link: https://app.delet.ai/book/cancel/${meeting._id}

  //                                       &lt;br>&lt;br>

  //                                       Unsubscribe or change your notification preferences.&lt;br>
  //                                       https://api.delet.ai/subscription?contact=${meeting.contact._id}
  //                                       `;

  //                 const emailBody = generateReminderEmail(meeting.user, meeting, meeting.property)

  //                 const companyName = (user.company.name !== undefined &amp;&amp; user.company.name !== '') ? user.company.name : 'Delet';

  //                 if (meeting.contact.subscription) {
  //                   console.log("SENDING REMINDER EMAIL")
  //                   notification.sendEmail({
  //                     emailAlias: companyName,
  //                     'to': meeting.contact.email,
  //                     'subject': `[Reminder] ${companyName} meeting starting within ${relativeTimeConversion(user.settings.notifications.reminder.time)}`,
  //                     'body': emailBody
  //                   }).catch((error) => {
  //                     console.log(error);
  //                   });
  //                 }

  //                 Meeting.findOneAndUpdate({ _id: meeting._id }, {
  //                   $set: {
  //                     'reminder.sent': true,
  //                     'reminder.ts': new Date().getTime()
  //                   }
  //                 }).exec(function (err, meeting) {
  //                   console.log('Meeting reminder sent for: ', meeting._id)
  //                   cb();
  //                 })
  //               }, function (err, done) {
  //               })
  //             })
  //         })
  //       }
  //     })
  //   }, 1000 * randomeDelay)
  // }, 1000 * 60)
}

function sendLockLinks() {
  // setInterval(function () {
  //   let now = new Date().getTime();

  //   Property.find(
  //     { status: 'active' },
  //     {
  //       address: 1,
  //       unit: 1,
  //       user: 1,
  //       propertyAccessCodes: 1,
  //       doorUnlockLink: 1,
  //       rentalApplicationForm: 1,
  //       timeInstructions: 1
  //     },
  //     (errProperty, properties) => {
  //       if (errProperty) {
  //         console.log(errProperty);
  //       } else {
  //         properties.forEach((property) => {
  //           Meeting.find({
  //             property: property._id,
  //             lockKey: { $exists: false },
  //             status: "active",
  //             $and: [
  //               { stopTime: { $gt: now } },
  //               { startTime: { $lt: (now + property.timeInstructions) } }
  //             ]
  //           }, (errMeetings, meetings) => {
  //             if (errMeetings) {
  //               console.log(errMeetings);
  //             } else {
  //               async.eachLimit(meetings, 1, function (meeting, cb) {
  //                 console.log('Instructions sent for meeting: ' + meeting._id)
  //                 if (!property.user) {
  //                   return cb();
  //                 }

  //                 // generate random code if has keypad
  //                 let randomKeypadCode = 0;

  //                 Hardware.findOne({
  //                   property: property._id,
  //                   user: property.user,
  //                   category: 'keypad',
  //                   status: 'active'
  //                 }).populate('account').exec(function (errKeypad, keypad) {
  //                   if (errKeypad) {
  //                     console.log(errKeypad);
  //                   } else if (keypad) {
  //                     randomKeypadCode = parseInt(Math.random() * 10 ** 6)
  //                     const authData = {
  //                       token: keypad.account.token,
  //                       secret: keypad.account.secret,
  //                       t: Date.now(),
  //                       nonce: uuidv4()
  //                     }
  //                     const parameter = {
  //                       name: `Guest (${meeting._id})`,
  //                       type: "timeLimit",
  //                       password: `${randomKeypadCode}`,
  //                       startTime: meeting.startTime,
  //                       endTime: meeting.stopTime
  //                     }
  //                     switchbotController.sendCommand(
  //                       keypad.keypad.id,
  //                       'createKey',
  //                       parameter,
  //                       authData
  //                     )
  //                   }

  //                   let lockKey = Math.round(Math.random() * 10000000);
  //                   Meeting.findOneAndUpdate(
  //                     { _id: meeting._id },
  //                     { $set: { lockKey: lockKey } },
  //                     { upsert: false, new: true })
  //                     .populate('user', 'email company')
  //                     .populate('contact')
  //                     .populate('property')
  //                     .exec(function (err, meet) {
  //                       if (err) {
  //                         console.log(err);
  //                       } else {
  //                         var link = `https://app.delet.ai/meeting/unlock/${meet._id}/${meet.lockKey}`;
  //                         let address = `${property.address.toString()}`;
  //                         let unit = property.unit;
  //                         let time = '';
  //                         if (meet.localDateTime &amp;&amp; meet.localDateTime.length) {
  //                           time = meet.localDateTime;
  //                           date = '';
  //                         }
  //                         let hardwareInstruction = ``;
  //                         let keypadInstruction = '';

  //                         if (property.doorUnlockLink) {
  //                           hardwareInstruction = `Link to Unlock/Lock the door when you arrive: ${link}`
  //                         }
  //                         if (randomKeypadCode !== 0) {
  //                           keypadInstruction = `Keypad code: ${randomKeypadCode}`
  //                         }

  //                         let smsMsgAppURL = '';
  //                         let emailMsgAppURL = '';
  //                         const appURLStatus = (property.rentalApplicationForm.enable !== undefined &amp;&amp; property.rentalApplicationForm.enable);
  //                         const appURL = (property.rentalApplicationForm.url !== undefined &amp;&amp; property.rentalApplicationForm.url !== '') ? property.rentalApplicationForm.url : '';

  //                         const appInstructions = (property.rentalApplicationForm.intructions !== undefined &amp;&amp; property.rentalApplicationForm.intructions !== '') ? property.rentalApplicationForm.intructions : '';
  //                         const appInstructionsStatus = property.rentalApplicationForm.enable;

  //                         if (appURLStatus) {
  //                           smsMsgAppURL = `
  //                                                       If you would like to apply please follow the link below.\n\n${appURL}\n\n
  //                                                       ${appInstructionsStatus ? appInstructions + '\n\n' : ''}
  //                                                       `;
  //                           emailMsgAppURL = `
  //                                                       If you would like to apply please follow the link below.&lt;br>&lt;br>${appURL}&lt;br>&lt;br>
  //                                                       ${appInstructionsStatus ? appInstructions + '&lt;br>&lt;br>' : ''}
  //                                                       `;
  //                         }

  //                         let body = generateReminderEmail(meet.contact, meet, meet.property)

  //                         let smsBody = `(Do not reply)\n\nHi,\nBelow are the instructions to view\n\n${property.propertyAccessCodes.intructions}\n\n${hardwareInstruction !== '' ? hardwareInstruction + '\n\n' : ''}${keypadInstruction !== '' ? keypadInstruction + '\n\n' : ''}${smsMsgAppURL}Please reach out if you have any questions.\n\nThank you!\n\nUnsubscribe or change your notification preferences.\nhttps://app.delet.ai/subscription?contact=${meet.contact._id}`
  //                         const companyName = (meet.user.company.name !== undefined &amp;&amp; meet.user.company.name !== '') ? meet.user.company.name : 'Delet';

  //                         if (meet.contact.subscription) {
  //                           console.log("SENDING INSTRUCTIONS EMAIL")

  //                           notification.sendEmail({
  //                             emailAlias: companyName,
  //                             'to': meet.contact.email,
  //                             'subject': '[Instructions] Tour instructions',
  //                             'body': body
  //                           }).catch((error) => {
  //                             console.log(error);
  //                           });

  //                           notification.sendSms({
  //                             phone: meet.contact.phone,
  //                             body: smsBody
  //                           }).catch(error => console.log(error))
  //                         }

  //                         cb()
  //                       }
  //                     })
  //                 })
  //               }, function (err) {
  //                 console.log('Finished sending open instructions');
  //               });
  //             }
  //           });
  //         });

  //       }
  //     });

  // }, 1000 * 60) // every minute
}

/**
 * Periodically cleans up drop-in properties based on last ping time.
 * Removes drop-in pings older than 2 minutes and performs additional actions.
 */
function cleanupDropin() {
  setInterval(function () {
    Property.find({
      dropinPing: { $ne: null },
      dropinPing: { $lt: new Date().getTime() - 1000 * 120 }
    }).limit(100).exec(function (err, properties) {
      if (properties &amp;&amp; properties.length) {
        console.log('Going to cleanup droping: ' + properties.length)
        async.eachLimit(properties, 1, function (property, cb) {
          Hardware.findOne({
            property: property._id,
            category: 'tablet',
            status: 'active',
            'sync.token': { $exists: true }
          }).exec(function (err, hardware) {
            if (hardware &amp;&amp; hardware.sync.mode !== 'poll') {
              sendPN('Meeting Ended', 'Meeting Finished', "https://eavlycrm.nodeside.com/admin.html#!/tablet/config", hardware.sync.token)
            }
            Property.findOneAndUpdate(
              { _id: property._id },
              { $set: { dropinPing: null } },
              { upsert: false, multi: false }).exec(function (err) {
                cb();
              })
          })
        }, function () {
          console.log('Property dropin cleanup')
        })
      }
    })
  }, 30000)
}

/**
 * Periodically downloads ID images for contacts with valid image URLs.
 * Downloads up to 5 images at a time and updates the database with the downloaded image paths.
 */
function downloadIDImages() {
  setInterval(() => {
    Contact.find({ "idImage": { $regex: 'https://' } }, {
      idImage: 1,
      user: 1
    }).limit(5).exec(function (err, contacts) {
      if (contacts &amp;&amp; contacts.length) {
        async.eachLimit(contacts, 2, async function (contact, cb) {
          contact
          await downloadImage(contact.idImage, `./images/contact/${contact.user}-${contact._id}-id.jpg`).then(() => {
            Contact.findOneAndUpdate({ _id: contact._id }, { $set: { idImage: `/public/images/contact/${contact.user}-${contact._id}-id.jpg` } }).exec(function (err) {
              console.log('Contact Image Updated')
            })
          })
        })
      }
    })
  }, 6000)
}

function cleanupImages() {
  setInterval(function () {
    // Property.find({ "primaryImage": { $regex: /^data:image/i } }, { primaryImage: 1 }).limit(5).exec(function (err, properties) {
    //     if (properties &amp;&amp; properties.length) {
    //         console.log('Going to update: ' + properties.length);
    //         async.eachLimit(properties, 1, function (property, cb) {
    //             fs.writeFileSync(`./images/property/${property._id}-primary.jpg`, Buffer.from(property.primaryImage.replace(/^data:image\/[a-z]+;base64,/, ""), "base64"));
    //             Property.findOneAndUpdate({ _id: property._id }, { $set: { primaryImage: `/public/images/property/${property._id}-primary.jpg` } }).exec(function (err) {
    //                 cb()
    //             })
    //         }, function () {
    //             console.log('Property Image Updated')
    //         });
    //     }
    // });

    // Contact.find({ "idImage": { $regex: /^data:image/i } }, {
    //     idImage: 1,
    //     user: 1
    // }).limit(5).exec(function (err, contacts) {
    //     if (contacts &amp;&amp; contacts.length) {
    //         console.log('Going to update: ' + contacts.length)
    //         async.eachLimit(contacts, 2, function (contact, cb) {
    //             fs.writeFileSync(`./images/contact/${contact.user}-${contact._id}-id.jpg`, Buffer.from(contact.idImage.replace(/^data:image\/[a-z]+;base64,/, ""), "base64"));
    //             Contact.findOneAndUpdate({ _id: contact._id }, { $set: { idImage: `/public/images/contact/${contact.user}-${contact._id}-id.jpg` } }).exec(function (err) {
    //                 cb()
    //             })
    //         }, function () {
    //             console.log('Contact Image Updated')
    //         });
    //     }
    // });
  }, 1000 * 60)
}

/**
 * Cleans up the CV waitlist by emitting an event at regular intervals.
 */
function cleanupCVWaitList() {
  setInterval(() => {
    eventEmitter.emit('cleanupCVWaitList')
  }, 5 * 60 * 1000)
}

/**
 * Initiates follow-up actions based on user settings and meeting statuses.
 */
function followUp() {
  setInterval(() => {
    Users.find({}, { 'email': 1, 'settings.notifications.followUp': 1, 'company': 1 }, (errUsers, users) => {
      if (errUsers) {
        console.log(errUsers);
      } else {
        users.forEach((user) => {
          if (user.settings.notifications.followUp.status) {
            Meeting.find({
              '$or': [
                { user: user._id, },
                { allowedAgents: user._id }
              ],
              stopTime: {
                $lt: new Date().getTime() - (user.settings.notifications.followUp.time)
              },
              'followUp.sent': {
                $ne: true
              }
            }, (errMeetings, meetings) => {
              if (errMeetings) {
                console.log(errMeetings);
              } else {
                async.eachLimit(meetings, 10, (meeting, cb) => {
                  if (meeting.property &amp;&amp; meeting.contact) {
                    return cb();
                  }

                  let calibration = new Date();
                  let serverOffset = calibration.getTimezoneOffset() * 60 * 1000;
                  let offset = user.settings.meetings.timezone * 60 * 60 * 1000;

                  let pointer = new Date(offset + meeting.startTime + serverOffset);

                  // should make a generic template for this
                  let agentName = `${user.firstName} ${user.lastName}`;
                  let address = `${meeting.property.address.toString()}`;
                  let unit = meeting.property.unit;
                  let date = `${pointer.toDateString()}`;
                  let time = `${pointer.toLocaleTimeString()} (GMT ${user.settings.meetings.timezone})`;
                  let phone = user.settings.customerSupportPhone &amp;&amp; user.settings.customerSupportPhone.length ? `at ${user.settings.customerSupportPhone}` : ''
                  if (meeting.localDateTime &amp;&amp; meeting.localDateTime.length) {
                    time = meeting.localDateTime;
                    date = '';
                  }

                  let body = `
                                    How was your visit at ${address} on ${date} at ${time}?.&lt;br>&lt;br>

                                    ${(user.settings.notifications.followUp.status &amp;&amp; user.settings.notifications.followUp.text !== '') ?
                      user.settings.notifications.followUp.text + '&lt;br>&lt;br>' : ''
                    }

                                    ${(meeting.property.rentalApplicationForm.url !== undefined &amp;&amp; meeting.property.rentalApplicationForm.url !== '')
                      ?
                      `If you are interested in this unit, please use the link below to fill out an application:&lt;br>${meeting.property.rentalApplicationForm.url}&lt;br>&lt;br>`
                      : ''
                    }
                                    To explore more properties, please visit:&lt;br>
                                    https://app.delet.ai/#!/book/list/${user._id}&lt;br>&lt;br>
                                    If you have any questions, please do not hesitate to reply to this email.&lt;br>&lt;br>
                                    We look forward to hearing from you!

                                    &lt;br>&lt;br>

                                    Unsubscribe or change your notification preferences.&lt;br>
                                    https://app.delet.ai/subscription?contact=${meeting.contact._id}
                                    `;

                  const companyName = (user.company.name !== undefined &amp;&amp; user.company.name !== '') ? user.company.name : 'Delet';

                  if (meeting.contact.subscription) {
                    notification.sendEmail({
                      emailAlias: companyName,
                      to: meeting.contact.email,
                      replyTo: user.email,
                      subject: `How was your visit at ${address} on ${date} at ${time}?`,
                      body: body
                    }).catch((error) => {
                      console.log(error);
                    });

                    notification.sendEmail({
                      'emailAlias': companyName,
                      'to': user.email,
                      'subject': `How was your visit at ${address} on ${date} at ${time}?`,
                      'body': body
                    }).catch((error) => {
                      console.log(error);
                    });
                  }

                  Meeting.findOneAndUpdate({ _id: meeting._id }, {
                    $set: {
                      'followUp.sent': true,
                      'followUp.ts': new Date().getTime()
                    }
                  }).exec();
                })
              }
            }).limit(100).populate('property', 'address unit').populate('contact', 'email subscription')
          }
        })
      }
    })
  }, 1000 * 60)
}

/**
 * Sends push notifications with the specified title, body, URL, and token.
 * 
 * @param {string} title - Title of the notification.
 * @param {string} body - Body of the notification.
 * @param {string} url - URL associated with the notification.
 * @param {string} token - Token for sending the notification.
 */
// DUPLICATE from hardware - move to utils
function sendPN(title, body, url, token) {
  let http = require("https");

  let cleanedToken = token.split('?token=').pop();
  let options = {
    "method": "POST",
    "hostname": "fcm.googleapis.com",
    "port": null,
    "path": "/fcm/send",
    "headers": {
      "content-type": "application/json",
      "authorization": "key=AAAAZBTpHuc:APA91bGxYLxEZiScQFR9bq95HzSLLwXGU4i7JZVdkL25rRkWp0OO2kIGR-fLaOfOqzhuwNQFxr-q4F5ljQnDnvRNzWAzLg93ecnPkKuWPmZPPZ0NMzq0XnzQ74itd7iSTFwu-nwaAZjj",
      "cache-control": "no-cache"
    }
  };

  let req = http.request(options, function (res) {
    let chunks = [];

    res.on("data", function (chunk) {
      chunks.push(chunk);
    });

    res.on("end", function () {
      let body = Buffer.concat(chunks);
      console.log(body.toString());
    });
  });

  req.write(JSON.stringify({
    to: cleanedToken,
    notification: { title: title, body: body },
    click_action: 'OPEN_ACTIVITY_1',
    data: { url: url }
  }));
  req.end();
}

/**
 * Generates invoices for active kits and sends notification emails.
 */
function generateInvoices() {
  setInterval(() => {
    // find kits actives
    Users.find({
      'kits.dateStart': { $ne: 0 },
      'kits.dateEnd': 0
    }, (usersErr, users) => {
      if (usersErr) {
        console.log(usersErr);
      } else {
        users.forEach(user => {
          const activesKits = user.kits.filter(kit => kit.dateEnd === 0);
          activesKits.forEach(activeKit => {
            // check user kits
            if (activeKit.kit !== null) { // if no math kit
              if (activeKit.kit.service === 'Kit') {
                viewInvoicesByUser(user._id)
                  .then((invoices) => {
                    const currentDate = dayjs();
                    if (invoices.length > 0) {
                      const lastInvoice = maxBy(invoices);
                      const lastInvoiceDate = dayjs(lastInvoice.createdDate); // aca error
                      if (currentDate.diff(lastInvoiceDate, 'month') >= 1) {
                        createInvoice({
                          for: 'month',
                          kit: activeKit.kit._id,
                          user: user._id
                        });
                        const emailSubject = `New Invoice for ${user.company.name} and ${user.email}`;
                        const emailBody = `${user.email} (${user.firstName} ${user.lastName}) has a new invoice for period ${lastInvoiceDate.format('MM/DD/YYYY')} - ${currentDate.format('MM/DD/YYYY')}, with the "${activeKit.kit.name}" kit and "${activeKit.kit.service}" kit service .`;
                        notification.sendEmail({
                          to: process.env.invoice_email,
                          subject: emailSubject,
                          body: emailBody
                        }).catch((error) => {
                          console.log(error);
                        });
                      }
                    } else {
                      const asignedKitDate = dayjs(activeKit.dateStart);
                      if (currentDate.diff(asignedKitDate, 'month') >= 1) {
                        createInvoice({
                          for: 'month',
                          kit: activeKit.kit._id,
                          user: user._id
                        });
                        const emailSubject = `New Invoice for ${user.company.name} and ${user.email}`;
                        const emailBody = `${user.email} (${user.firstName} ${user.lastName}) has a new invoice for period ${asignedKitDate.format('MM/DD/YYYY')} - ${currentDate.format('MM/DD/YYYY')}, with the "${activeKit.kit.name}" kit and "${activeKit.kit.service}" kit service .`;
                        notification.sendEmail({
                          to: process.env.invoice_email,
                          subject: emailSubject,
                          body: emailBody
                        }).catch((error) => {
                          console.log(error);
                        });
                      }
                    }
                  });
              } else if (activeKit.kit.service === 'Kit plus installation' &amp;&amp; activeKit.kit.property &amp;&amp; activeKit.kit.property.status !== 'rented') {
                viewInvoicesByUser(user._id)
                  .then((invoices) => {
                    const currentDate = dayjs();
                    if (invoices.length > 0) {
                      const lastInvoice = maxBy(invoices);
                      const lastInvoiceDate = dayjs(lastInvoice.createdDate);
                      if (currentDate.diff(lastInvoiceDate, 'month') >= 1) {
                        createInvoice({
                          for: 'month',
                          property: activeKit.kit.property._id,
                          kit: activeKit.kit._id,
                          user: user._id
                        });
                        const emailSubject = `New Invoice for ${user.company.name} and ${user.email}`;
                        const emailBody = `${user.email} (${user.firstName} ${user.lastName}) of the company ${user.company.name} has a new invoice for period ${lastInvoiceDate.format('MM/DD/YYYY')} - ${currentDate.format('MM/DD/YYYY')} property ${activeKit.kit.property.address}, with the "${activeKit.kit.name}" kit and "${activeKit.kit.service}" kit service .`;
                        notification.sendEmail({
                          to: process.env.invoice_email,
                          subject: emailSubject,
                          body: emailBody
                        }).catch((error) => {
                          console.log(error);
                        });
                      }
                    } else {
                      const asignedKitDate = dayjs(activeKit.dateStart);
                      if (currentDate.diff(asignedKitDate, 'month') >= 1) {
                        createInvoice({
                          for: 'month',
                          kit: activeKit.kit._id,
                          user: user._id
                        });
                        const emailSubject = `New Invoice for ${user.company.name} and ${user.email}`;
                        const emailBody = `${user.email} (${user.firstName} ${user.lastName}) has a new invoice for period ${asignedKitDate.format('MM/DD/YYYY')} - ${currentDate.format('MM/DD/YYYY')}, with the "${activeKit.kit.name}" kit and "${activeKit.kit.service}" kit service .`;
                        notification.sendEmail({
                          to: process.env.invoice_email,
                          subject: emailSubject,
                          body: emailBody
                        }).catch((error) => {
                          console.log(error);
                        });
                      }
                    }
                  });
              }
            }
          });
        });

      }
    }).populate({
      path: 'kits.kit',
      populate: 'property'
    })
  }, 1000 * 60);
}

/**
 * Calibrates timezones for meetings based on user settings.
 */
function calibrateTimezone() {
  setInterval(() => {
    console.log('Calibrating timezones...');
    Users.find({}, { 'settings.meetings.timezone': 1, 'settings.meetings.timezoneLocation': 1 }, (usersErr, users) => {
      if (usersErr) {
        console.log(usersErr);
      } else {
        try {
          users.forEach((user) => {
            const dateUTC = new Date(new Date().toLocaleString('en-US', { timeZone: 'UTC' })).getTime();
            const dateReff = new Date(new Date().toLocaleString('en-US', { timeZone: user.settings.meetings.timezoneLocation })).getTime();
            const diff = Math.round((dateReff - dateUTC) / 60 / 60 / 1000);
            Users.findOneAndUpdate(
              { _id: user._id }, {
              $set: {
                'settings.meetings.timezone': diff,
              }
            }).exec()
          })
        } catch (error) {
          console.log(error);
        }

      }
    });
  }, 1000 * 60 * 60); // every hour
}

/**
 * Schedules the next run of notifications based on the current time.
 */
function scheduleNextRun() {
  const now = new Date();
  const minutes = now.getMinutes();
  const seconds = now.getSeconds();
  const milliseconds = now.getMilliseconds();

  const nextQuarterHour = Math.ceil((minutes + 1) / 15) * 15;
  const timeToNextQuarterHour = ((nextQuarterHour - minutes) * 60 * 1000) - (seconds * 1000) - milliseconds;

  console.log("NOTIFICATIONS WLL BE SENT IN: " + timeToNextQuarterHour/60000 + " minutes")

  setTimeout(sendNotifications, timeToNextQuarterHour);
}

module.exports = {
  cleanupCVWaitList: cleanupCVWaitList,
  startReminders: startReminders,
  sendLockLinks: sendLockLinks,
  followUp: followUp,
  downloadIDImages: downloadIDImages,
  cleanupImages: cleanupImages,
  cleanupDropin: cleanupDropin,
  generateInvoices: generateInvoices,
  calibrateTimezone: calibrateTimezone,
  sendNotifications,
  scheduleNextRun
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 12:27:25 GMT-0700 (北美太平洋夏令时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
