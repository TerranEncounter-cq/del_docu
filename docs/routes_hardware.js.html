<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>routes/hardware.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BadRequest.html">BadRequest</a></li><li><a href="Forbidden.html">Forbidden</a></li><li><a href="NotFound.html">NotFound</a></li><li><a href="Unauthorized.html">Unauthorized</a></li></ul><h3>Modules</h3><ul><li><a href="module-Controller_Schedule.html">Controller/Schedule</a><ul class='methods'><li data-type='method'><a href="module-Controller_Schedule.html#~calibrateTimezone">calibrateTimezone</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupCVWaitList">cleanupCVWaitList</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupDropin">cleanupDropin</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~downloadIDImages">downloadIDImages</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~followUp">followUp</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~generateInvoices">generateInvoices</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~scheduleNextRun">scheduleNextRun</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendNotifications">sendNotifications</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-Controller_authentication.html">Controller/authentication</a></li><li><a href="module-Controller_button.html">Controller/button</a><ul class='methods'><li data-type='method'><a href="module-Controller_button.html#~statusButoon">statusButoon</a></li></ul></li><li><a href="module-Controller_camera.html">Controller/camera</a><ul class='methods'><li data-type='method'><a href="module-Controller_camera.html#~countRecords">countRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~createCameraZone">createCameraZone</a></li><li data-type='method'><a href="module-Controller_camera.html#~createNewCamera">createNewCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~editCamera">editCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~enableCamera">enableCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~generateStreamURL">generateStreamURL</a></li><li data-type='method'><a href="module-Controller_camera.html#~getKinesesStreamingUrl">getKinesesStreamingUrl</a></li><li data-type='method'><a href="module-Controller_camera.html#~getNextMonitorId">getNextMonitorId</a></li><li data-type='method'><a href="module-Controller_camera.html#~getRecords">getRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~getToken">getToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~pad">pad</a></li><li data-type='method'><a href="module-Controller_camera.html#~refreshToken">refreshToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~reloadCameraStreams">reloadCameraStreams</a></li><li data-type='method'><a href="module-Controller_camera.html#~removeCamera">removeCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~triggerCameraStreams">triggerCameraStreams</a></li></ul></li><li><a href="module-Controller_contact.html">Controller/contact</a><ul class='methods'><li data-type='method'><a href="module-Controller_contact.html#~convertJsonToCsv">convertJsonToCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~getById">getById</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContact">getContact</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContactSub">getContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~getUpdate">getUpdate</a></li><li data-type='method'><a href="module-Controller_contact.html#~toCsv">toCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~updateContactSub">updateContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~validateIdLoad">validateIdLoad</a></li></ul></li><li><a href="module-Controller_dashboard.html">Controller/dashboard</a><ul class='methods'><li data-type='method'><a href="module-Controller_dashboard.html#~getDashboardStats">getDashboardStats</a></li></ul></li><li><a href="module-Controller_invoices.html">Controller/invoices</a><ul class='methods'><li data-type='method'><a href="module-Controller_invoices.html#~createInvoice">createInvoice</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoices">viewInvoices</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesById">viewInvoicesById</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesByUser">viewInvoicesByUser</a></li></ul></li><li><a href="module-Controller_keypad.html">Controller/keypad</a><ul class='methods'><li data-type='method'><a href="module-Controller_keypad.html#~createPasscode">createPasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~deletePasscode">deletePasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~listPasscodes">listPasscodes</a></li></ul></li><li><a href="module-Controller_lock_august_index.html">Controller/lock/august/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~lockStatus">lockStatus</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_lock_august_token.html">Controller/lock/august/token</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_token.html#~confirm">confirm</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~session">session</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~validate">validate</a></li></ul></li><li><a href="module-Controller_lock_index.html">Controller/lock/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_index.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getStatus">getStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~sendCommand">sendCommand</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~toggleLock">toggleLock</a></li></ul></li><li><a href="module-Controller_lock_switchbot.html">Controller/lock/switchbot</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_meeting.html">Controller/meeting</a><ul class='methods'><li data-type='method'><a href="module-Controller_meeting.html#~meetingStats">meetingStats</a></li><li data-type='method'><a href="module-Controller_meeting.html#~sendTempCommand">sendTempCommand</a></li></ul></li><li><a href="module-Controller_notification.html">Controller/notification</a><ul class='methods'><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationEmail">sendConfirmationEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationSMS">sendConfirmationSMS</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendEmail">sendEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendSms">sendSms</a></li></ul></li><li><a href="module-Controller_order.html">Controller/order</a><ul class='methods'><li data-type='method'><a href="module-Controller_order.html#~createAndNotify">createAndNotify</a></li><li data-type='method'><a href="module-Controller_order.html#~formatOrderDetails">formatOrderDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~formatUserDetails">formatUserDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~updateAndNotify">updateAndNotify</a></li></ul></li><li><a href="module-Controller_property.html">Controller/property</a><ul class='methods'><li data-type='method'><a href="module-Controller_property.html#~assignPropertyToUser">assignPropertyToUser</a></li><li data-type='method'><a href="module-Controller_property.html#~calcAvailability">calcAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~calcMonthAvailability">calcMonthAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~cloneProperty">cloneProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~getSinglePublicProperty">getSinglePublicProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~makeBook">makeBook</a></li><li data-type='method'><a href="module-Controller_property.html#~newProperty">newProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesPublic">propertiesPublic</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesUser">propertiesUser</a></li><li data-type='method'><a href="module-Controller_property.html#~property">property</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyAssignList">propertyAssignList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyList">propertyList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyListCustomSearch">propertyListCustomSearch</a></li><li data-type='method'><a href="module-Controller_property.html#~updateProperty">updateProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~updatePropertyKit">updatePropertyKit</a></li></ul></li><li><a href="module-Controller_shipment.html">Controller/shipment</a><ul class='methods'><li data-type='method'><a href="module-Controller_shipment.html#~formattedShipment">formattedShipment</a></li><li data-type='method'><a href="module-Controller_shipment.html#~sendShipmentNotification">sendShipmentNotification</a></li></ul></li><li><a href="module-Controller_transactions.html">Controller/transactions</a><ul class='methods'><li data-type='method'><a href="module-Controller_transactions.html#~createTransaction">createTransaction</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByHardware">viewTransactionByHardware</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionById">viewTransactionById</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByProperty">viewTransactionByProperty</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactions">viewTransactions</a></li></ul></li><li><a href="module-constants_cognito.html">constants/cognito</a></li><li><a href="module-constants_index.html">constants/index</a></li><li><a href="module-controllers_notifications.html">controllers/notifications</a><ul class='methods'><li data-type='method'><a href="module-controllers_notifications.html#~sendInstructions">sendInstructions</a></li><li data-type='method'><a href="module-controllers_notifications.html#~sendReminder">sendReminder</a></li></ul></li><li><a href="module-controllers_property.html">controllers/property</a><ul class='methods'><li data-type='method'><a href="module-controllers_property.html#~associateKit">associateKit</a></li></ul></li><li><a href="module-events_emitter.html">events/emitter</a></li><li><a href="module-helpers_account.html">helpers/account</a><ul class='methods'><li data-type='method'><a href="module-helpers_account.html#~addHardware">addHardware</a></li><li data-type='method'><a href="module-helpers_account.html#~addSwitchBotHardware">addSwitchBotHardware</a></li></ul></li><li><a href="module-helpers_aws-s3.html">helpers/aws-s3</a><ul class='methods'><li data-type='method'><a href="module-helpers_aws-s3.html#.getFileExtensionFromBase64">getFileExtensionFromBase64</a></li><li data-type='method'><a href="module-helpers_aws-s3.html#.uploadS3">uploadS3</a></li></ul></li><li><a href="module-helpers_button.html">helpers/button</a><ul class='methods'><li data-type='method'><a href="module-helpers_button.html#~actuateButton">actuateButton</a></li></ul></li><li><a href="module-helpers_calendar.html">helpers/calendar</a><ul class='methods'><li data-type='method'><a href="module-helpers_calendar.html#~dateTimeForCalander">dateTimeForCalander</a></li><li data-type='method'><a href="module-helpers_calendar.html#~deleteEvent">deleteEvent</a></li><li data-type='method'><a href="module-helpers_calendar.html#~getEvents">getEvents</a></li><li data-type='method'><a href="module-helpers_calendar.html#~insertEvent">insertEvent</a></li></ul></li><li><a href="module-helpers_camera.html">helpers/camera</a><ul class='methods'><li data-type='method'><a href="module-helpers_camera.html#~streamToBuffer">streamToBuffer</a></li></ul></li><li><a href="module-helpers_cognito.html">helpers/cognito</a><ul class='methods'><li data-type='method'><a href="module-helpers_cognito.html#~assignUserToGroup">assignUserToGroup</a></li><li data-type='method'><a href="module-helpers_cognito.html#~cognitoSignUp">cognitoSignUp</a></li><li data-type='method'><a href="module-helpers_cognito.html#~deleteUserFromCognito">deleteUserFromCognito</a></li><li data-type='method'><a href="module-helpers_cognito.html#~getSingleCognitoUser">getSingleCognitoUser</a></li><li data-type='method'><a href="module-helpers_cognito.html#~setPermanentUserPassword">setPermanentUserPassword</a></li><li data-type='method'><a href="module-helpers_cognito.html#~signInCognito">signInCognito</a></li><li data-type='method'><a href="module-helpers_cognito.html#~verifyHeaders">verifyHeaders</a></li><li data-type='method'><a href="module-helpers_cognito.html#~verifyToken">verifyToken</a></li></ul></li><li><a href="module-helpers_emailGeneration.html">helpers/emailGeneration</a><ul class='methods'><li data-type='method'><a href="module-helpers_emailGeneration.html#~formatDateToGoogleCalendar">formatDateToGoogleCalendar</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~formattingTime">formattingTime</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateBookingConfirmationEmail">generateBookingConfirmationEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateGoogleCalendarUrl">generateGoogleCalendarUrl</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateInstructionsEmail">generateInstructionsEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateReminderEmail">generateReminderEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~insertInEmailLayout">insertInEmailLayout</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~urlEncode">urlEncode</a></li></ul></li><li><a href="module-helpers_keypad.html">helpers/keypad</a><ul class='methods'><li data-type='method'><a href="module-helpers_keypad.html#~passcodeList">passcodeList</a></li></ul></li><li><a href="module-helpers_kit.html">helpers/kit</a><ul class='methods'><li data-type='method'><a href="module-helpers_kit.html#~associateHardware">associateHardware</a></li><li data-type='method'><a href="module-helpers_kit.html#~closeKitToUser">closeKitToUser</a></li><li data-type='method'><a href="module-helpers_kit.html#~registerKitToUser">registerKitToUser</a></li></ul></li><li><a href="module-helpers_switchbot.html">helpers/switchbot</a><ul class='methods'><li data-type='method'><a href="module-helpers_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-helpers_utilities.html">helpers/utilities</a><ul class='methods'><li data-type='method'><a href="module-helpers_utilities.html#~downloadImage">downloadImage</a></li><li data-type='method'><a href="module-helpers_utilities.html#~relativeTimeConversion">relativeTimeConversion</a></li><li data-type='method'><a href="module-helpers_utilities.html#~splitTags">splitTags</a></li></ul></li><li><a href="module-middleware_adminRole.html">middleware/adminRole</a><ul class='methods'><li data-type='method'><a href="module-middleware_adminRole.html#~adminRole">adminRole</a></li></ul></li><li><a href="module-middleware_authMiddleware.html">middleware/authMiddleware</a><ul class='methods'><li data-type='method'><a href="module-middleware_authMiddleware.html#~authMiddleware">authMiddleware</a></li></ul></li><li><a href="module-middleware_errorHandler.html">middleware/errorHandler</a><ul class='methods'><li data-type='method'><a href="module-middleware_errorHandler.html#~errorHandler">errorHandler</a></li></ul></li><li><a href="module-models_account.html">models/account</a></li><li><a href="module-models_action.html">models/action</a></li><li><a href="module-models_building.html">models/building</a></li><li><a href="module-models_confirmationCode.html">models/confirmationCode</a></li><li><a href="module-models_contact.html">models/contact</a></li><li><a href="module-models_discount.html">models/discount</a></li><li><a href="module-models_hardware.html">models/hardware</a></li><li><a href="module-models_invoice.html">models/invoice</a></li><li><a href="module-models_invoiceInfo.html">models/invoiceInfo</a></li><li><a href="module-models_kit.html">models/kit</a></li><li><a href="module-models_meeting.html">models/meeting</a></li><li><a href="module-models_order.html">models/order</a></li><li><a href="module-models_paymentMethod.html">models/paymentMethod</a></li><li><a href="module-models_product.html">models/product</a></li><li><a href="module-models_property.html">models/property</a></li><li><a href="module-models_settings.html">models/settings</a></li><li><a href="module-models_shipment.html">models/shipment</a></li><li><a href="module-models_subscription.html">models/subscription</a></li><li><a href="module-models_transaction.html">models/transaction</a></li><li><a href="module-models_user.html">models/user</a></li><li><a href="module-routes_account.html">routes/account</a></li><li><a href="module-routes_agents.html">routes/agents</a></li><li><a href="module-routes_button.html">routes/button</a></li><li><a href="module-routes_camera.html">routes/camera</a></li><li><a href="module-routes_contact.html">routes/contact</a><ul class='methods'><li data-type='method'><a href="module-routes_contact.html#.get/">get/</a></li><li data-type='method'><a href="module-routes_contact.html#.get/:id?">get/:id?</a></li><li data-type='method'><a href="module-routes_contact.html#.get/toCsv">get/toCsv</a></li><li data-type='method'><a href="module-routes_contact.html#.post/validateid/load">post/validateid/load</a></li><li data-type='method'><a href="module-routes_contact.html#.put/update/:id?">put/update/:id?</a></li><li data-type='method'><a href="module-routes_contact.html#.subscription/:id">subscription/:id</a></li></ul></li><li><a href="module-routes_contactVerified.html">routes/contactVerified</a></li><li><a href="module-routes_dashboard.html">routes/dashboard</a></li><li><a href="module-routes_discount.html">routes/discount</a><ul class='methods'><li data-type='method'><a href="module-routes_discount.html#.get/">get/</a></li><li data-type='method'><a href="module-routes_discount.html#.get/:code">get/:code</a></li><li data-type='method'><a href="module-routes_discount.html#.get/generate-code">get/generate-code</a></li><li data-type='method'><a href="module-routes_discount.html#.post/">post/</a></li></ul></li><li><a href="module-routes_documents.html">routes/documents</a></li><li><a href="module-routes_hardware.html">routes/hardware</a><ul class='methods'><li data-type='method'><a href="module-routes_hardware.html#.delete/:id">delete/:id</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id/admin/sync">get/:id/admin/sync</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id/stream">get/:id/stream</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id?">get/:id?</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/list/cameras">get/list/cameras</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/session/:property/:uid/agent">get/session/:property/:uid/agent</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/session/:property/:uid/manager">get/session/:property/:uid/manager</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/">post/</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/:id">post/:id</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/:id/stream/test">post/:id/stream/test</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/admin/buzzer">post/admin/buzzer</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/admin/sync">post/admin/sync</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/app/ping">post/app/ping</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/bulk">post/bulk</a></li><li data-type='method'><a href="module-routes_hardware.html#~generateStreamUrl">generateStreamUrl</a></li><li data-type='method'><a href="module-routes_hardware.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-routes_index.html">routes/index</a><ul class='methods'><li data-type='method'><a href="module-routes_index.html#.get/logout">get/logout</a></li><li data-type='method'><a href="module-routes_index.html#.use/admin">use/admin</a></li><li data-type='method'><a href="module-routes_index.html#.use/public">use/public</a></li><li data-type='method'><a href="module-routes_index.html#.use/public/images/contact">use/public/images/contact</a></li><li data-type='method'><a href="module-routes_index.html#.use/public/images/property">use/public/images/property</a></li></ul></li><li><a href="module-routes_invoice.html">routes/invoice</a></li><li><a href="module-routes_invoiceInfo.html">routes/invoiceInfo</a><ul class='methods'><li data-type='method'><a href="module-routes_invoiceInfo.html#.CreateInvoiceInfo">CreateInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.DeleteInvoiceInfo">DeleteInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.GetInvoiceInfo">GetInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.GetInvoiceInfoAdmin">GetInvoiceInfoAdmin</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.UpdateInvoiceInfo">UpdateInvoiceInfo</a></li></ul></li><li><a href="module-routes_keypad.html">routes/keypad</a><ul class='methods'><li data-type='method'><a href="module-routes_keypad.html#.PasscodeRoutes">PasscodeRoutes</a></li></ul></li><li><a href="module-routes_kit.html">routes/kit</a><ul class='methods'><li data-type='method'><a href="module-routes_kit.html#.ConfirmKit">ConfirmKit</a></li><li data-type='method'><a href="module-routes_kit.html#.CreateKit">CreateKit</a></li><li data-type='method'><a href="module-routes_kit.html#.DeleteKit">DeleteKit</a></li><li data-type='method'><a href="module-routes_kit.html#.GetAllKits">GetAllKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetKitById">GetKitById</a></li><li data-type='method'><a href="module-routes_kit.html#.GetOrderKits">GetOrderKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetOrderKits">GetOrderKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetUserKits">GetUserKits</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateKit">UpdateKit</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateKitState">UpdateKitState</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateMultipleKits">UpdateMultipleKits</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateShippingAddress">UpdateShippingAddress</a></li></ul></li><li><a href="module-routes_lock.html">routes/lock</a><ul class='methods'><li data-type='method'><a href="module-routes_lock.html#.ConfirmLockToken">ConfirmLockToken</a></li><li data-type='method'><a href="module-routes_lock.html#.GetLockLogs">GetLockLogs</a></li><li data-type='method'><a href="module-routes_lock.html#.GetLockStatus">GetLockStatus</a></li><li data-type='method'><a href="module-routes_lock.html#.SendLockCommand">SendLockCommand</a></li><li data-type='method'><a href="module-routes_lock.html#.StartLockTokenSession">StartLockTokenSession</a></li><li data-type='method'><a href="module-routes_lock.html#.ValidateLockToken">ValidateLockToken</a></li></ul></li><li><a href="module-routes_meeting.html">routes/meeting</a><ul class='methods'><li data-type='method'><a href="module-routes_meeting.html#.CancelMeeting">CancelMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.CreateMeeting">CreateMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.ExecuteTempLockCommand">ExecuteTempLockCommand</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetCancellationPage">GetCancellationPage</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetingDetails">GetMeetingDetails</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetingStats">GetMeetingStats</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetings">GetMeetings</a></li><li data-type='method'><a href="module-routes_meeting.html#.HandleMeetingAction">HandleMeetingAction</a></li><li data-type='method'><a href="module-routes_meeting.html#.HandleMeetingCancellation">HandleMeetingCancellation</a></li><li data-type='method'><a href="module-routes_meeting.html#.RescheduleMeeting">RescheduleMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.RetrieveMeetings">RetrieveMeetings</a></li><li data-type='method'><a href="module-routes_meeting.html#.UpdateMeeting">UpdateMeeting</a></li></ul></li><li><a href="module-routes_notification.html">routes/notification</a><ul class='methods'><li data-type='method'><a href="module-routes_notification.html#.SendConfirmationEmail">SendConfirmationEmail</a></li><li data-type='method'><a href="module-routes_notification.html#.SendConfirmationSMS">SendConfirmationSMS</a></li></ul></li><li><a href="module-routes_order.html">routes/order</a><ul class='methods'><li data-type='method'><a href="module-routes_order.html#.CreateOrder">CreateOrder</a></li><li data-type='method'><a href="module-routes_order.html#.DeleteAllOrders">DeleteAllOrders</a></li><li data-type='method'><a href="module-routes_order.html#.GetAllOrders">GetAllOrders</a></li><li data-type='method'><a href="module-routes_order.html#.GetOrderById">GetOrderById</a></li><li data-type='method'><a href="module-routes_order.html#.GetOrderItems">GetOrderItems</a></li><li data-type='method'><a href="module-routes_order.html#.GetSessionInfo">GetSessionInfo</a></li><li data-type='method'><a href="module-routes_order.html#.GetSubscriptionInfo">GetSubscriptionInfo</a></li><li data-type='method'><a href="module-routes_order.html#.GetUserOrders">GetUserOrders</a></li><li data-type='method'><a href="module-routes_order.html#.ListOrdersWithUserInfo">ListOrdersWithUserInfo</a></li><li data-type='method'><a href="module-routes_order.html#.UpdateOrderState">UpdateOrderState</a></li></ul></li><li><a href="module-routes_product.html">routes/product</a><ul class='methods'><li data-type='method'><a href="module-routes_product.html#.CreateProduct">CreateProduct</a></li><li data-type='method'><a href="module-routes_product.html#.GetProducts">GetProducts</a></li></ul></li><li><a href="module-routes_property.html">routes/property</a><ul class='methods'><li data-type='method'><a href="module-routes_property.html#.CustomSearchProperties">CustomSearchProperties</a></li><li data-type='method'><a href="module-routes_property.html#.GetPropertiesByUser">GetPropertiesByUser</a></li><li data-type='method'><a href="module-routes_property.html#.GetPropertyById">GetPropertyById</a></li><li data-type='method'><a href="module-routes_property.html#.ListAgentProperties">ListAgentProperties</a></li><li data-type='method'><a href="module-routes_property.html#.ListProperties">ListProperties</a></li><li data-type='method'><a href="module-routes_property.html#.PingProperty">PingProperty</a></li><li data-type='method'><a href="module-routes_property.html#.PingPropertySession">PingPropertySession</a></li><li data-type='method'><a href="module-routes_property.html#.PingPropertySessionById">PingPropertySessionById</a></li></ul></li><li><a href="module-routes_shipment.html">routes/shipment</a><ul class='methods'><li data-type='method'><a href="module-routes_shipment.html#.ConfirmShipmentDelivery">ConfirmShipmentDelivery</a></li><li data-type='method'><a href="module-routes_shipment.html#.CreateShipment">CreateShipment</a></li><li data-type='method'><a href="module-routes_shipment.html#.DeleteAllShipments">DeleteAllShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.GetShipmentById">GetShipmentById</a></li><li data-type='method'><a href="module-routes_shipment.html#.ListAllShipments">ListAllShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.ListUserShipments">ListUserShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.UpdateShipmentState">UpdateShipmentState</a></li></ul></li><li><a href="module-routes_subscription.html">routes/subscription</a><ul class='methods'><li data-type='method'><a href="module-routes_subscription.html#.CreateSubscription">CreateSubscription</a></li><li data-type='method'><a href="module-routes_subscription.html#.DeleteAllSubscriptions">DeleteAllSubscriptions</a></li><li data-type='method'><a href="module-routes_subscription.html#.EndTrial">EndTrial</a></li><li data-type='method'><a href="module-routes_subscription.html#.GetAllSubscriptions">GetAllSubscriptions</a></li><li data-type='method'><a href="module-routes_subscription.html#.GetSubscriptionByUserId">GetSubscriptionByUserId</a></li></ul></li><li><a href="module-routes_transactions.html">routes/transactions</a><ul class='methods'><li data-type='method'><a href="module-routes_transactions.html#.GetAllTransactions">GetAllTransactions</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionById">GetTransactionById</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionsByHardware">GetTransactionsByHardware</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionsByProperty">GetTransactionsByProperty</a></li></ul></li><li><a href="module-routes_users.html">routes/users</a><ul class='methods'><li data-type='method'><a href="module-routes_users.html#.CreateAdmin">CreateAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.CreateAgent">CreateAgent</a></li><li data-type='method'><a href="module-routes_users.html#.DeleteAdmin">DeleteAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.ForgotPassword">ForgotPassword</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdmin">GetAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdminAccountList">GetAdminAccountList</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdminList">GetAdminList</a></li><li data-type='method'><a href="module-routes_users.html#.GetOrgs">GetOrgs</a></li><li data-type='method'><a href="module-routes_users.html#.GetStripe">GetStripe</a></li><li data-type='method'><a href="module-routes_users.html#.GetTimezone">GetTimezone</a></li><li data-type='method'><a href="module-routes_users.html#.GetUser">GetUser</a></li><li data-type='method'><a href="module-routes_users.html#.Login">Login</a></li><li data-type='method'><a href="module-routes_users.html#.Logout">Logout</a></li><li data-type='method'><a href="module-routes_users.html#.Register">Register</a></li><li data-type='method'><a href="module-routes_users.html#.RequestCode">RequestCode</a></li><li data-type='method'><a href="module-routes_users.html#.ResetPassword">ResetPassword</a></li><li data-type='method'><a href="module-routes_users.html#.ResetUserPassword">ResetUserPassword</a></li><li data-type='method'><a href="module-routes_users.html#.SuperadminRegister">SuperadminRegister</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateAgent">UpdateAgent</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateProfile">UpdateProfile</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateSettings">UpdateSettings</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateUser">UpdateUser</a></li></ul></li><li><a href="module-routes_webhook.html">routes/webhook</a></li></ul><h3>Events</h3><ul><li><a href="module-routes_contactVerified.html#~event:CVWaitList">CVWaitList</a></li><li><a href="module-routes_contactVerified.html#~event:cleanupCVWaitList">cleanupCVWaitList</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">routes/hardware.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Hardware Routes Module
 * This module handles routes related to hardware management, including camera streaming, QR code generation,
 * session management, and hardware CRUD operations.
 * 
 * @module routes/hardware
 */
const Hardware = require('../models/hardware');
const Kit = require('../models/kit');
const Property = require('../models/property');
const router = require('express').Router();
const config = require('../config')
const QRCode = require('qrcode')
const ObjectId = require('mongoose').Types.ObjectId;
const crypto = require('crypto');
const Camera = require('../controllers/camera');
const notification = require('../controllers/notification');
const { uuid } = require('uuidv4');
const { authMiddleware } = require('../middlewares/authMiddleware');
const adminRole = require('../middlewares/adminRole')
const { getKinesesStreamingUrl, triggerCameraStreams, getListFragments, getStoredHLS } = require('../controllers/camera');
const { streamToBuffer } = require('../helpers/camera');

const videoServerUrl = process.env.videoServerUrl
const apiUrl = process.env.apiUrl;
const videoRelayUrl = process.env.videoRelayUrl;

/**
 * Route to test camera streaming for a specific hardware ID.
 * 
 * @name post/:id/stream/test
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.route('/:id/stream/test')
  .post(
    authMiddleware,
    function (req, res, next) {
      if (req.user.role != 'admin') {
        return res.status(401).end();
      }
      if (req.params.id !== 'unsaved' &amp;&amp; !req.body.testIp) {

        return next();
      }


      let link = '';

      var camera = req.body;

      if (!camera.link || camera.link.length == 0) {
        camera.hostname = camera.hostname || '&lt;ipaddress>';
        let credentials = '';
        if (camera.username &amp;&amp; camera.password) {
          credentials = camera.username + ':' + camera.password + '@'
        }
        link = camera.protocol + '://' + credentials + camera.hostname + ':' + camera.port + camera.path
      } else {
        link = camera.link;
      }

      link = link.replace('&lt;ipaddress>', req.body.testIp);


      //ignore ip blocking for now
      let data = {
        _id: 'unsaved',
        ip: req.body.testIp,
        link: link
      };
      let text = JSON.stringify(data);

      var cipher = crypto.createCipher(config.stream.algorithm, config.stream.key);
      var encrypted = cipher.update(text, 'utf8', 'hex') + cipher.final('hex');

      res.json({ url: videoRelayUrl + '?token=' + encrypted })


    }, generateStreamUrl);

/**
 * Route to get the stream URL for a specific hardware ID.
 * 
 * @name get/:id/stream
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.route('/:id/stream')
  .get(
    authMiddleware, generateStreamUrl
  );

function generateStreamUrl(req, res, next) {


  let query = { user: req.user._id, category: 'camera', _id: req.params.id };

  if (req.user.orgs) {
    query.user = req.user.orgs;
  }

  if (req.user.role == 'admin') {
    delete query.user;
  }

  Hardware
    .findOne(query)
    .populate('kit')
    .exec(function (err, camera) {

      // we dont know which kit to look for
      Kit.findOne({ hardware: { $in: camera._id } }).exec(function (err, kit) {

        //temp in line solution to fix bug of null kit properties
        // this introduces a vulnerability if a static ip used and camera
        // not reassigned the old user could in theory still access the feed
        if (!camera || !kit) {
          return res.status(404).end();
        }
        let link = '';

        if (!camera.link || camera.link.length == 0) {
          camera.hostname = camera.hostname || '&lt;ipaddress>';
          let credentials = '';
          if (camera.username &amp;&amp; camera.password) {
            credentials = camera.username + ':' + camera.password + '@'
          }
          link = camera.protocol + '://' + credentials + camera.hostname + ':' + camera.port + camera.path
        } else {
          link = camera.link;
        }

        //ignore ip blocking for now
        let data = {
          _id: camera._id,
          link: link
        };
        let text = JSON.stringify(data);

        var cipher = crypto.createCipher(config.stream.algorithm, config.stream.key);
        var encrypted = cipher.update(text, 'utf8', 'hex') + cipher.final('hex');
        // var decipher = crypto.createDecipher(config.stream.algorithm, config.stream.key);
        // var decrypted = decipher.update(encrypted, 'hex', 'utf8') + decipher.final('utf8');

        res.json({ url: videoRelayUrl + '?token=' + encrypted })
      });


    })
}

/**
 * Generates a stream URL for a specific hardware.
 * 
 * @function generateStreamUrl
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.route('/session/:property/:uid/manager')
  .get(
    function (req, res, next) {
      let query = { _id: req.params.property }
      if (!ObjectId.isValid(req.params.property)) {
        return res.status(403).end();
      }
      Property.findOne(query).exec((e, property) => {
        if (!property || !property.session || property.session.id !== req.params.uid) {
          return res.status(403).end();
        }
        next();
      });
    },

    // @todo we need to make a node proxy to hide exposing this directly
    function (req, res, next) {
      let url = videoServerUrl + req.params.property + '/name/' + 'tablet';
      let pingUrl = apiUrl + '/api/property/' + req.params.property + '/' + req.params.uid + '/ping';
      res.send(`
      &lt;html>
        &lt;style>
          html {
            background:rgba(0,0,0,0.85);
          }
          body {
            margin:0px!important;
          }         
        &lt;/style>
        &lt;body>
            &lt;div class="accordion-body text-muted">
              &lt;iframe 
                  src="${url}" 
                  id="dropInFrame" 
                  allow="camera;microphone" 
                  frameborder="0"
                  style="width:100%;height:100%">
                &lt;/iframe>
              &lt;/div>
        &lt;/body>

        

      &lt;div id="goFs-container" style="position:fixed; top:0px; width:100%">
      &lt;button style="display:block;width:150px;height:50px;margin:auto;border-radius:15px;" id="goFS">Fullscreen&lt;/button>
       &lt;/div>
      &lt;script>
        var goFS = document.getElementById("goFS");
        goFS.addEventListener("click", function() {
            var container = document.querySelector("body");
            container.requestFullscreen();
            document.getElementById("goFs-container").style.display = "none";
        }, false);
      &lt;/script>




        &lt;script>
          setInterval(function() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '${pingUrl}', true);
            xhr.onload = function () {
                if (xhr.readyState === xhr.DONE) {
                    if (xhr.status === 200) {
                        console.log(xhr.responseText);
                    }
                }
            };
            xhr.send(null);
          }, 30000);          
        &lt;/script>
      &lt;/html>`
      )
    })

/**
 * Route to manage tablet sessions for a property manager.
 * 
 * @name get/session/:property/:uid/manager
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.route('/session/:property/:uid/agent')
  .get(
    function (req, res, next) {
      let query = { _id: req.params.property }
      if (!ObjectId.isValid(req.params.property)) {
        return res.status(403).end();
      }
      Property.findOne(query, { session: 1, sync: 1 }).exec((e, property) => {
        if (!property || !property.session || property.session.id !== req.params.uid) {
          return res.status(403).end();
        }

        Hardware.findOne({ property: req.params.property, category: 'tablet', status: 'active', 'sync.token': { $exists: true } }).exec(function (err, hardware) {
          if (hardware) {

            if (hardware.sync.mode !== 'poll') {
              setTimeout(function () {
                sendPN('Meeting started', 'Meeting is starting now....', videoServerUrl + req.params.property + '/name/' + 'tablet-' + new Date().getTime(), hardware.sync.token)
              }, 1000)
            }

          }
        })
        next();
      });
    },

    // @todo we need to make a node proxy to hide exposing this directly
    function (req, res, next) {
      let url = videoServerUrl + req.params.uid + '/name/' + 'agent-' + new Date().getTime()
      res.send(`
        &lt;html>
          &lt;style>
            html {
              background:rgba(0,0,0,0.85);
            }
          &lt;/style>
          &lt;body>
              &lt;div class="accordion-body text-muted">
                &lt;iframe 
                    src="${url}" 
                    id="dropInFrame" 
                    allow="camera;microphone" 
                    frameborder="0"
                    style="width:100%;height:100%">
                  &lt;/iframe>
                &lt;/div>
          &lt;/body>          
        &lt;/html>`
      )
    })
  .delete(function (req, res, next) {
    let query = { _id: req.params.property }
    if (!ObjectId.isValid(req.params.property)) {
      return res.status(403).end();
    }
    Property.findOne(query).exec((e, property) => {
      if (!property || !property.session || property.session.id !== req.params.uid) {
        return res.status(403).end();
      }
      Hardware.findOne({ property: req.params.property, category: 'tablet', status: 'active', 'sync.token': { $exists: true } }).exec(function (err, hardware) {
        if (hardware.sync.mode !== 'poll') {
          sendPN('Meeting Ended', 'Meeting Finished', process.env.apiUrl + "/admin.html#!/tablet/config", hardware.sync.token)
        }

        Property.findOneAndUpdate(
          { _id: property._id },
          { $set: { dropinPing: null } },
          { upsert: false, new: false })
          .exec((err, property) => {

          });

      })
      next();
    });
  })

/**
 * Route to manage tablet sessions for a property agent.
 * 
 * @name get/session/:property/:uid/agent
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.route('/qrcode/conference/:id/small.jpg')
  .get(
    authMiddleware,
    function (req, res, next) {
      let query = { $or: [
        {user: req.user._id },
        { allowedAgents: req.user._id }
      ] }

      if (req.user.orgs) {
        query.user = req.user.orgs;
      }

      if (req.params.id &amp;&amp; ObjectId.isValid(req.params.id)) {
        query._id = req.params.id;
      }
      Property.findOne(query).exec((e, property) => {


        // if (!property.session &amp;&amp; !property.session.id) {
        property.session = { id: uuid(), expires: new Date().getTime() + (86400000 * 7) }
        property.save(function (err) { });
        // }

        url = apiUrl + '/api/hardware/session/' + property._id + '/' + property.session.id + '/agent';

        return res.json({ url: url });


        // QRCode.toDataURL(url, function (err, image) {
        //   res.json({ image: image, url });
        // })

      })
    })

// unique session - through the site with auth

/**
 * Route to list all active cameras for the user.
 * 
 * @name get/list/cameras
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.get('/list/cameras',
  authMiddleware,
  function (req, res, next) {

    let query = { user: req.user._id, 'status': 'active', 'category': 'camera' };

    if (req.user.orgs) {
      query.user = req.user.orgs;
    }

    let Query = Hardware.find(query)

    Query.populate('kit').populate('property').exec((e, hardware) => {
      res.json(hardware);
    })
  });

/**
 * Route to get or list all hardware.
 * 
 * @name get/:id?
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.get('/:id?', authMiddleware, adminRole, function (req, res, next) {

  let query = {}

  let Query = Hardware.find(query)

  if (req.params.id &amp;&amp; ObjectId.isValid(req.params.id)) {
    query._id = req.params.id;
    Query = Hardware.findOne(query)
  }

  if (req.query.format == 'list',
    authMiddleware) {
    Query.populate('user', 'firstName lastName').populate('kit', 'name').populate('property', 'name address');
  } else {
    Query.populate('user').populate('kit').populate('property').populate('org', 'email company');
  }
  Query.exec((err, hardware) => {
    if (err) {
      res.status(500).send(err);
    } else {
      res.status(200).json(hardware);
    }
  })
});

/**
 * Route to create new hardware.
 * 
 * @name post/
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.post('/', authMiddleware, adminRole, function (req, res, next) {

  let hardware = new Hardware(req.body)

  hardware.save(function (err, hw) {
    if (err) {
      res.status(500).send(err);
    } else {
      if (hw.category == 'camera' &amp;&amp; hardware.zm.status === 'enabled') {
        Camera.enable(hw, function (err, body) {
          if (err) {
            console.log('Failed to enable camera', err)
          } else {
            console.log('Camera Enabled', body)
          }
        })
      }
      res.status(200).send('Hardware Created Successfully');
    }
  })
});

/**
 * Route to create hardware in bulk.
 * 
 * @name post/bulk
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.post('/bulk', authMiddleware, adminRole, function (req, res, next) {

  // hacer un for para incertar
  let hardwareArr = [];
  req.body.forEach(element => {
    let newHardware = new Hardware(element);
    hardwareArr.push(newHardware);
  });
  hardwareArr.forEach((element, index) => {
    element.save(function (err) {
      if (err) {
        console.log(err);
        res.send(409, `Interrupted by error on line ${index + 1}`);
      } else if (hardwareArr.length === 0) {
        res.status(201).send('created');
      } else {
        hardwareArr.shift();
      }
    })
  });
});

/**
 * Route to update existing hardware.
 * 
 * @name post/:id
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express next middleware function.
 */
router.post('/:id', authMiddleware, adminRole, function (req, res, next) {//update Hardaware

  if (!ObjectId.isValid(req.params.id)) {
    return res.status(400).end();
  }

  Hardware.findOneAndUpdate({ _id: req.params.id }, { $set: req.body }, { upsert: false, new: true }).exec((err, hardware) => {
    if (err) {
      res.status(500).send(err);
    } else {
      if (hardware.category == 'camera') {
        Camera.enable(hardware, function (err, body) {
          if (err) {
            console.log('Failed to enable camera', err)
          } else {
            console.log('Camera Enabled', body)
          }
        })
      }
      res.status(200).send('Hardware Edited Successfully');
    }
  })

});

/**
 * Route to delete existing hardware.
 * 
 * @name delete/:id
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 */
router.delete('/:id', authMiddleware, adminRole, (req, res) => {

  if (!ObjectId.isValid(req.params.id)) {
    return res.status(400).end();
  }

  Kit.findOneAndUpdate(
    { hardware: { $in: [req.params.id] } },
    { $pull: { hardware: req.params.id } },
    { upsert: false, new: true }
  ).exec()

  Hardware.findOneAndDelete({ _id: req.params.id }).exec((err, hardware) => {
    if (err) {
      res.status(500).send(err);
    } else {
      if (hardware.category === 'camera') {
        Camera.delete(hardware, function (err, body) {
          if (err) {
            console.log('Failed to delete camera: ', err)
          } else {
            console.log('Camera Deleted: ', body)
          }
        })
      }
      res.status(200).send('Hardware Deleted Successfully');
    }
  });
});


/**
 * Route to sync hardware with admin privileges.
 * 
 * @name get/:id/admin/sync
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 */
router.get('/:id/admin/sync', authMiddleware, adminRole, function (req, res, next) {

  if (!ObjectId.isValid(req.params.id)) {
    return res.status(400).end();
  }

  let codeLength = 5;
  let code1 = "";
  let code2 = "";
  let charSet = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 'A', 'B', 'C', 'D', 'E', 'F']
  for (let i = 0; i &lt; codeLength * 2; i++) {
    let digit = charSet[Math.round(Math.random() * 15)];
    if (i &lt; codeLength) {
      code1 += digit;
    } else {
      code2 += digit;
    }
  }
  let expires = new Date().getTime() + 1000 * 60 * 5;

  Hardware.findOneAndUpdate({ _id: req.params.id }, { $set: { 'sync.expires': expires, 'sync.code1': code1, 'sync.code2': code2 } }, { upsert: false, multi: false, new: true }).exec(function (err, hardware) {
    res.json(hardware.sync)
  })

});

/**
 * Route to sync hardware via admin.
 * 
 * @name post/admin/sync
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 */
router.post('/admin/sync', function (req, res, next) {

  Hardware.findOneAndUpdate(
    { 'sync.expires': { $gte: new Date().getTime() }, 'sync.code1': req.body.code1.substr(0, 5).toUpperCase(), 'sync.code2': req.body.code2.substr(0, 5).toUpperCase() },
    { $set: { 'sync.token': req.body.token } },
    { upsert: false, multi: false, new: true }).exec(function (err, hardware) {

      if (err || !hardware) {
        return res.status(403).end();
      }
      sendPN('Sync Success', 'Syncing of the tablet has been completed.', process.env.apiUrl + "/admin.html#!/tablet/config", hardware.sync.token)
      res.status(200).end();
    })


});

/**
 * Route to handle buzzer notifications.
 * 
 * @name post/admin/buzzer
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 */
router.post('/admin/buzzer', function (req, res, next) {

  Hardware.findOne({ 'sync.token': req.body.token }).populate('user').populate('property').exec(function (err, hardware) {

    if (err || !hardware) {
      return res.status(403).end();
    }

    if (!hardware.user) {
      return res.status(403).end();
    }

    if (!hardware.property) {
      return res.status(403).end();
    }

    const companyName = (hardware.user.company.name !== undefined &amp;&amp; hardware.user.company.name !== '') ? hardware.user.company.name : 'Delet';

    notification.sendEmail({
      emailAlias: companyName,
      to: hardware.user.email,
      subject: 'Buzzer request at: ' + hardware.property.address,
      body: `
          A buzzer request was just made on the application&lt;br>
          &lt;br>
          Property Link: ${apiUrl}/#!/property/view/${hardware.property._id}
          &lt;br>
          &lt;br>
          
          `});
    if (hardware.user.phone !== undefined) {
      notification.sendSms({
        phone: hardware.user.phone,
        body: `Buzzer request at:  ${hardware.property.address}\n\nProperty Link: ${apiUrl}/#!/property/view/${hardware.property._id}`
      }).catch(error => console.log(error));
    }

    res.status(200).end();
  })
});

/**
 * Route to ping hardware with app token.
 * 
 * @name post/app/ping
 * @function
 * @memberof module:routes/hardware
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 */
router.post('/app/ping',
  function (req, res, next) {

    let query = {
      'sync.token': req.body.token
    }

    Hardware.findOne(query).exec((err, hardware) => {

      if (!hardware || !hardware.property) {
        return res.status(200);
      }



      Property.findOneAndUpdate(
        { _id: hardware.property },
        { $set: { lastPing: new Date().getTime(), lastIp: req.headers['x-real-ip'] } },
        { upsert: false }).exec(function (err, property) {

          if (hardware.sync.mode !== 'poll') {
            return res.status(200).end()
          }
          if (!property || !property.session || !property.session.id || err) {
            return res.json({ url: null });
          }

          if (property.dropinPing == null || (property.dropinPing &lt; new Date().getTime() - 1000 * 60)) {
            return res.json({ url: null });
          }
          let url = videoServerUrl + property.session.id + '/name/' + 'tablet'

          return res.json({ url: url });
        })

    });
  });

/**
 * Sends push notification.
 * 
 * @function sendPN
 * @param {string} title - Notification title.
 * @param {string} body - Notification body.
 * @param {string} url - Notification URL.
 * @param {string} token - Device token.
 */
function sendPN(title, body, url, token) {
  var http = require("https");

  var cleanedToken = token.split('?token=').pop();
  var options = {
    "method": "POST",
    "hostname": "fcm.googleapis.com",
    "port": null,
    "path": "/fcm/send",
    "headers": {
      "content-type": "application/json",
      "authorization": "key=AAAAZBTpHuc:APA91bGxYLxEZiScQFR9bq95HzSLLwXGU4i7JZVdkL25rRkWp0OO2kIGR-fLaOfOqzhuwNQFxr-q4F5ljQnDnvRNzWAzLg93ecnPkKuWPmZPPZ0NMzq0XnzQ74itd7iSTFwu-nwaAZjj",
      "cache-control": "no-cache"
    }
  };

  var req = http.request(options, function (res) {
    var chunks = [];

    res.on("data", function (chunk) {
      chunks.push(chunk);
    });

    res.on("end", function () {
      var body = Buffer.concat(chunks);
      console.log(body.toString());
    });
  });

  req.write(JSON.stringify({
    to: cleanedToken,
    notification: { title: title, body: body },
    click_action: 'OPEN_ACTIVITY_1',
    data: { url: url }
  }));
  req.end();
}

// ---------------------------------------- RAHMAN TEST ROUTS ----------------------------------------//

//used in react app camera page and react app property details page
router.get('/:id/stream/testing', authMiddleware, async function (req, res, next) {
  let query = { user: req.user._id, category: 'camera', _id: req.params.id };

  if (req.user.orgs) {
    query.user = req.user.orgs;
  }

  if (req.user.role == 'admin') {
    delete query.user;
  }

  try {
    const camera = await Hardware.findOne(query).populate('kit').exec();

    // Find the corresponding kit and populate its property
    const kit = await Kit.findOne({ hardware: { $in: camera._id } }).populate('property', '-primaryImage').exec();

    if (!camera || !kit) {
      return res.status(404).end();
    }

    // const property = kit.property || camera.property;

    // Get the Kinesis streaming URL using the camera name
    let url = '';
    const kinesisUrl = await getKinesesStreamingUrl(camera.name);

    url = kinesisUrl;

    console.log("camera name: ", camera.name);
    console.log("url: ", url);

    res.json({ url: url });
  } catch (error) {
    console.log(error);
    res.status(500).json({ error: 'An error occurred' });
  }
});


//used in react app camera page only. For react app property details page, a simmillar function is implimented in property.js under controllers
router.get('/list/cameras/stream/start',
  authMiddleware, async function (req, res, next) {

    let query = { user: req.user._id, 'status': 'active', 'category': 'camera' };

    if (req.user.orgs) {
      query.user = req.user.orgs;
    }
    try {
      const hardware = await Hardware.find(query)
        .populate('kit')
        .populate('property')
        .exec();

      if (!hardware || hardware.length == 0) {
        return res.json(hardware);
      }

      if (hardware.length === 1) {
        console.log("hardware.length === 1");
        //Extract the device IDs from the hardware since all cameras in this kit has the same device id
        const deviceId = hardware[0].kit.device_id;
        console.log("deviceId: ", deviceId);

        // We call the AWS API Gateway and request to start camera streams
        await triggerCameraStreams(deviceId);
      }

      if (hardware.length > 1) {
        // create an array of device IDs and remove duplicates
        const deviceIds = [...new Set(hardware.map(item => item.kit.device_id))];
        console.log("deviceIds: ", deviceIds);

        //trigger camera streams for each device ID
        await Promise.all(deviceIds.map(async function (deviceId) {
          await triggerCameraStreams(deviceId);
        }));
      }

      res.json(hardware);
    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'An error occurred' });
    }

  });

//Not used, this route is used as a test only
router.get('/list/cameras/test', authMiddleware, async function (req, res, next) {
  let query = { user: req.user._id, 'status': 'active', 'category': 'camera' };

  if (req.user.orgs) {
    query.user = req.user.orgs;
  }

  let Query = Hardware.find(query);

  try {
    let hardware = await Query.populate('kit').populate('property').exec();

    let obj = [...hardware];

    await Promise.all(obj.map(async function (item) {
      const name = item.name;
      try {
        const url = await getKinesesStreamingUrl(name);
        // Adding the "url" key to the item
        item.url = url;
      } catch (e) {
        console.log(e);
        // Setting the error message as the url value
        // item.url = "Not found"; 
      }
    }));

    const response = obj.map(item => ({
      ...item._doc,
      // Include the "url" key in the response array either error or valid url
      url: item.url
    }));

    res.json(response);
    console.log(response);
  } catch (e) {
    console.log(e);
    res.status(500).json({ error: 'An error occurred' });
  }
});

// this route is used to fetch stored media from AWS Kinisis

router.post('/list/cameras/stream/storedMedia',
  authMiddleware,
  async function (req, res, next) {

    console.log('Request Body:', req.body);
    // get startTimestamp and endTimestamp from the request body
    const { startTimestamp, endTimestamp } = req.body;

    // Check if startTimestamp and endTimestamp are valid date strings
    console.log('Start Timestamp from route:', startTimestamp);
    console.log('End Timestamp from route:', endTimestamp);

    let query = { user: req.user._id, 'status': 'active', 'category': 'camera' };



    if (req.user.orgs) {
      query.user = req.user.orgs;
    }

    try {
      const hardware = await Hardware.find(query)
        .populate('kit')
        .populate('property')
        .exec();

      const mergedData = {};

      const mediaPromises = hardware.map(async (camera) => {
        const media = await getStoredHLS(camera.name, startTimestamp, endTimestamp);

        const idString = camera.kit._id.toString();
        if (!mergedData[idString]) {
          mergedData[idString] = {
            _id: camera.kit._id,
            kit: camera.kit.name,
            recordings: []
          };
        }

        mergedData[idString].recordings.push({ [camera.name]: media });
      });

      await Promise.all(mediaPromises);

      const mergedArray = Object.values(mergedData);

      console.log("merged data: ", mergedArray);

      res.json(mergedArray);

    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'An error occurred' });
    }
  });

// ---------------------------------------- RAHMAN TEST ROUTS ----------------------------------------//

module.exports = router;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 16:15:44 GMT-0700 (北美太平洋夏令时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
