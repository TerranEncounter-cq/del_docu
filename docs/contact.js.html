<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>contact.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Controller_Schedule.html">Controller/Schedule</a><ul class='methods'><li data-type='method'><a href="module-Controller_Schedule.html#~calibrateTimezone">calibrateTimezone</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupCVWaitList">cleanupCVWaitList</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupDropin">cleanupDropin</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~downloadIDImages">downloadIDImages</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~followUp">followUp</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~generateInvoices">generateInvoices</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~scheduleNextRun">scheduleNextRun</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendNotifications">sendNotifications</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-Controller_authentication.html">Controller/authentication</a></li><li><a href="module-Controller_button.html">Controller/button</a><ul class='methods'><li data-type='method'><a href="module-Controller_button.html#~statusButoon">statusButoon</a></li></ul></li><li><a href="module-Controller_camera.html">Controller/camera</a><ul class='methods'><li data-type='method'><a href="module-Controller_camera.html#~countRecords">countRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~createCameraZone">createCameraZone</a></li><li data-type='method'><a href="module-Controller_camera.html#~createNewCamera">createNewCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~editCamera">editCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~enableCamera">enableCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~generateStreamURL">generateStreamURL</a></li><li data-type='method'><a href="module-Controller_camera.html#~getKinesesStreamingUrl">getKinesesStreamingUrl</a></li><li data-type='method'><a href="module-Controller_camera.html#~getNextMonitorId">getNextMonitorId</a></li><li data-type='method'><a href="module-Controller_camera.html#~getRecords">getRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~getToken">getToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~pad">pad</a></li><li data-type='method'><a href="module-Controller_camera.html#~refreshToken">refreshToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~reloadCameraStreams">reloadCameraStreams</a></li><li data-type='method'><a href="module-Controller_camera.html#~removeCamera">removeCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~triggerCameraStreams">triggerCameraStreams</a></li></ul></li><li><a href="module-Controller_contact.html">Controller/contact</a><ul class='methods'><li data-type='method'><a href="module-Controller_contact.html#~convertJsonToCsv">convertJsonToCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~getById">getById</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContact">getContact</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContactSub">getContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~getUpdate">getUpdate</a></li><li data-type='method'><a href="module-Controller_contact.html#~toCsv">toCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~updateContactSub">updateContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~validateIdLoad">validateIdLoad</a></li></ul></li><li><a href="module-Controller_dashboard.html">Controller/dashboard</a><ul class='methods'><li data-type='method'><a href="module-Controller_dashboard.html#~getDashboardStats">getDashboardStats</a></li></ul></li><li><a href="module-Controller_invoices.html">Controller/invoices</a><ul class='methods'><li data-type='method'><a href="module-Controller_invoices.html#~createInvoice">createInvoice</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoices">viewInvoices</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesById">viewInvoicesById</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesByUser">viewInvoicesByUser</a></li></ul></li><li><a href="module-Controller_keypad.html">Controller/keypad</a><ul class='methods'><li data-type='method'><a href="module-Controller_keypad.html#~createPasscode">createPasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~deletePasscode">deletePasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~listPasscodes">listPasscodes</a></li></ul></li><li><a href="module-Controller_lock_august_index.html">Controller/lock/august/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~lockStatus">lockStatus</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_lock_august_token.html">Controller/lock/august/token</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_token.html#~confirm">confirm</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~session">session</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~validate">validate</a></li></ul></li><li><a href="module-Controller_lock_index.html">Controller/lock/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_index.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getStatus">getStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~sendCommand">sendCommand</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~toggleLock">toggleLock</a></li></ul></li><li><a href="module-Controller_lock_switchbot.html">Controller/lock/switchbot</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_meeting.html">Controller/meeting</a><ul class='methods'><li data-type='method'><a href="module-Controller_meeting.html#~meetingStats">meetingStats</a></li><li data-type='method'><a href="module-Controller_meeting.html#~sendTempCommand">sendTempCommand</a></li></ul></li><li><a href="module-Controller_notification.html">Controller/notification</a><ul class='methods'><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationEmail">sendConfirmationEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationSMS">sendConfirmationSMS</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendEmail">sendEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendSms">sendSms</a></li></ul></li><li><a href="module-Controller_order.html">Controller/order</a><ul class='methods'><li data-type='method'><a href="module-Controller_order.html#~createAndNotify">createAndNotify</a></li><li data-type='method'><a href="module-Controller_order.html#~formatOrderDetails">formatOrderDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~formatUserDetails">formatUserDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~updateAndNotify">updateAndNotify</a></li></ul></li><li><a href="module-Controller_property.html">Controller/property</a><ul class='methods'><li data-type='method'><a href="module-Controller_property.html#~assignPropertyToUser">assignPropertyToUser</a></li><li data-type='method'><a href="module-Controller_property.html#~calcAvailability">calcAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~calcMonthAvailability">calcMonthAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~cloneProperty">cloneProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~getSinglePublicProperty">getSinglePublicProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~makeBook">makeBook</a></li><li data-type='method'><a href="module-Controller_property.html#~newProperty">newProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesPublic">propertiesPublic</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesUser">propertiesUser</a></li><li data-type='method'><a href="module-Controller_property.html#~property">property</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyAssignList">propertyAssignList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyList">propertyList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyListCustomSearch">propertyListCustomSearch</a></li><li data-type='method'><a href="module-Controller_property.html#~updateProperty">updateProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~updatePropertyKit">updatePropertyKit</a></li></ul></li><li><a href="module-Controller_shipment.html">Controller/shipment</a><ul class='methods'><li data-type='method'><a href="module-Controller_shipment.html#~formattedShipment">formattedShipment</a></li><li data-type='method'><a href="module-Controller_shipment.html#~sendShipmentNotification">sendShipmentNotification</a></li></ul></li><li><a href="module-Controller_transactions.html">Controller/transactions</a><ul class='methods'><li data-type='method'><a href="module-Controller_transactions.html#~createTransaction">createTransaction</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByHardware">viewTransactionByHardware</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionById">viewTransactionById</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByProperty">viewTransactionByProperty</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactions">viewTransactions</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">contact.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Handles contact-related operations.
 * @module Controller/contact
 */
const IDAnalyzer = require('idanalyzer')
const ObjectId = require('mongoose').Types.ObjectId
const Contact = require('../models/contact')
const eventEmitter = require('../events/emitter')
const Meeting = require("../models/meeting");
const { ROWS_PER_PAGE } = require('../constants/index');
const { default: mongoose } = require('mongoose');
const { parse } = require('json2csv')
const moment = require('moment');

/**
 * Converts a JSON array to CSV format.
 * @param {Object[]} jsonData - The JSON data to be converted.
 * @returns {string} - The CSV string.
 */
function convertJsonToCsv(jsonData) {
  try {
    const csv = parse(jsonData);
    return csv;
  } catch (err) {
    console.error('Error converting JSON to CSV:', err);
    throw err;
  }
}

/**
 * Fetches a contact by ID and populates its meetings and related property details.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 * @param {Function} next - The next middleware function.
 */
const getById = async (req, res, next) => {

  try {
    let contact = await Contact.findOne({ _id: req.params.id })
      .populate({
        path: 'meetings',
        populate: {
          path: 'property',
          model: 'Property',
          select: 'primaryImage address'
        }
      })
      .lean();
    res.status(200).json(contact);
  } catch (error) {
    res.status(500).send(error.message);
  }
};

/**
 * Retrieves contacts based on query parameters, with pagination and filtering options.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 * @param {Function} next - The next middleware function.
 */
const getContact = async (req, res, next) => {
  const { propertyIds, startDate, endDate } = req.query;
  const pageNumber = req.query.page ? parseInt(req.query.page) : 1;
  const ROWS_PAGE_LIMIT = req.query.pageLimit ? parseInt(req.query.pageLimit) : ROWS_PER_PAGE;

  let query = {
    'user': req.user._id,
  }

  if (req.user.orgs) {
    query.user = req.user.orgs
  }

  if (req.params.id &amp;&amp; ObjectId.isValid(req.params.id)) {
    query._id = req.params.id
  }

  let order = 'desc'
  if (req.query.order) {
    order = req.query.order
  }

  let meetingQuery = {
    $or: [
      { user: req.user._id },
      { allowedAgents: req.user._id }
    ]
  };

  if (propertyIds) {
    meetingQuery.property = { $in: propertyIds.split(',') };
  }

  if (startDate || endDate) {
    let dateConditions = [];

    if (startDate &amp;&amp; endDate) {
      dateConditions.push({
        startTime: {
          $gte: moment(startDate, 'YYYY-MM-DD').startOf('day').toDate(),
          $lte: moment(endDate, 'YYYY-MM-DD').endOf('day').toDate()
        }
      });
    } else if (startDate) {
      dateConditions.push({
        startTime: {
          $gte: moment(startDate, 'YYYY-MM-DD').startOf('day').toDate()
        }
      });
    } else if (endDate) {
      dateConditions.push({
        startTime: {
          $lte: moment(endDate, 'YYYY-MM-DD').endOf('day').toDate()
        }
      });
    }
    meetingQuery.$or = dateConditions;
  }

  try {
    let meetings = await Meeting.find(meetingQuery)
      .populate({
        path: 'contact',
        select: 'firstName lastName phone email idImage'
      })
      .populate({
        path: 'property',
        select: 'address primaryImage unit'
      })
      .sort({ createdDate: order })
      .skip((pageNumber - 1) * ROWS_PAGE_LIMIT)
      .limit(ROWS_PAGE_LIMIT)
      .lean();

    const contactsCount = await Meeting.count(meetingQuery);
    const totalPages = Math.ceil(contactsCount / ROWS_PAGE_LIMIT);



    if (req.params.id) {
      res.status(200).json(meetings[0]);
    } else {
      res.status(200).json({
        total: contactsCount,
        pages: totalPages,
        rowPerPage: ROWS_PAGE_LIMIT,
        data: meetings
      });
    }
  } catch (error) {
    res.status(500).send(error.message);
  }
};
/**
 * Generates a CSV file from meeting data and sends it as a response.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 * @param {Function} next - The next middleware function.
 */
const toCsv = async (req, res, next) => {
  const { searchTerm, propertyIds, startDate, endDate } = req.query;
  const userId = req.user._id;

  try {
    let meetingQuery = {
      $or: [
        { user: userId },
        { allowedAgents: userId }
      ]
    };
    if (propertyIds) {
      meetingQuery.property = { $in: propertyIds.split(',') };
    }

    if (startDate || endDate) {
      let dateConditions = [];

      if (startDate &amp;&amp; endDate) {
        dateConditions.push({
          startTime: {
            $gte: moment(startDate, 'YYYY-MM-DD').startOf('day').toDate(),
            $lte: moment(endDate, 'YYYY-MM-DD').endOf('day').toDate()
          }
        });
      } else if (startDate) {
        dateConditions.push({
          startTime: {
            $gte: moment(startDate, 'YYYY-MM-DD').startOf('day').toDate()
          }
        });
      } else if (endDate) {
        dateConditions.push({
          startTime: {
            $lte: moment(endDate, 'YYYY-MM-DD').endOf('day').toDate()
          }
        });
      }

      meetingQuery.$or = dateConditions;
    }

    try {
      const meetings = await Meeting.find(meetingQuery)
        .populate({
          path: 'contact',
          match: searchTerm ? {
            $or: [
              { firstName: { $regex: searchTerm, $options: 'i' } },
              { lastName: { $regex: searchTerm, $options: 'i' } },
              { phone: { $regex: searchTerm, $options: 'i' } },
              { email: { $regex: searchTerm, $options: 'i' } },
            ]
          } : {},
          select: 'firstName lastName phone email idImage'
        })
        .populate({
          path: 'property',
          select: 'address'
        })

      const formattedContacts = meetings
        .filter(meeting => meeting.contact &amp;&amp; meeting.property)
        .map(meeting => ({
          "First Name": meeting.contact.firstName,
          "Last Name": meeting.contact.lastName,
          "Email": meeting.contact.email,
          "Phone": meeting.contact.phone,
          "ID Image": "https://s3.us-east-2.amazonaws.com/delet.ai" + meeting.contact.idImage,
          "Created Date": new Date(meeting.startTime),
          "Address": meeting.property.address,
        }));

      const csv = convertJsonToCsv(formattedContacts);
      const filename = 'contacts.csv';

      res.header('Content-Type', 'text/csv');
      res.attachment(filename);
      res.status(200).send(csv);
    } catch (err) {
      console.error('Error generating CSV:', err);
      res.status(500).send('An error occurred while generating the CSV file.');
    }
  } catch (error) {
    res.status(500).send(error.message);
  }
};

/**
 * Retrieves the subscription information of a contact by ID.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 */
const getContactSub = (req, res) => {

  if (!req.params.id || !ObjectId.isValid(req.params.id)) {
    return res.status(400).json({ message: "Invalid ID" });
  }

  Contact.findById(req.params.id, { subscription: 1 }, (err, contact) => {
    if (err) {
      console.log(err);
      res.status(500).json({ message: 'Error Getting Contact' })
    } else if (contact) {
      res.status(200).json(contact)
    } else {
      res.status(404).json({ message: 'Contact Not Found' })
    }
  });
}

/**
 * Updates the subscription information of a contact by ID.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 */
const updateContactSub = (req, res) => {
  if (!req.params.id || !ObjectId.isValid(req.params.id)) {
    res.status(400).json({ message: "Invalid ID" });
  } else {
    Contact.findOneAndUpdate({ _id: req.params.id }, { subscription: req.body.subscription }, { new: true, fields: { subscription: 1 } }, (err, contact) => {
      if (err) {
        console.log(err);
        res.status(500).json({ message: 'Error Getting Contact' })
      } else if (contact) {
        res.status(200).json({ title: 'Success', message: 'Subscription Changed', body: contact })
      } else {
        res.status(404).json({ message: 'Contact Not Found' })
      }
    });
  }
}

/**
 * Validates and loads an ID using IDAnalyzer, then sends the response.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 * @param {Function} next - The next middleware function.
 */
const validateIdLoad = async (req, res, next) => {
  let DocuPass = new IDAnalyzer.DocuPass(
    process.env.IDAnalyzer_API,
    'Delet Inc.',
    'US',
  )

  // DocuPass params
  DocuPass.enableAuthentication(true, 'quick', 0.3)
  DocuPass.enableFaceVerification(true, 1, 0.5)
  DocuPass.setCallbackURL(process.env.IDAnalyzer_callback_URL)
  DocuPass.verifyExpiry(true)
  DocuPass.setMaxAttempt(3)

  DocuPass.createIframe()
    .then((response) => {
      eventEmitter.emit('CVWaitList', {
        reference: response.reference,
        verified: false,
        expireDate: (Number(new Date()) + (30 * 60 * 1000)) // expires in 30 minutes
      })
      res.status(200).send(response)
    })
    .catch((err) => {
      console.log(err)
      res.status(500).send(err)
    })
}

/**
 * Updates contact information by ID.
 * @param {Object} req - The request object.
 * @param {Object} res - The response object.
 */
const getUpdate = (req, res) => {
  if (!req.body) {
    return res.status(400).send({
      message: 'Data to update can not be empty!',
    })
  }

  const id = req.params.id

  Contact.findByIdAndUpdate(id, req.body, { useFindAndModify: false })
    .then((data) => {
      if (!data) {
        res.status(404).send({
          message: `Cannot update  `,
        })
      } else res.send({ message: 'updated successfully.' })
    })
    .catch((err) => {
      res.status(500).send({
        message: 'Error updating',
      })
    })
}


module.exports = { getContact, getContactSub, validateIdLoad, getUpdate, updateContactSub, toCsv, getById }</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 12:27:25 GMT-0700 (北美太平洋夏令时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
