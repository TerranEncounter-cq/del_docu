<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>routes/meeting.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BadRequest.html">BadRequest</a></li><li><a href="Forbidden.html">Forbidden</a></li><li><a href="NotFound.html">NotFound</a></li><li><a href="Unauthorized.html">Unauthorized</a></li></ul><h3>Modules</h3><ul><li><a href="module-Controller_Schedule.html">Controller/Schedule</a><ul class='methods'><li data-type='method'><a href="module-Controller_Schedule.html#~calibrateTimezone">calibrateTimezone</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupCVWaitList">cleanupCVWaitList</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupDropin">cleanupDropin</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~downloadIDImages">downloadIDImages</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~followUp">followUp</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~generateInvoices">generateInvoices</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~scheduleNextRun">scheduleNextRun</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendNotifications">sendNotifications</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-Controller_authentication.html">Controller/authentication</a></li><li><a href="module-Controller_button.html">Controller/button</a><ul class='methods'><li data-type='method'><a href="module-Controller_button.html#~statusButoon">statusButoon</a></li></ul></li><li><a href="module-Controller_camera.html">Controller/camera</a><ul class='methods'><li data-type='method'><a href="module-Controller_camera.html#~countRecords">countRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~createCameraZone">createCameraZone</a></li><li data-type='method'><a href="module-Controller_camera.html#~createNewCamera">createNewCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~editCamera">editCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~enableCamera">enableCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~generateStreamURL">generateStreamURL</a></li><li data-type='method'><a href="module-Controller_camera.html#~getKinesesStreamingUrl">getKinesesStreamingUrl</a></li><li data-type='method'><a href="module-Controller_camera.html#~getNextMonitorId">getNextMonitorId</a></li><li data-type='method'><a href="module-Controller_camera.html#~getRecords">getRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~getToken">getToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~pad">pad</a></li><li data-type='method'><a href="module-Controller_camera.html#~refreshToken">refreshToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~reloadCameraStreams">reloadCameraStreams</a></li><li data-type='method'><a href="module-Controller_camera.html#~removeCamera">removeCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~triggerCameraStreams">triggerCameraStreams</a></li></ul></li><li><a href="module-Controller_contact.html">Controller/contact</a><ul class='methods'><li data-type='method'><a href="module-Controller_contact.html#~convertJsonToCsv">convertJsonToCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~getById">getById</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContact">getContact</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContactSub">getContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~getUpdate">getUpdate</a></li><li data-type='method'><a href="module-Controller_contact.html#~toCsv">toCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~updateContactSub">updateContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~validateIdLoad">validateIdLoad</a></li></ul></li><li><a href="module-Controller_dashboard.html">Controller/dashboard</a><ul class='methods'><li data-type='method'><a href="module-Controller_dashboard.html#~getDashboardStats">getDashboardStats</a></li></ul></li><li><a href="module-Controller_invoices.html">Controller/invoices</a><ul class='methods'><li data-type='method'><a href="module-Controller_invoices.html#~createInvoice">createInvoice</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoices">viewInvoices</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesById">viewInvoicesById</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesByUser">viewInvoicesByUser</a></li></ul></li><li><a href="module-Controller_keypad.html">Controller/keypad</a><ul class='methods'><li data-type='method'><a href="module-Controller_keypad.html#~createPasscode">createPasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~deletePasscode">deletePasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~listPasscodes">listPasscodes</a></li></ul></li><li><a href="module-Controller_lock_august_index.html">Controller/lock/august/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~lockStatus">lockStatus</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_lock_august_token.html">Controller/lock/august/token</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_token.html#~confirm">confirm</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~session">session</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~validate">validate</a></li></ul></li><li><a href="module-Controller_lock_index.html">Controller/lock/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_index.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getStatus">getStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~sendCommand">sendCommand</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~toggleLock">toggleLock</a></li></ul></li><li><a href="module-Controller_lock_switchbot.html">Controller/lock/switchbot</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_meeting.html">Controller/meeting</a><ul class='methods'><li data-type='method'><a href="module-Controller_meeting.html#~meetingStats">meetingStats</a></li><li data-type='method'><a href="module-Controller_meeting.html#~sendTempCommand">sendTempCommand</a></li></ul></li><li><a href="module-Controller_notification.html">Controller/notification</a><ul class='methods'><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationEmail">sendConfirmationEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationSMS">sendConfirmationSMS</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendEmail">sendEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendSms">sendSms</a></li></ul></li><li><a href="module-Controller_order.html">Controller/order</a><ul class='methods'><li data-type='method'><a href="module-Controller_order.html#~createAndNotify">createAndNotify</a></li><li data-type='method'><a href="module-Controller_order.html#~formatOrderDetails">formatOrderDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~formatUserDetails">formatUserDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~updateAndNotify">updateAndNotify</a></li></ul></li><li><a href="module-Controller_property.html">Controller/property</a><ul class='methods'><li data-type='method'><a href="module-Controller_property.html#~assignPropertyToUser">assignPropertyToUser</a></li><li data-type='method'><a href="module-Controller_property.html#~calcAvailability">calcAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~calcMonthAvailability">calcMonthAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~cloneProperty">cloneProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~getSinglePublicProperty">getSinglePublicProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~makeBook">makeBook</a></li><li data-type='method'><a href="module-Controller_property.html#~newProperty">newProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesPublic">propertiesPublic</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesUser">propertiesUser</a></li><li data-type='method'><a href="module-Controller_property.html#~property">property</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyAssignList">propertyAssignList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyList">propertyList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyListCustomSearch">propertyListCustomSearch</a></li><li data-type='method'><a href="module-Controller_property.html#~updateProperty">updateProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~updatePropertyKit">updatePropertyKit</a></li></ul></li><li><a href="module-Controller_shipment.html">Controller/shipment</a><ul class='methods'><li data-type='method'><a href="module-Controller_shipment.html#~formattedShipment">formattedShipment</a></li><li data-type='method'><a href="module-Controller_shipment.html#~sendShipmentNotification">sendShipmentNotification</a></li></ul></li><li><a href="module-Controller_transactions.html">Controller/transactions</a><ul class='methods'><li data-type='method'><a href="module-Controller_transactions.html#~createTransaction">createTransaction</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByHardware">viewTransactionByHardware</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionById">viewTransactionById</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByProperty">viewTransactionByProperty</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactions">viewTransactions</a></li></ul></li><li><a href="module-constants_cognito.html">constants/cognito</a></li><li><a href="module-constants_index.html">constants/index</a></li><li><a href="module-controllers_notifications.html">controllers/notifications</a><ul class='methods'><li data-type='method'><a href="module-controllers_notifications.html#~sendInstructions">sendInstructions</a></li><li data-type='method'><a href="module-controllers_notifications.html#~sendReminder">sendReminder</a></li></ul></li><li><a href="module-controllers_property.html">controllers/property</a><ul class='methods'><li data-type='method'><a href="module-controllers_property.html#~associateKit">associateKit</a></li></ul></li><li><a href="module-events_emitter.html">events/emitter</a></li><li><a href="module-helpers_account.html">helpers/account</a><ul class='methods'><li data-type='method'><a href="module-helpers_account.html#~addHardware">addHardware</a></li><li data-type='method'><a href="module-helpers_account.html#~addSwitchBotHardware">addSwitchBotHardware</a></li></ul></li><li><a href="module-helpers_aws-s3.html">helpers/aws-s3</a><ul class='methods'><li data-type='method'><a href="module-helpers_aws-s3.html#.getFileExtensionFromBase64">getFileExtensionFromBase64</a></li><li data-type='method'><a href="module-helpers_aws-s3.html#.uploadS3">uploadS3</a></li></ul></li><li><a href="module-helpers_button.html">helpers/button</a><ul class='methods'><li data-type='method'><a href="module-helpers_button.html#~actuateButton">actuateButton</a></li></ul></li><li><a href="module-helpers_calendar.html">helpers/calendar</a><ul class='methods'><li data-type='method'><a href="module-helpers_calendar.html#~dateTimeForCalander">dateTimeForCalander</a></li><li data-type='method'><a href="module-helpers_calendar.html#~deleteEvent">deleteEvent</a></li><li data-type='method'><a href="module-helpers_calendar.html#~getEvents">getEvents</a></li><li data-type='method'><a href="module-helpers_calendar.html#~insertEvent">insertEvent</a></li></ul></li><li><a href="module-helpers_camera.html">helpers/camera</a><ul class='methods'><li data-type='method'><a href="module-helpers_camera.html#~streamToBuffer">streamToBuffer</a></li></ul></li><li><a href="module-helpers_cognito.html">helpers/cognito</a><ul class='methods'><li data-type='method'><a href="module-helpers_cognito.html#~assignUserToGroup">assignUserToGroup</a></li><li data-type='method'><a href="module-helpers_cognito.html#~cognitoSignUp">cognitoSignUp</a></li><li data-type='method'><a href="module-helpers_cognito.html#~deleteUserFromCognito">deleteUserFromCognito</a></li><li data-type='method'><a href="module-helpers_cognito.html#~getSingleCognitoUser">getSingleCognitoUser</a></li><li data-type='method'><a href="module-helpers_cognito.html#~setPermanentUserPassword">setPermanentUserPassword</a></li><li data-type='method'><a href="module-helpers_cognito.html#~signInCognito">signInCognito</a></li><li data-type='method'><a href="module-helpers_cognito.html#~verifyHeaders">verifyHeaders</a></li><li data-type='method'><a href="module-helpers_cognito.html#~verifyToken">verifyToken</a></li></ul></li><li><a href="module-helpers_emailGeneration.html">helpers/emailGeneration</a><ul class='methods'><li data-type='method'><a href="module-helpers_emailGeneration.html#~formatDateToGoogleCalendar">formatDateToGoogleCalendar</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~formattingTime">formattingTime</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateBookingConfirmationEmail">generateBookingConfirmationEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateGoogleCalendarUrl">generateGoogleCalendarUrl</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateInstructionsEmail">generateInstructionsEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateReminderEmail">generateReminderEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~insertInEmailLayout">insertInEmailLayout</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~urlEncode">urlEncode</a></li></ul></li><li><a href="module-helpers_keypad.html">helpers/keypad</a><ul class='methods'><li data-type='method'><a href="module-helpers_keypad.html#~passcodeList">passcodeList</a></li></ul></li><li><a href="module-helpers_kit.html">helpers/kit</a><ul class='methods'><li data-type='method'><a href="module-helpers_kit.html#~associateHardware">associateHardware</a></li><li data-type='method'><a href="module-helpers_kit.html#~closeKitToUser">closeKitToUser</a></li><li data-type='method'><a href="module-helpers_kit.html#~registerKitToUser">registerKitToUser</a></li></ul></li><li><a href="module-helpers_switchbot.html">helpers/switchbot</a><ul class='methods'><li data-type='method'><a href="module-helpers_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-helpers_utilities.html">helpers/utilities</a><ul class='methods'><li data-type='method'><a href="module-helpers_utilities.html#~downloadImage">downloadImage</a></li><li data-type='method'><a href="module-helpers_utilities.html#~relativeTimeConversion">relativeTimeConversion</a></li><li data-type='method'><a href="module-helpers_utilities.html#~splitTags">splitTags</a></li></ul></li><li><a href="module-middleware_adminRole.html">middleware/adminRole</a><ul class='methods'><li data-type='method'><a href="module-middleware_adminRole.html#~adminRole">adminRole</a></li></ul></li><li><a href="module-middleware_authMiddleware.html">middleware/authMiddleware</a><ul class='methods'><li data-type='method'><a href="module-middleware_authMiddleware.html#~authMiddleware">authMiddleware</a></li></ul></li><li><a href="module-middleware_errorHandler.html">middleware/errorHandler</a><ul class='methods'><li data-type='method'><a href="module-middleware_errorHandler.html#~errorHandler">errorHandler</a></li></ul></li><li><a href="module-models_account.html">models/account</a></li><li><a href="module-models_action.html">models/action</a></li><li><a href="module-models_building.html">models/building</a></li><li><a href="module-models_confirmationCode.html">models/confirmationCode</a></li><li><a href="module-models_contact.html">models/contact</a></li><li><a href="module-models_discount.html">models/discount</a></li><li><a href="module-models_hardware.html">models/hardware</a></li><li><a href="module-models_invoice.html">models/invoice</a></li><li><a href="module-models_invoiceInfo.html">models/invoiceInfo</a></li><li><a href="module-models_kit.html">models/kit</a></li><li><a href="module-models_meeting.html">models/meeting</a></li><li><a href="module-models_order.html">models/order</a></li><li><a href="module-models_paymentMethod.html">models/paymentMethod</a></li><li><a href="module-models_product.html">models/product</a></li><li><a href="module-models_property.html">models/property</a></li><li><a href="module-models_settings.html">models/settings</a></li><li><a href="module-models_shipment.html">models/shipment</a></li><li><a href="module-models_subscription.html">models/subscription</a></li><li><a href="module-models_transaction.html">models/transaction</a></li><li><a href="module-models_user.html">models/user</a></li><li><a href="module-routes_account.html">routes/account</a></li><li><a href="module-routes_agents.html">routes/agents</a></li><li><a href="module-routes_button.html">routes/button</a></li><li><a href="module-routes_camera.html">routes/camera</a></li><li><a href="module-routes_contact.html">routes/contact</a><ul class='methods'><li data-type='method'><a href="module-routes_contact.html#.get/">get/</a></li><li data-type='method'><a href="module-routes_contact.html#.get/:id?">get/:id?</a></li><li data-type='method'><a href="module-routes_contact.html#.get/toCsv">get/toCsv</a></li><li data-type='method'><a href="module-routes_contact.html#.post/validateid/load">post/validateid/load</a></li><li data-type='method'><a href="module-routes_contact.html#.put/update/:id?">put/update/:id?</a></li><li data-type='method'><a href="module-routes_contact.html#.subscription/:id">subscription/:id</a></li></ul></li><li><a href="module-routes_contactVerified.html">routes/contactVerified</a></li><li><a href="module-routes_dashboard.html">routes/dashboard</a></li><li><a href="module-routes_discount.html">routes/discount</a><ul class='methods'><li data-type='method'><a href="module-routes_discount.html#.get/">get/</a></li><li data-type='method'><a href="module-routes_discount.html#.get/:code">get/:code</a></li><li data-type='method'><a href="module-routes_discount.html#.get/generate-code">get/generate-code</a></li><li data-type='method'><a href="module-routes_discount.html#.post/">post/</a></li></ul></li><li><a href="module-routes_documents.html">routes/documents</a></li><li><a href="module-routes_hardware.html">routes/hardware</a><ul class='methods'><li data-type='method'><a href="module-routes_hardware.html#.delete/:id">delete/:id</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id/admin/sync">get/:id/admin/sync</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id/stream">get/:id/stream</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id?">get/:id?</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/list/cameras">get/list/cameras</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/session/:property/:uid/agent">get/session/:property/:uid/agent</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/session/:property/:uid/manager">get/session/:property/:uid/manager</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/">post/</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/:id">post/:id</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/:id/stream/test">post/:id/stream/test</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/admin/buzzer">post/admin/buzzer</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/admin/sync">post/admin/sync</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/app/ping">post/app/ping</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/bulk">post/bulk</a></li><li data-type='method'><a href="module-routes_hardware.html#~generateStreamUrl">generateStreamUrl</a></li><li data-type='method'><a href="module-routes_hardware.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-routes_index.html">routes/index</a><ul class='methods'><li data-type='method'><a href="module-routes_index.html#.get/logout">get/logout</a></li><li data-type='method'><a href="module-routes_index.html#.use/admin">use/admin</a></li><li data-type='method'><a href="module-routes_index.html#.use/public">use/public</a></li><li data-type='method'><a href="module-routes_index.html#.use/public/images/contact">use/public/images/contact</a></li><li data-type='method'><a href="module-routes_index.html#.use/public/images/property">use/public/images/property</a></li></ul></li><li><a href="module-routes_invoice.html">routes/invoice</a></li><li><a href="module-routes_invoiceInfo.html">routes/invoiceInfo</a><ul class='methods'><li data-type='method'><a href="module-routes_invoiceInfo.html#.CreateInvoiceInfo">CreateInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.DeleteInvoiceInfo">DeleteInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.GetInvoiceInfo">GetInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.GetInvoiceInfoAdmin">GetInvoiceInfoAdmin</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.UpdateInvoiceInfo">UpdateInvoiceInfo</a></li></ul></li><li><a href="module-routes_keypad.html">routes/keypad</a><ul class='methods'><li data-type='method'><a href="module-routes_keypad.html#.PasscodeRoutes">PasscodeRoutes</a></li></ul></li><li><a href="module-routes_kit.html">routes/kit</a><ul class='methods'><li data-type='method'><a href="module-routes_kit.html#.ConfirmKit">ConfirmKit</a></li><li data-type='method'><a href="module-routes_kit.html#.CreateKit">CreateKit</a></li><li data-type='method'><a href="module-routes_kit.html#.DeleteKit">DeleteKit</a></li><li data-type='method'><a href="module-routes_kit.html#.GetAllKits">GetAllKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetKitById">GetKitById</a></li><li data-type='method'><a href="module-routes_kit.html#.GetOrderKits">GetOrderKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetOrderKits">GetOrderKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetUserKits">GetUserKits</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateKit">UpdateKit</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateKitState">UpdateKitState</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateMultipleKits">UpdateMultipleKits</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateShippingAddress">UpdateShippingAddress</a></li></ul></li><li><a href="module-routes_lock.html">routes/lock</a><ul class='methods'><li data-type='method'><a href="module-routes_lock.html#.ConfirmLockToken">ConfirmLockToken</a></li><li data-type='method'><a href="module-routes_lock.html#.GetLockLogs">GetLockLogs</a></li><li data-type='method'><a href="module-routes_lock.html#.GetLockStatus">GetLockStatus</a></li><li data-type='method'><a href="module-routes_lock.html#.SendLockCommand">SendLockCommand</a></li><li data-type='method'><a href="module-routes_lock.html#.StartLockTokenSession">StartLockTokenSession</a></li><li data-type='method'><a href="module-routes_lock.html#.ValidateLockToken">ValidateLockToken</a></li></ul></li><li><a href="module-routes_meeting.html">routes/meeting</a><ul class='methods'><li data-type='method'><a href="module-routes_meeting.html#.CancelMeeting">CancelMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.CreateMeeting">CreateMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.ExecuteTempLockCommand">ExecuteTempLockCommand</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetCancellationPage">GetCancellationPage</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetingDetails">GetMeetingDetails</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetingStats">GetMeetingStats</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetings">GetMeetings</a></li><li data-type='method'><a href="module-routes_meeting.html#.HandleMeetingAction">HandleMeetingAction</a></li><li data-type='method'><a href="module-routes_meeting.html#.HandleMeetingCancellation">HandleMeetingCancellation</a></li><li data-type='method'><a href="module-routes_meeting.html#.RescheduleMeeting">RescheduleMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.RetrieveMeetings">RetrieveMeetings</a></li><li data-type='method'><a href="module-routes_meeting.html#.UpdateMeeting">UpdateMeeting</a></li></ul></li><li><a href="module-routes_notification.html">routes/notification</a><ul class='methods'><li data-type='method'><a href="module-routes_notification.html#.SendConfirmationEmail">SendConfirmationEmail</a></li><li data-type='method'><a href="module-routes_notification.html#.SendConfirmationSMS">SendConfirmationSMS</a></li></ul></li><li><a href="module-routes_order.html">routes/order</a><ul class='methods'><li data-type='method'><a href="module-routes_order.html#.CreateOrder">CreateOrder</a></li><li data-type='method'><a href="module-routes_order.html#.DeleteAllOrders">DeleteAllOrders</a></li><li data-type='method'><a href="module-routes_order.html#.GetAllOrders">GetAllOrders</a></li><li data-type='method'><a href="module-routes_order.html#.GetOrderById">GetOrderById</a></li><li data-type='method'><a href="module-routes_order.html#.GetOrderItems">GetOrderItems</a></li><li data-type='method'><a href="module-routes_order.html#.GetSessionInfo">GetSessionInfo</a></li><li data-type='method'><a href="module-routes_order.html#.GetSubscriptionInfo">GetSubscriptionInfo</a></li><li data-type='method'><a href="module-routes_order.html#.GetUserOrders">GetUserOrders</a></li><li data-type='method'><a href="module-routes_order.html#.ListOrdersWithUserInfo">ListOrdersWithUserInfo</a></li><li data-type='method'><a href="module-routes_order.html#.UpdateOrderState">UpdateOrderState</a></li></ul></li><li><a href="module-routes_product.html">routes/product</a><ul class='methods'><li data-type='method'><a href="module-routes_product.html#.CreateProduct">CreateProduct</a></li><li data-type='method'><a href="module-routes_product.html#.GetProducts">GetProducts</a></li></ul></li><li><a href="module-routes_property.html">routes/property</a><ul class='methods'><li data-type='method'><a href="module-routes_property.html#.CustomSearchProperties">CustomSearchProperties</a></li><li data-type='method'><a href="module-routes_property.html#.GetPropertiesByUser">GetPropertiesByUser</a></li><li data-type='method'><a href="module-routes_property.html#.GetPropertyById">GetPropertyById</a></li><li data-type='method'><a href="module-routes_property.html#.ListAgentProperties">ListAgentProperties</a></li><li data-type='method'><a href="module-routes_property.html#.ListProperties">ListProperties</a></li><li data-type='method'><a href="module-routes_property.html#.PingProperty">PingProperty</a></li><li data-type='method'><a href="module-routes_property.html#.PingPropertySession">PingPropertySession</a></li><li data-type='method'><a href="module-routes_property.html#.PingPropertySessionById">PingPropertySessionById</a></li></ul></li><li><a href="module-routes_shipment.html">routes/shipment</a><ul class='methods'><li data-type='method'><a href="module-routes_shipment.html#.ConfirmShipmentDelivery">ConfirmShipmentDelivery</a></li><li data-type='method'><a href="module-routes_shipment.html#.CreateShipment">CreateShipment</a></li><li data-type='method'><a href="module-routes_shipment.html#.DeleteAllShipments">DeleteAllShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.GetShipmentById">GetShipmentById</a></li><li data-type='method'><a href="module-routes_shipment.html#.ListAllShipments">ListAllShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.ListUserShipments">ListUserShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.UpdateShipmentState">UpdateShipmentState</a></li></ul></li><li><a href="module-routes_subscription.html">routes/subscription</a><ul class='methods'><li data-type='method'><a href="module-routes_subscription.html#.CreateSubscription">CreateSubscription</a></li><li data-type='method'><a href="module-routes_subscription.html#.DeleteAllSubscriptions">DeleteAllSubscriptions</a></li><li data-type='method'><a href="module-routes_subscription.html#.EndTrial">EndTrial</a></li><li data-type='method'><a href="module-routes_subscription.html#.GetAllSubscriptions">GetAllSubscriptions</a></li><li data-type='method'><a href="module-routes_subscription.html#.GetSubscriptionByUserId">GetSubscriptionByUserId</a></li></ul></li><li><a href="module-routes_transactions.html">routes/transactions</a><ul class='methods'><li data-type='method'><a href="module-routes_transactions.html#.GetAllTransactions">GetAllTransactions</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionById">GetTransactionById</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionsByHardware">GetTransactionsByHardware</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionsByProperty">GetTransactionsByProperty</a></li></ul></li><li><a href="module-routes_users.html">routes/users</a><ul class='methods'><li data-type='method'><a href="module-routes_users.html#.CreateAdmin">CreateAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.CreateAgent">CreateAgent</a></li><li data-type='method'><a href="module-routes_users.html#.DeleteAdmin">DeleteAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.ForgotPassword">ForgotPassword</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdmin">GetAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdminAccountList">GetAdminAccountList</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdminList">GetAdminList</a></li><li data-type='method'><a href="module-routes_users.html#.GetOrgs">GetOrgs</a></li><li data-type='method'><a href="module-routes_users.html#.GetStripe">GetStripe</a></li><li data-type='method'><a href="module-routes_users.html#.GetTimezone">GetTimezone</a></li><li data-type='method'><a href="module-routes_users.html#.GetUser">GetUser</a></li><li data-type='method'><a href="module-routes_users.html#.Login">Login</a></li><li data-type='method'><a href="module-routes_users.html#.Logout">Logout</a></li><li data-type='method'><a href="module-routes_users.html#.Register">Register</a></li><li data-type='method'><a href="module-routes_users.html#.RequestCode">RequestCode</a></li><li data-type='method'><a href="module-routes_users.html#.ResetPassword">ResetPassword</a></li><li data-type='method'><a href="module-routes_users.html#.ResetUserPassword">ResetUserPassword</a></li><li data-type='method'><a href="module-routes_users.html#.SuperadminRegister">SuperadminRegister</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateAgent">UpdateAgent</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateProfile">UpdateProfile</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateSettings">UpdateSettings</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateUser">UpdateUser</a></li></ul></li><li><a href="module-routes_webhook.html">routes/webhook</a></li></ul><h3>Events</h3><ul><li><a href="module-routes_contactVerified.html#~event:CVWaitList">CVWaitList</a></li><li><a href="module-routes_contactVerified.html#~event:cleanupCVWaitList">cleanupCVWaitList</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">routes/meeting.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Meeting Routes Module
 * This module configures the Express routes for managing meetings, including creating, viewing, updating, and cancelling meetings.
 * It also facilitates interactions with related systems such as property locks during meetings to ensure secure and controlled access.
 * The routes handle a variety of operations such as filtering meetings based on date ranges, user permissions, and property associations,
 * as well as providing detailed views of meeting agendas and related operational details.
 *
 * @module routes/meeting
 */

const { v4: uuidv4 } = require('uuid');
const router = require('express').Router();
const ObjectId = require('mongoose').Types.ObjectId;
const dayjs = require('dayjs');
const utc = require('dayjs/plugin/utc');
const timezone = require('dayjs/plugin/timezone');
const moment = require('moment');
const calendar = require('./calendar');
const switchbotController = require('../helpers/switchbot');
const augustController = require('../controllers/lock/august');
const buttonController = require('../helpers/button');
const { createTransaction } = require('../controllers/transactions');
const notification = require('../controllers/notification');
const { meetingStats, sendTempCommand } = require('../controllers/meeting');
const Meeting = require('../models/meeting');
const Hardware = require('../models/hardware');
const { authMiddleware } = require('../middlewares/authMiddleware')
const { triggerCameraStreams } = require('../controllers/camera');

const fs = require('fs');
const path = require('path');

dayjs.extend(utc)
dayjs.extend(timezone)

/**
 * Retrieves a list of meetings based on specified filters such as date ranges, user access,
 * and property associations. Supports detailed queries for generating lists or calendar views of meetings.
 * 
 * @name GetMeetings
 * @function
 * @memberof module:routes/meeting
 * @param {string} id - The ID of the property to retrieve meetings for.
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express middleware next function.
 * @returns {Array} An array of meeting objects.
 */
router.get('/', authMiddleware, function (req, res, next) {

  let query = { $or: [
    { user: req.user._id },
    { allowedAgents: req.user._id  }
  ]};

  if (req.user.orgs) {
    query.user = req.user.orgs;
  }
  const now = dayjs();
  const startThisDay = now.startOf('day');
  const endThisDay = now.endOf('day');
  let start = Math.round(new Date().getTime() / 86400000) * 86400000;
  if (req.params.id &amp;&amp; ObjectId.isValid(req.params.id)) {
    query._id = req.params.id;
  } else {
    if (req.query.range) {
      if (req.query.range == 'max') {
        query.startTime = { $gt: start - 86400000 * 60, $lte: start + 86400000 * 180 };
      } else if (req.query.range == 'future') {
        query.startTime = { $gt: start };
      } else if (req.query.range == 'past') {
        query.startTime = { $lte: start };
      } else if (req.query.range == 'today') {
        query.startTime = { $gt: startThisDay.valueOf(), $lte: endThisDay.valueOf() };
      } else if (req.query.range == 'custom') {
        query.startTime = { $gte: new Date(req.query.startDate), $lte: new Date(req.query.endDate) };
      } else {
        if (req.query.range > 0) {
          query.startTime = { $gt: start - 86400000, $lte: start + req.query.range * 86400000 };
        } else {
          query.startTime = { $gt: start + req.query.range * 86400000, $lte: start - 86400000 };
        }
      }
    }
  }

  if (req.query.property &amp;&amp; ObjectId.isValid(req.query.property)) {
    query.property = req.query.property
  }

  query.status = { $ne: 'cancelled' }

  if (req.query.outcome) {
    if (req.query.outcome === 'Applied/SentApplication') {
      query.$or = [
        { outcome: 'Applied' },
        { outcome: 'Sent Application' }
      ];
    } else {
      query.outcome = req.query.outcome
    }
  }
  var fields = {};
  if (req.query.format == 'calandar') {
    fields = { _id: 1, status: 1, contact: 1, duration: 1, startTime: 1, stopTime: 1, notes: 1 }
  }
  var Query = Meeting.find(query, fields);

  if (req.query.format == 'calandar') {
    Query.populate('property', 'address unit category name')
    Query.populate('contact', 'firstName lastName email phone')
  } else {
    Query.populate('property')
    Query.populate('contact')
  }
  let searchQuery = {}

  if (req.query.range === "today") {
    searchQuery = {
      $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ],
      $and: [
        { startTime: { $gt: startThisDay.valueOf() } },
        { stopTime: { $lt: endThisDay.valueOf() } }
      ],
      status: { $ne: 'cancelled' }
    };
  }
  else if (req.query.range === "future") {
    searchQuery = { startTime: { $gt: start - 86400000 }, $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  }
  else if (req.query.range === "7") {
    searchQuery = { startTime: { $gt: start - 86400000, $lte: start + 7 * 86400000 }, $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  }
  else if (req.query.range === "30") {
    searchQuery = { startTime: { $gt: start - 86400000, $lte: start + 30 * 86400000 }, $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  }
  else if (req.query.range === "past") {
    searchQuery = { startTime: { $lte: start }, $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  }
  else if (req.query.range === "-7") {
    searchQuery = { startTime: { $gt: start - 7 * 86400000, $lte: start - 86400000 }, $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  }
  else if (req.query.range === "-30") {
    searchQuery = { startTime: { $gt: start - 30 * 86400000, $lte: start - 86400000 }, $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  } else {
    searchQuery = { $or: [
        { user: req.user._id },
        { allowedAgents: req.user._id }
      ], status: { $ne: 'cancelled' } };
  }

  Query.find({ ...searchQuery }).sort({ 'startTime': 1 })
    .exec(async (err, meetings) => {
      if (req.params.id) {
        return res.json(meetings[0])
      }
      if (req.query.format == 'list') {

        let allTimeQuery = { $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };

        let todayQuery = {
          $or: [
            { user: req.user._id },
            { allowedAgents: req.user._id }
          ],
          $and: [
            { startTime: { $gt: startThisDay.valueOf() } },
            { stopTime: { $lt: endThisDay.valueOf() } }
          ],
          status: { $ne: 'cancelled' }
        };

        let nextQuery = { startTime: { $gt: start - 86400000 }, $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };

        let next7Query = { startTime: { $gt: start - 86400000, $lte: start + 7 * 86400000 }, $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };
        let next30Query = { startTime: { $gt: start - 86400000, $lte: start + 30 * 86400000 }, $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };


        let pastQuery = { startTime: { $lte: start }, $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };

        let past7Query = { startTime: { $gt: start - 7 * 86400000, $lte: start - 86400000 }, $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };
        let past30Query = { startTime: { $gt: start - 30 * 86400000, $lte: start - 86400000 }, $or: [
          { user: req.user._id },
          { allowedAgents: req.user._id }
        ], status: { $ne: 'cancelled' } };

        if (req.query.property &amp;&amp; ObjectId.isValid(req.query.property)) {
          allTimeQuery = { ...allTimeQuery, property: req.query.property };
          todayQuery = { ...todayQuery, property: req.query.property };
          nextQuery = { ...nextQuery, property: req.query.property };
          next7Query = { ...next7Query, property: req.query.property };
          next30Query = { ...next30Query, property: req.query.property };
          pastQuery = { ...pastQuery, property: req.query.property };
          past7Query = { ...past7Query, property: req.query.property };
          past30Query = { ...past30Query, property: req.query.property };
        }

        const allTime = await Meeting.count(allTimeQuery);
        const today = await Meeting.count(todayQuery);
        const next = await Meeting.count(nextQuery);
        const next7 = await Meeting.count(next7Query);
        const next30 = await Meeting.count(next30Query);
        const past = await Meeting.count(pastQuery);
        const past7 = await Meeting.count(past7Query);
        const past30 = await Meeting.count(past30Query);

        const toursCompletedPast7 = await Meeting.count({ ...past7, status: "attended" });

        res.json({
          data: meetings,
          count: {
            today: today,
            next: {
              week: next7,
              month: next30,
              all: next
            },
            past: {
              week: past7,
              month: past30,
              all: past
            },
            all: allTime,
          },
          toursCount: {
            past: {
              week: toursCompletedPast7
            },
          }
        });
      } else {
        res.json(meetings);
      }
    })
});

/**
 * Provides specific instructions and details for a given meeting, including property access codes,
 * related documents, and operational details relevant to the meeting's execution.
 * 
 * @name GetMeetingDetails
 * @function
 * @memberof module:routes/meeting
 * @param {string} id - The ID of the meeting to retrieve details for.
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @returns {Object} Detailed information about the meeting.
 */
router.get('/instructions/:id', async (req, res, next) => {
  const {id} = req.params

  if (!ObjectId.isValid(id)) {
    return res.status(400).send({ message: "Invalid ID" });
  }
  try {
    const meeting = await Meeting.findById(id).populate('property', 'address shortAddress propertyAccessCodes rentalApplicationForm images primaryImage doorUnlockLink kit').select('startTime stopTime').lean()
    return res.status(200).json(meeting)
  } catch (error) {
    console.log("ERROR WHILE RETURNING INSTRUCTIONS: ", error)
  }
});

/**
 * Retrieves a single meeting or a list of meetings based on various criteria from the request parameters and query.
 * Supports filtering by meeting ID, property ID, meeting status (cancelled or not), and outcomes such as 'Applied' or 'Sent Application'.
 * Additionally, it can generate different formats of data like calendar views or lists, and provide aggregated counts based on time frames.
 * 
 * @name RetrieveMeetings
 * @function
 * @memberof module:routes/meeting
 * @param {string} id - Optional. The ID of the meeting or property.
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express middleware next function.
 * @returns {Object} Retrieved meeting data or an array of meetings.
 */
router.get('/:id?', function (req, res, next) {
  let query = {};

  let start = Math.round(new Date().getTime() / 86400000) * 86400000;
  if (req.params.id &amp;&amp; ObjectId.isValid(req.params.id)) {
    query._id = req.params.id;
  }

  if (req.query.property &amp;&amp; ObjectId.isValid(req.query.property)) {
    query.property = req.query.property
  }

  query.status = { $ne: 'cancelled' }

  if (req.query.cancelled == 'true') {
    delete query.status
  }

  if (req.query.outcome) {
    if (req.query.outcome === 'Applied/SentApplication') {
      query.$or = [
        { outcome: 'Applied' },
        { outcome: 'Sent Application' }
      ];
    } else {
      query.outcome = req.query.outcome
    }
  }
  var fields = {};
  if (req.query.format == 'calandar') {
    fields = { _id: 1, status: 1, contact: 1, duration: 1, startTime: 1, stopTime: 1, notes: 1 }
  }
  var Query = Meeting.find(query, fields);

  if (req.query.format == 'calandar') {
    Query.populate('property', 'address unit category name')
    Query.populate('contact', 'firstName lastName email phone')
  } else {
    Query.populate('property')
    Query.populate('contact')
  }
  Query.sort({ 'startTime': 1 })
    .exec(async (err, meetings) => {
      if (req.params.id) {
        return res.json(meetings[0])
      }
      if (req.query.format == 'list') {

        let allTimeQuery = { user: req.user._id };

        let todayQuery = { startTime: { $gt: new Date().getTime(), $lte: new Date().getTime() + 86400000 }, user: req.user._id };

        let nextQuery = { startTime: { $gt: start - 86400000 }, user: req.user._id };

        let next7Query = { startTime: { $gt: start - 86400000, $lte: start + 7 * 86400000 }, user: req.user._id };
        let next30Query = { startTime: { $gt: start - 86400000, $lte: start + 30 * 86400000 }, user: req.user._id };


        let pastQuery = { startTime: { $lte: start }, user: req.user._id };

        let past7Query = { startTime: { $gt: start - 7 * 86400000, $lte: start - 86400000 }, user: req.user._id };
        let past30Query = { startTime: { $gt: start - 30 * 86400000, $lte: start - 86400000 }, user: req.user._id };

        if (req.query.property &amp;&amp; ObjectId.isValid(req.query.property)) {
          allTimeQuery = { ...allTimeQuery, property: req.query.property };
          todayQuery = { ...todayQuery, property: req.query.property };
          nextQuery = { ...nextQuery, property: req.query.property };
          next7Query = { ...next7Query, property: req.query.property };
          next30Query = { ...next30Query, property: req.query.property };
          pastQuery = { ...pastQuery, property: req.query.property };
          past7Query = { ...past7Query, property: req.query.property };
          past30Query = { ...past30Query, property: req.query.property };
        }

        const allTime = await Meeting.count(allTimeQuery);
        const today = await Meeting.count(todayQuery);
        const next = await Meeting.count(nextQuery);
        const next7 = await Meeting.count(next7Query);
        const next30 = await Meeting.count(next30Query);
        const past = await Meeting.count(pastQuery);
        const past7 = await Meeting.count(past7Query);
        const past30 = await Meeting.count(past30Query);

        const toursCompletedPast7 = await Meeting.count({ ...past7, status: "attended" });

        res.json({
          data: meetings,
          count: {
            today: today,
            next: {
              week: next7,
              month: next30,
              all: next
            },
            past: {
              week: past7,
              month: past30,
              all: past
            },
            all: allTime,
          },
          toursCount: {
            past: {
              week: toursCompletedPast7
            },
          }
        });
      } else {
        res.json(meetings);
      }
    })
});


/**
 * Handles specific actions (like push or info) for a given meeting and its associated property.
 * Actions may include unlocking a door or sending additional info regarding the property.
 * 
 * @name HandleMeetingAction
 * @function
 * @memberof module:routes/meeting
 * @param {string} id - The ID of the meeting.
 * @param {string} key - A key to identify the type of action.
 * @param {string} action - The action to be performed (e.g., push, info).
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object.
 * @param {function} next - Express middleware next function.
 * @returns {Object} The result of the action execution.
 */
router.post('/:id/:key/:action',
  function (req, res, next) {

    if (!req.params.id || !ObjectId.isValid(req.params.id)) {
      return res.status(400).json({ message: "Invalid ID" });
    }

    if (req.params.key == 'public') {
      return next();
    }

    let query = { _id: req.params.id, $or: [{ status: "active" }, { status: "attended" }], lockKey: req.params.key }
    Meeting.findOne(query)
      .populate('property')
      .populate('contact')
      .populate('user')
      .exec(function (err, meeting) {

        if (!meeting) {
          return res.status(500).json({ message: "Meeting not found" })
        }

        if (!meeting.property) {
          return res.status(500).json({ message: "Property not found" })
        }

        if (['active', 'lease agreement sent', 'application received'].indexOf(meeting.property.status) == -1) {
          return res.status(500).json({ message: "Property not available" })
        }

        const userTimezone = meeting.user.settings.meetings.timezoneLocation ? meeting.user.settings.meetings.timezoneLocation : 'UTC';

        let deviceType = 'lock';

        if (req.params.action === 'push') {
          deviceType = 'button'
        }

        let query = {
          property: meeting.property._id,
          user: meeting.property.user,
          category: deviceType,
          status: 'active'
        }

        Hardware.findOne(query).populate('account').populate('kit', 'device_id').exec(function (err, hardware) {

          if (hardware) {
            let allowedStartTime = meeting.startTime - (1000 * 60 * 20);
            let endTime = meeting.stopTime + (1000 * 60 * 5);
            let currentTime = new Date().getTime();
            let validTime = currentTime > allowedStartTime &amp;&amp; currentTime &lt; endTime;

            if (!validTime) {
              return res.status(400).json({
                startTime: meeting.startTime,
                stopTime: meeting.stopTime,
                date: dayjs(meeting.startTime).tz(userTimezone).format('dddd, MMMM D, YYYY'),
                time: `${dayjs(meeting.startTime).tz(userTimezone).format('H:mm A')} - ${dayjs(meeting.stopTime).tz(userTimezone).format('H:mm A')}`,
                message: "Time period not allowed"
              })
            }
            if (req.params.action == 'info') {
              return res.json({
                _id: meeting._id,
                startTime: meeting.startTime,
                stopTime: meeting.stopTime,
                date: dayjs(meeting.startTime).tz(userTimezone).format('dddd, MMMM D, YYYY'),
                time: `${dayjs(meeting.startTime).tz(userTimezone).format('H:mm A')} - ${dayjs(meeting.stopTime).tz(userTimezone).format('H:mm A')}`,
                hardware: hardware._id
              })
            }
            if (hardware.category === 'lock') {
              if (hardware.lock.vendor === 'august') {
                const authData = {
                  token: hardware.account.token,
                }
                const command = req.params.action.toLowerCase();
                augustController.sendCommand(hardware.lock.id, command, authData)
                  .then(response => {
                    if ((response.status === 'kAugLockState_Unlocked' &amp;&amp; command === 'unlock') || (response.status === 'kAugLockState_Locked' &amp;&amp; command === 'lock')) {
                      // mark as attended
                      Meeting.findOneAndUpdate(
                        { _id: meeting._id },
                        { $set: { status: 'attended' } },
                      ).exec();
                      createTransaction({
                        action: command,
                        type: 'booking',
                        byModel: 'Contact',
                        by: meeting.contact._id,
                        hardware: hardware._id,
                        property: meeting.property._id
                      });
                      // notify to contact if is open
                      if (command === 'unlock') {

                        triggerCameraStreams(hardware.kit.device_id);

                        const notificationEmail = `
                                                We wanted to inform you that the prospect ${meeting.contact.firstName} ${meeting.contact.lastName} for the showing at ${meeting.property.address} has arrived. The scheduled time for the showing is ${dayjs().tz(userTimezone).format('MM/DD/YYYY hh:mm a')}.
                                                &lt;br>
                                                &lt;br>
                                                Please follow this link if you would like to greet ${meeting.contact.firstName} ${meeting.contact.lastName}:  https://app.delet.ai/property/view/${meeting.property._id}
                                                `;
                        const notificationSMS = `
                                                We wanted to inform you that the prospect ${meeting.contact.firstName} ${meeting.contact.lastName} for the showing at ${meeting.property.address} has arrived. The scheduled time for the showing is ${dayjs().tz(userTimezone).format('MM/DD/YYYY hh:mm a')}.
                                                \n
                                                Please follow this link if you would like to greet ${meeting.contact.firstName} ${meeting.contact.lastName}:  https://app.delet.ai/property/view/${meeting.property._id}
                                                `;

                        if (meeting.user.email) {
                          const companyName = (meeting.user.company.name !== undefined &amp;&amp; meeting.user.company.name !== '') ? meeting.user.company.name : 'Delet';
                          notification.sendEmail({
                            emailAlias: companyName,
                            to: meeting.user.email,
                            subject: `Prospect Arrived for Scheduled Showing at ${meeting.property.address}`,
                            body: notificationEmail
                          }).catch((error) => {
                            console.log(error);
                          });
                        }

                        if (meeting.user.phone) {
                          notification.sendSms({
                            phone: meeting.user.phone,
                            body: notificationSMS
                          }).catch(error => console.log(error));
                        }
                      }
                    }
                    res.send(command);
                  }).catch((err) => {
                    console.log(err);
                  })
              } else if (hardware.lock.vendor === 'switchbot') {
                const authData = {
                  token: hardware.account.token,
                  secret: hardware.account.secret,
                  t: Date.now(),
                  nonce: uuidv4()
                }
                const command = req.params.action.toLowerCase();
                switchbotController.sendCommand(hardware.lock.id, command, '', authData)
                  .then(response => {
                    if (response.message === 'success') {
                      // mark as attended
                      Meeting.findOneAndUpdate(
                        { _id: meeting._id },
                        { $set: { status: 'attended' } },
                      ).exec();
                      createTransaction({
                        action: command,
                        type: 'booking',
                        byModel: 'Contact',
                        by: meeting.contact._id,
                        hardware: hardware._id,
                        property: meeting.property._id
                      });
                      // notify to contact if is open
                      if (command === 'unlock') {

                        triggerCameraStreams(hardware.kit.device_id);

                        const notificationEmail = `
                                                We wanted to inform you that the prospect ${meeting.contact.firstName} ${meeting.contact.lastName} for the showing at ${meeting.property.address} has arrived. The scheduled time for the showing is ${dayjs().tz(userTimezone).format('MM/DD/YYYY hh:mm a')}.
                                                &lt;br>
                                                &lt;br>
                                                Please follow this link if you would like to greet ${meeting.contact.firstName} ${meeting.contact.lastName}:  https://app.delet.ai/property/view/${meeting.property._id}
                                                `;
                        const notificationSMS = `
                                                We wanted to inform you that the prospect ${meeting.contact.firstName} ${meeting.contact.lastName} for the showing at ${meeting.property.address} has arrived. The scheduled time for the showing is ${dayjs().tz(userTimezone).format('MM/DD/YYYY hh:mm a')}.
                                                \n
                                                Please follow this link if you would like to greet ${meeting.contact.firstName} ${meeting.contact.lastName}:  https://app.delet.ai/property/view/${meeting.property._id}
                                                `;
                        if (meeting.user.email) {
                          const companyName = (meeting.user.company.name !== undefined &amp;&amp; meeting.user.company.name !== '') ? meeting.user.company.name : 'Delet';
                          notification.sendEmail({
                            emailAlias: companyName,
                            to: meeting.user.email,
                            subject: `Prospect Arrived for Scheduled Showing at ${meeting.property.address}`,
                            body: notificationEmail
                          }).catch((error) => {
                            console.log(error);
                          });
                        }

                        if (meeting.user.phone) {
                          notification.sendSms({
                            phone: meeting.user.phone,
                            body: notificationSMS
                          }).catch(error => console.log(error));
                        }
                      }

                    }
                    res.send(command);
                  }).catch((err) => {
                    console.log(err);
                  })
              }
            } else if (hardware.category === 'button') {
              if (hardware.button.vendor === 'switchbot') {
                const authData = {
                  token: hardware.account.token,
                  secret: hardware.account.secret,
                  t: Date.now(),
                  nonce: uuidv4()
                }
                buttonController.actuateButton(hardware.button.id, 'on', authData)
                  .then(response => {
                    if (response.message === 'success') {
                      setTimeout(() => {
                        buttonController.actuateButton(hardware.button.id, 'off', authData)
                          .then(response => {
                            if (response.message === 'success') {
                              // mark as attended
                              Meeting.findOneAndUpdate(
                                { _id: meeting._id },
                                { $set: { status: 'attended' } },
                              ).exec();
                              createTransaction({
                                action: 'push',
                                type: 'booking',
                                byModel: 'Contact',
                                by: meeting.contact._id,
                                hardware: hardware._id,
                                property: meeting.property._id
                              });

                              // notify to contact if is open
                              const notificationEmail = `
                                                                We wanted to inform you that the prospect ${meeting.contact.firstName} ${meeting.contact.lastName} for the showing at ${meeting.property.address} has arrived at the building. The scheduled time for the showing is ${dayjs().tz(userTimezone).format('MM/DD/YYYY hh:mm a')}.
                                                                &lt;br>
                                                                &lt;br>
                                                                Please follow this link if you would like to greet ${meeting.contact.firstName} ${meeting.contact.lastName}:  https://app.delet.ai/property/view/${meeting.property._id}
                                                                `;
                              const notificationSMS = `
                                                                We wanted to inform you that the prospect ${meeting.contact.firstName} ${meeting.contact.lastName} for the showing at ${meeting.property.address} has arrived at the building. The scheduled time for the showing is ${dayjs().tz(userTimezone).format('MM/DD/YYYY hh:mm a')}.
                                                                \n
                                                                Please follow this link if you would like to greet ${meeting.contact.firstName} ${meeting.contact.lastName}:  https://app.delet.ai/property/view/${meeting.property._id}
                                                                `;
                              if (meeting.user.email) {
                                const companyName = (meeting.user.company.name !== undefined &amp;&amp; meeting.user.company.name !== '') ? meeting.user.company.name : 'Delet';
                                notification.sendEmail({
                                  emailAlias: companyName,
                                  to: meeting.user.email,
                                  subject: `Prospect Arrived for Scheduled Showing at ${meeting.property.address}`,
                                  body: notificationEmail
                                }).catch((error) => {
                                  console.log(error);
                                });
                              }

                              if (meeting.user.phone) {
                                notification.sendSms({
                                  phone: meeting.user.phone,
                                  body: notificationSMS
                                }).catch(error => console.log(error));
                              }

                              res.status(200).send(response.body.items[0].status.power);
                            } else {
                              res.status(400).send(response);
                            }
                          }).catch(err => {
                            res.status(500).send(err);
                          })
                      }, 1000 * hardware.button.time)
                    } else {
                      res.status(400).send(response);
                    }
                  }).catch(err => {
                    res.status(500).send(err);
                  })
              }
            }
          } else {
            return res.status(500).json({
              startTime: meeting.startTime,
              stopTime: meeting.stopTime,
              date: moment(meeting.startTime).format('dddd, MMMM D, YYYY'),
              time: `${dayjs(meeting.startTime).tz(userTimezone).format('H:mm A')} - ${dayjs(meeting.stopTime).tz(userTimezone).format('H:mm A')}`,
              message: "Lock not found"
            });
          }
        });
      });
  },

/**
 * Handles the cancellation of a meeting based on the specified meeting ID and status action.
 * Updates the meeting's status and sends notifications via email and SMS to the associated contacts.
 * Ensures the meeting and property exist and handles synchronization with Google calendar if applicable.
 * 
 * @name HandleMeetingCancellation
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object containing the meeting ID and action in the parameters.
 * @param {Object} res - Express response object to send back the cancellation status or error message.
 * @param {function} next - The next middleware function in the call stack.
 */
  //@todo add a different key instead of generic public to ensure no one can ddos abuse and cancel appointments
  function handleCancel(req, res, next) {
    console.log('Handle cancel was called')
    if ((!req.params.id || !ObjectId.isValid(req.params.id)) &amp;&amp; req.params.action !== 'cancelled') {
      return res.status(400).end();
    }

    let query = { _id: req.params.id, status: "active" }
    console.log('handleCancel query: ', query)
    Meeting.findOne(query)
      .populate('property')
      .exec(function (err, meeting) {
        console.log('handleCancel err: ', err)
        console.log('handleCancel meeting: ', JSON.stringify(meeting))
        if (!meeting) {
          return res.status(404).send(`&lt;h2 style="text-align: center;">The meeting does not exist or has already been cancelled&lt;/h2>`);
        }

        if (!meeting.property) {
          return res.json({ message: "Property does not exist" })
        }

        Meeting.findOneAndUpdate(
          { _id: req.params.id, status: "active" },
          { $set: { status: req.params.action } },
          { upsert: false, multi: false, new: true }).populate('user').populate('contact').populate('property').exec(
            async function (err, meeting) {
              if (err) {
                return next(err);
              }

              // @todo add an email to tell the user it was cancelled or see if google does
              if (meeting &amp;&amp; meeting.syncedWithGoogle &amp;&amp; req.params.action == 'cancelled') {
                calendar.deleteEvent(`${meeting.property._id}000000${meeting._id}`)
              }
              const userTimezone = (meeting?.user?.settings?.meetings?.timezoneLocation !== undefined &amp;&amp; meeting?.user?.settings?.meetings?.timezoneLocation !== '') ? meeting.user.settings.meetings.timezoneLocation : 'UTC';
              const companyName = (meeting?.user?.company?.name !== undefined &amp;&amp; meeting?.user?.company?.name !== '') ? meeting?.user?.company?.name : 'Delet';
              if (meeting.contact.subscription) {
                await notification.sendEmail({
                  emailAlias: companyName,
                  to: meeting.contact.email,
                  subject: `Appointment cancelled`,
                  body: `We have cancelled your appointment at ${dayjs(meeting.startTime).tz(userTimezone).format('MM/DD/YYYY hh:mm a')} in unit ${meeting.property.address}.&lt;br>
                                    Reschedule link: https://app.delet.ai/book/${meeting.property._id}/meeting/${meeting._id}&lt;br>&lt;br>Thanks&lt;br>&lt;br>Unsubscribe or change your notification preferences.&lt;br>https://app.delet.ai/subscription?contact=${meeting.contact._id}`
                }).catch((error) => {
                  console.log("error", error);
                });

                await notification.sendSms({
                  phone: meeting.contact.phone,
                  body: `We have cancelled your appointment at ${dayjs(meeting.startTime).tz(userTimezone).format('MM/DD/YYYY hh:mm a')} in unit ${meeting.property.address}.\n
                                    Reschedule link: https://app.delet.ai/book/${meeting.property._id}/meeting/${meeting._id}\n\nThanks\n\nUnsubscribe or change your notification preferences.\nhttps://app.delet.ai/subscription?contact=${meeting.contact._id}`
                }).catch(error => console.log(error));
              }

              // return res.redirect(`http://app.delet.ai/book/${meeting.property}/meeting/${meeting._id}`);
              return res.status(200).send({message: 'The meeting has been canceled!'});
            });


      });
  });

/**
 * Retrieves statistical data about meetings associated with a specific property ID.
 * This route uses authentication middleware to ensure only authorized users can access the data.
 * 
 * @name GetMeetingStats
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object with the property ID as a parameter.
 * @param {Object} res - Express response object to send back the statistical data.
 * @param {function} next - The next middleware function in the call stack.
 */
router.get('/stats/:propId', authMiddleware, meetingStats)

/**
 * Cancels a specified meeting by updating its status to 'cancelled' if the meeting is currently active.
 * Validates the meeting ID, checks the current status of the meeting and the associated property,
 * and performs updates only if conditions are met. Optionally, synchronizes changes with Google Calendar if enabled.
 * Returns appropriate messages if the action cannot be performed due to time constraints or invalid statuses.
 * 
 * @name CancelMeeting
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object with the meeting ID in the URL parameters.
 * @param {Object} res - Express response object used to send a status code indicating success or failure.
 * @param {function} next - The next middleware function in the call stack, used for error handling.
 */
router.delete('/:id', authMiddleware, function handleCancel(req, res, next) {

  if (!req.params.id || !ObjectId.isValid(req.params.id)) {
    return res.status(400).end();
  }

  let query = { _id: req.params.id, status: "active" }

  Meeting.findOne(query)
    .populate('property')
    .exec(function (err, meeting) {
      if (!meeting) {
        return res.json({ message: "Action not during allowed time period" })
      }
      console.log(495)
      if (!meeting.property) {
        return res.json({ message: "Action not during allowed time period" })
      }
      if (['active', 'lease agreement sent', 'application received'].indexOf(meeting.property.status) == -1) {
        return res.json({ message: "Action not during allowed time period" })
      }
      console.log(503)

      Meeting.findOneAndUpdate(
        { _id: req.params.id, status: "active" },
        { $set: { status: 'cancelled' } },
        { upsert: false, multi: false, new: true }).exec(
          function (err, meeting) {
            if (err) {
              return next(err);
            }

            // @todo add an email to tell the user it was cancelled or see if google does
            if (meeting &amp;&amp; meeting.syncedWithGoogle &amp;&amp; req.params.action == 'cancelled') {
              calendar.deleteEvent(`${meeting.property}000000${meeting._id}`)
            }

            return res.status(200).send();

          });


    });
})

/**
 * Creates a new meeting with provided details like start and stop times, tags, and notes.
 * Ensures that no time conflicts exist for the specified slot before creating the meeting.
 * 
 * @name CreateMeeting
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object containing meeting data in the body.
 * @param {Object} res - Express response object to send back the created meeting data or error message.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post('/', authMiddleware, async function (req, res, next) {
  try {
    const count = await Meeting.count({
      user: req.user._id,
      status: 'active',
      $and: [
        { startTime: { $gte: new Date(req.body.start._date) } },
        { startTime: { $lte: new Date(req.body.end._date) } }
      ],
    }).exec();

    if (count !== 0) {
      return res.json({ err: true, message: "Meeting slot no longer available" });
    }

    const meeting = Meeting.create({
      status: 'active',
      user: req.user._id,
      createdDate: new Date().getTime(),
      updatedDate: new Date().getTime(),
      startTime: new Date(req.body.start._date),
      stopTime: new Date(req.body.end._date),
      localDateTime: req.body.localDateTime,
      duration: Math.round((new Date(req.body.end._date) - new Date(req.body.start._date)) / (1000 * 60)),
      tags: ['Manually generated'],
      notes: req.body.title + ' ' + req.body.location
    });

    res.json(meeting);
  } catch (err) {
    console.error("Failed to create or save meeting:", err);
    return res.status(500).json({ error: true, message: "An error occurred while processing your request." });
  }
});

/**
 * Updates specific details of an existing meeting identified by the provided ID.
 * Fields such as outcome, tags, notes, status, start time, and stop time can be updated.
 * The function checks for the presence of each field in the request body before applying updates.
 * Additionally, if the meeting is synced with Google Calendar and is cancelled, the corresponding calendar event is deleted.
 * Notifications may be sent to the contact associated with the meeting if significant changes like cancellation occur.
 * 
 * @name UpdateMeeting
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object containing meeting ID in the URL and fields to update in the body.
 * @param {Object} res - Express response object to send back the operation status.
 * @param {function} next - The next middleware function in the call stack for error handling.
 */
router.patch('/:id', authMiddleware, function (req, res, next) {

  let body = req.body;
  let set = {
    outcome: body.outcome,
    tags: body.tags,
    notes: body.notes,
    status: body.status,
    startTime: body.start,
    stopTime: body.end
  };

  for (let index in set) {
    if (!set[index]) {
      delete set[index];
    }
  }

  Meeting.findOneAndUpdate(
    { user: req.user._id, _id: req.params.id },
    { $set: set },
    { upsert: false, multi: false, new: true },
    function (err, meeting) {
      if (err) {
        return next(err);
      }

      // @todo add an email to tell the user it was cancelled or see if google does
      if (meeting &amp;&amp; meeting.syncedWithGoogle &amp;&amp; body.status == 'cancelled') {
        calendar.deleteEvent(`${meeting.property._id}000000${meeting._id}`)

        const userTimezone = meeting.user.settings.meetings.timezoneLocation ? meeting.user.settings.meetings.timezoneLocation : 'UTC';

        // sent email cancel

        const companyName = (meeting.user.company.name !== undefined &amp;&amp; meeting.user.company.name !== '') ? meeting.user.company.name : 'Delet';

        if (meeting.contact.subscription) {
          notification.sendEmail({
            emailAlias: companyName,
            to: meeting.contact.email,
            subject: `Appointment cancelled`,
            body: `Unfortunately we had to cancel your appointment at ${dayjs(meeting.startTime).tz(userTimezone).format('MM/DD/YYYY hh:mm a')} in unit ${meeting.property.address}.&lt;br>Please check our other units available at https://app.delet.ai/book/list/${String(meeting.user)}&lt;br>&lt;br>Thanks&lt;br>&lt;br>Unsubscribe or change your notification preferences.&lt;br>https://app.delet.ai/subscription?contact=${meeting.contact._id}&lt;br>
                        Reschedule link: https://app.delet.ai/book/${meeting.property._id}/meeting/${meeting._id}`
          }).catch((error) => {
            console.log(error);
          });

          notification.sendSms({
            phone: meeting.contact.phone,
            body: `Unfortunately we had to cancel your appointment at ${dayjs(meeting.startTime).tz(userTimezone).format('MM/DD/YYYY hh:mm a')} in unit ${meeting.property.address}.\nPlease check our other units available at https://app.delet.ai/book/list/${String(meeting.user)}\n\nThanks\n\nUnsubscribe or change your notification preferences.\nhttps://app.delet.ai/subscription?contact=${meeting.contact._id}\n
                        Reschedule link: https://app.delet.ai/book/${meeting.property._id}/meeting/${meeting._id}`
          }).catch(error => console.log(error));
        }
      }

      return res.status(200).end();
    })
    .populate('property', 'address')
    .populate('contact', 'firstName lastName email phone subscription')
    .populate('user', 'settings.meetings.timezoneLocation company');
});

/**
 * Reschedules an existing meeting to new dates and times as specified in the request.
 * Optionally sends notifications about the change. If the meeting is linked to a Google Calendar, updates might also be reflected there.
 * 
 * @name RescheduleMeeting
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object with the meeting ID and new scheduling details in the body.
 * @param {Object} res - Express response object to send back the updated meeting information.
 * @param {function} next - The next middleware function in the call stack.
 * @returns {Object} Updated meeting information.
 */
router.patch('/reschedule/:id', async function (req, res, next) {
  console.log(req.params.id)
  let body = req.body;
  let set = {
    status: body.status,
    startTime: body.start,
    stopTime: body.end,
    localDateTime: body.localDateTime,
    duration: body.duration,
    available: body.available
  };
  for (let index in set) {
    if (!set[index]) {
      delete set[index];
    }
  }

  Meeting.findOneAndUpdate(
    { _id: req.params.id },
    { $set: set },
    { upsert: false, multi: false, new: true },
    async function (err, meeting) {
      if (err) {
        return next(err);
      }

      // @todo add an email to tell the user it was cancelled or see if google does
      const companyName = (meeting.user.company.name !== undefined &amp;&amp; meeting.user.company.name !== '') ? meeting.user.company.name : 'Delet';
      if (meeting &amp;&amp; meeting.syncedWithGoogle &amp;&amp; body.status == 'active') {
        // calendar.deleteEvent(`${meeting.property._id}000000${meeting._id}`)

        const userTimezone = meeting.user.settings.meetings.timezoneLocation ? meeting.user.settings.meetings.timezoneLocation : 'UTC';

        // sent reschedule mail
        if (meeting.contact.subscription) {
          await notification.sendEmail({
            emailAlias: companyName,
            to: meeting.contact.email,
            subject: `Appointment rescheduled`,
            body: `We have rescheduled your appointment at ${dayjs(meeting.startTime).tz(userTimezone).format('MM/DD/YYYY hh:mm a')} in unit ${meeting.property.address}.&lt;br>
                        Cancel link: https://api.delet.ai/api/meeting/${meeting._id}/public/cancelled&lt;br>
                        Reschedule link: https://app.delet.ai/book/${meeting.property._id}/meeting/${meeting._id}&lt;br>&lt;br>Thanks&lt;br>&lt;br>Unsubscribe or change your notification preferences.&lt;br>https://app.delet.ai/subscription?contact=${meeting.contact._id}`
          }).catch((error) => {
            console.log(error);
          });

          await notification.sendSms({
            phone: meeting.contact.phone,
            body: `we have rescheduled your appointment at ${dayjs(meeting.startTime).tz(userTimezone).format('MM/DD/YYYY hh:mm a')} in unit ${meeting.property.address}\n
                        Cancel link: https://api.delet.ai/api/meeting/${meeting._id}/public/cancelled
                        Reschedule link: https://app.delet.ai/book/${meeting.property._id}/meeting/${meeting._id}
                        \n\nThanks\n\nUnsubscribe or change your notification preferences.\nhttps://app.delet.ai/subscription?contact=${meeting.contact._id}`
          }).catch(error => console.log(error));
        }
      }
      let event = {
        id: `${meeting.property._id}000000${meeting._id}`,
        summary: `${companyName} appointment: ${meeting.property.address}`,
        description: 'Viewing of ' + meeting.property.address,
        location: meeting.property.address,
        sendUpdates: 'all',
        start: {
          dateTime: new Date(meeting.startTime).toISOString(),
        },
        end: {
          dateTime: new Date(meeting.stopTime).toISOString(),
        },
        'attendees': [
          { 'email': meeting.contact.email },
          { 'email': meeting.user.email.toString() }
        ],
        'reminders': {
          'useDefault': false,
          'overrides': [
            { 'method': 'email', 'minutes': 24 * 60 },
            { 'method': 'popup', 'minutes': 10 },
          ],
        },
      }

      // calendar.insertEvent(event);
      return res.status(200).json(meeting);
    })
    .populate('property', 'address')
    .populate('contact', 'firstName lastName email phone subscription')
    .populate('user', 'settings.meetings.timezoneLocation company email');
});

/**
 * Retrieves a cancellation page for a meeting, marking the meeting as cancelled in the database.
 * This route is intended for public access, allowing external triggers to cancel meetings.
 * The cancellation status is confirmed by sending a predefined HTML response.
 * 
 * @name GetCancellationPage
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object with the meeting ID as a URL parameter.
 * @param {Object} res - Express response object to send the cancellation confirmation page or error messages.
 * @returns {Object} The confirmation page or error message.
 */
router.get('/:id/public/cancelled', async (req, res) => {
  const { id } = req.params
  try {
    await Meeting.findByIdAndUpdate(id, {
      status: 'cancelled'
    });
    
    const filePath = path.join(__dirname, '../templates/cancel-meeting.html');
    
    fs.readFile(filePath, 'utf8', (err, data) => {
      if (err) {
        console.error('Error reading the HTML file:', err);
        return res.status(500).send('Internal Server Error');
      }
      
      res.status(202).send(data);
    });
  } catch (error) {
    console.error('Error cancelling the meeting:', error);
    res.status(500).send('Internal Server Error');
  }
  
})

/**
 * Executes a temporary command related to a specific lock kit based on the provided meeting ID, kit ID, and action.
 * This route is used to control lock mechanisms during meetings, allowing actions such as locking or unlocking,
 * depending on the command specified in the action parameter. The function is designed to respond to immediate,
 * temporary needs for property access control, typically tied to specific meeting occurrences.
 * 
 * @name ExecuteTempLockCommand
 * @function
 * @memberof module:routes/meeting
 * @param {Object} req - Express request object containing the meeting ID, lock kit ID, and the action to be performed as URL parameters.
 * @param {Object} res - Express response object to handle the response from the command execution.
 * @param {function} next - The next middleware function in the call stack for further processing or error handling.
 */
router.patch('/lock/:id/:kitId/:action', sendTempCommand)


module.exports = router;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 16:15:44 GMT-0700 (北美太平洋夏令时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
