<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>routes/users.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BadRequest.html">BadRequest</a></li><li><a href="Forbidden.html">Forbidden</a></li><li><a href="NotFound.html">NotFound</a></li><li><a href="Unauthorized.html">Unauthorized</a></li></ul><h3>Modules</h3><ul><li><a href="module-Controller_Schedule.html">Controller/Schedule</a><ul class='methods'><li data-type='method'><a href="module-Controller_Schedule.html#~calibrateTimezone">calibrateTimezone</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupCVWaitList">cleanupCVWaitList</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~cleanupDropin">cleanupDropin</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~downloadIDImages">downloadIDImages</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~followUp">followUp</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~generateInvoices">generateInvoices</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~scheduleNextRun">scheduleNextRun</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendNotifications">sendNotifications</a></li><li data-type='method'><a href="module-Controller_Schedule.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-Controller_authentication.html">Controller/authentication</a></li><li><a href="module-Controller_button.html">Controller/button</a><ul class='methods'><li data-type='method'><a href="module-Controller_button.html#~statusButoon">statusButoon</a></li></ul></li><li><a href="module-Controller_camera.html">Controller/camera</a><ul class='methods'><li data-type='method'><a href="module-Controller_camera.html#~countRecords">countRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~createCameraZone">createCameraZone</a></li><li data-type='method'><a href="module-Controller_camera.html#~createNewCamera">createNewCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~editCamera">editCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~enableCamera">enableCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~generateStreamURL">generateStreamURL</a></li><li data-type='method'><a href="module-Controller_camera.html#~getKinesesStreamingUrl">getKinesesStreamingUrl</a></li><li data-type='method'><a href="module-Controller_camera.html#~getNextMonitorId">getNextMonitorId</a></li><li data-type='method'><a href="module-Controller_camera.html#~getRecords">getRecords</a></li><li data-type='method'><a href="module-Controller_camera.html#~getToken">getToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~pad">pad</a></li><li data-type='method'><a href="module-Controller_camera.html#~refreshToken">refreshToken</a></li><li data-type='method'><a href="module-Controller_camera.html#~reloadCameraStreams">reloadCameraStreams</a></li><li data-type='method'><a href="module-Controller_camera.html#~removeCamera">removeCamera</a></li><li data-type='method'><a href="module-Controller_camera.html#~triggerCameraStreams">triggerCameraStreams</a></li></ul></li><li><a href="module-Controller_contact.html">Controller/contact</a><ul class='methods'><li data-type='method'><a href="module-Controller_contact.html#~convertJsonToCsv">convertJsonToCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~getById">getById</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContact">getContact</a></li><li data-type='method'><a href="module-Controller_contact.html#~getContactSub">getContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~getUpdate">getUpdate</a></li><li data-type='method'><a href="module-Controller_contact.html#~toCsv">toCsv</a></li><li data-type='method'><a href="module-Controller_contact.html#~updateContactSub">updateContactSub</a></li><li data-type='method'><a href="module-Controller_contact.html#~validateIdLoad">validateIdLoad</a></li></ul></li><li><a href="module-Controller_dashboard.html">Controller/dashboard</a><ul class='methods'><li data-type='method'><a href="module-Controller_dashboard.html#~getDashboardStats">getDashboardStats</a></li></ul></li><li><a href="module-Controller_invoices.html">Controller/invoices</a><ul class='methods'><li data-type='method'><a href="module-Controller_invoices.html#~createInvoice">createInvoice</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoices">viewInvoices</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesById">viewInvoicesById</a></li><li data-type='method'><a href="module-Controller_invoices.html#~viewInvoicesByUser">viewInvoicesByUser</a></li></ul></li><li><a href="module-Controller_keypad.html">Controller/keypad</a><ul class='methods'><li data-type='method'><a href="module-Controller_keypad.html#~createPasscode">createPasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~deletePasscode">deletePasscode</a></li><li data-type='method'><a href="module-Controller_keypad.html#~listPasscodes">listPasscodes</a></li></ul></li><li><a href="module-Controller_lock_august_index.html">Controller/lock/august/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~lockStatus">lockStatus</a></li><li data-type='method'><a href="module-Controller_lock_august_index.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_lock_august_token.html">Controller/lock/august/token</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_august_token.html#~confirm">confirm</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~session">session</a></li><li data-type='method'><a href="module-Controller_lock_august_token.html#~validate">validate</a></li></ul></li><li><a href="module-Controller_lock_index.html">Controller/lock/index</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_index.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getLogs">getLogs</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~getStatus">getStatus</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~sendCommand">sendCommand</a></li><li data-type='method'><a href="module-Controller_lock_index.html#~toggleLock">toggleLock</a></li></ul></li><li><a href="module-Controller_lock_switchbot.html">Controller/lock/switchbot</a><ul class='methods'><li data-type='method'><a href="module-Controller_lock_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-Controller_lock_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-Controller_meeting.html">Controller/meeting</a><ul class='methods'><li data-type='method'><a href="module-Controller_meeting.html#~meetingStats">meetingStats</a></li><li data-type='method'><a href="module-Controller_meeting.html#~sendTempCommand">sendTempCommand</a></li></ul></li><li><a href="module-Controller_notification.html">Controller/notification</a><ul class='methods'><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationEmail">sendConfirmationEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendConfirmationSMS">sendConfirmationSMS</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendEmail">sendEmail</a></li><li data-type='method'><a href="module-Controller_notification.html#~sendSms">sendSms</a></li></ul></li><li><a href="module-Controller_order.html">Controller/order</a><ul class='methods'><li data-type='method'><a href="module-Controller_order.html#~createAndNotify">createAndNotify</a></li><li data-type='method'><a href="module-Controller_order.html#~formatOrderDetails">formatOrderDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~formatUserDetails">formatUserDetails</a></li><li data-type='method'><a href="module-Controller_order.html#~updateAndNotify">updateAndNotify</a></li></ul></li><li><a href="module-Controller_property.html">Controller/property</a><ul class='methods'><li data-type='method'><a href="module-Controller_property.html#~assignPropertyToUser">assignPropertyToUser</a></li><li data-type='method'><a href="module-Controller_property.html#~calcAvailability">calcAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~calcMonthAvailability">calcMonthAvailability</a></li><li data-type='method'><a href="module-Controller_property.html#~cloneProperty">cloneProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~getSinglePublicProperty">getSinglePublicProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~makeBook">makeBook</a></li><li data-type='method'><a href="module-Controller_property.html#~newProperty">newProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesPublic">propertiesPublic</a></li><li data-type='method'><a href="module-Controller_property.html#~propertiesUser">propertiesUser</a></li><li data-type='method'><a href="module-Controller_property.html#~property">property</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyAssignList">propertyAssignList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyList">propertyList</a></li><li data-type='method'><a href="module-Controller_property.html#~propertyListCustomSearch">propertyListCustomSearch</a></li><li data-type='method'><a href="module-Controller_property.html#~updateProperty">updateProperty</a></li><li data-type='method'><a href="module-Controller_property.html#~updatePropertyKit">updatePropertyKit</a></li></ul></li><li><a href="module-Controller_shipment.html">Controller/shipment</a><ul class='methods'><li data-type='method'><a href="module-Controller_shipment.html#~formattedShipment">formattedShipment</a></li><li data-type='method'><a href="module-Controller_shipment.html#~sendShipmentNotification">sendShipmentNotification</a></li></ul></li><li><a href="module-Controller_transactions.html">Controller/transactions</a><ul class='methods'><li data-type='method'><a href="module-Controller_transactions.html#~createTransaction">createTransaction</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByHardware">viewTransactionByHardware</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionById">viewTransactionById</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactionByProperty">viewTransactionByProperty</a></li><li data-type='method'><a href="module-Controller_transactions.html#~viewTransactions">viewTransactions</a></li></ul></li><li><a href="module-constants_cognito.html">constants/cognito</a></li><li><a href="module-constants_index.html">constants/index</a></li><li><a href="module-controllers_notifications.html">controllers/notifications</a><ul class='methods'><li data-type='method'><a href="module-controllers_notifications.html#~sendInstructions">sendInstructions</a></li><li data-type='method'><a href="module-controllers_notifications.html#~sendReminder">sendReminder</a></li></ul></li><li><a href="module-controllers_property.html">controllers/property</a><ul class='methods'><li data-type='method'><a href="module-controllers_property.html#~associateKit">associateKit</a></li></ul></li><li><a href="module-events_emitter.html">events/emitter</a></li><li><a href="module-helpers_account.html">helpers/account</a><ul class='methods'><li data-type='method'><a href="module-helpers_account.html#~addHardware">addHardware</a></li><li data-type='method'><a href="module-helpers_account.html#~addSwitchBotHardware">addSwitchBotHardware</a></li></ul></li><li><a href="module-helpers_aws-s3.html">helpers/aws-s3</a><ul class='methods'><li data-type='method'><a href="module-helpers_aws-s3.html#.getFileExtensionFromBase64">getFileExtensionFromBase64</a></li><li data-type='method'><a href="module-helpers_aws-s3.html#.uploadS3">uploadS3</a></li></ul></li><li><a href="module-helpers_button.html">helpers/button</a><ul class='methods'><li data-type='method'><a href="module-helpers_button.html#~actuateButton">actuateButton</a></li></ul></li><li><a href="module-helpers_calendar.html">helpers/calendar</a><ul class='methods'><li data-type='method'><a href="module-helpers_calendar.html#~dateTimeForCalander">dateTimeForCalander</a></li><li data-type='method'><a href="module-helpers_calendar.html#~deleteEvent">deleteEvent</a></li><li data-type='method'><a href="module-helpers_calendar.html#~getEvents">getEvents</a></li><li data-type='method'><a href="module-helpers_calendar.html#~insertEvent">insertEvent</a></li></ul></li><li><a href="module-helpers_camera.html">helpers/camera</a><ul class='methods'><li data-type='method'><a href="module-helpers_camera.html#~streamToBuffer">streamToBuffer</a></li></ul></li><li><a href="module-helpers_cognito.html">helpers/cognito</a><ul class='methods'><li data-type='method'><a href="module-helpers_cognito.html#~assignUserToGroup">assignUserToGroup</a></li><li data-type='method'><a href="module-helpers_cognito.html#~cognitoSignUp">cognitoSignUp</a></li><li data-type='method'><a href="module-helpers_cognito.html#~deleteUserFromCognito">deleteUserFromCognito</a></li><li data-type='method'><a href="module-helpers_cognito.html#~getSingleCognitoUser">getSingleCognitoUser</a></li><li data-type='method'><a href="module-helpers_cognito.html#~setPermanentUserPassword">setPermanentUserPassword</a></li><li data-type='method'><a href="module-helpers_cognito.html#~signInCognito">signInCognito</a></li><li data-type='method'><a href="module-helpers_cognito.html#~verifyHeaders">verifyHeaders</a></li><li data-type='method'><a href="module-helpers_cognito.html#~verifyToken">verifyToken</a></li></ul></li><li><a href="module-helpers_emailGeneration.html">helpers/emailGeneration</a><ul class='methods'><li data-type='method'><a href="module-helpers_emailGeneration.html#~formatDateToGoogleCalendar">formatDateToGoogleCalendar</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~formattingTime">formattingTime</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateBookingConfirmationEmail">generateBookingConfirmationEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateGoogleCalendarUrl">generateGoogleCalendarUrl</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateInstructionsEmail">generateInstructionsEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~generateReminderEmail">generateReminderEmail</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~insertInEmailLayout">insertInEmailLayout</a></li><li data-type='method'><a href="module-helpers_emailGeneration.html#~urlEncode">urlEncode</a></li></ul></li><li><a href="module-helpers_keypad.html">helpers/keypad</a><ul class='methods'><li data-type='method'><a href="module-helpers_keypad.html#~passcodeList">passcodeList</a></li></ul></li><li><a href="module-helpers_kit.html">helpers/kit</a><ul class='methods'><li data-type='method'><a href="module-helpers_kit.html#~associateHardware">associateHardware</a></li><li data-type='method'><a href="module-helpers_kit.html#~closeKitToUser">closeKitToUser</a></li><li data-type='method'><a href="module-helpers_kit.html#~registerKitToUser">registerKitToUser</a></li></ul></li><li><a href="module-helpers_switchbot.html">helpers/switchbot</a><ul class='methods'><li data-type='method'><a href="module-helpers_switchbot.html#~generateSign">generateSign</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~getDevices">getDevices</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~getDevicesStatus">getDevicesStatus</a></li><li data-type='method'><a href="module-helpers_switchbot.html#~sendCommand">sendCommand</a></li></ul></li><li><a href="module-helpers_utilities.html">helpers/utilities</a><ul class='methods'><li data-type='method'><a href="module-helpers_utilities.html#~downloadImage">downloadImage</a></li><li data-type='method'><a href="module-helpers_utilities.html#~relativeTimeConversion">relativeTimeConversion</a></li><li data-type='method'><a href="module-helpers_utilities.html#~splitTags">splitTags</a></li></ul></li><li><a href="module-middleware_adminRole.html">middleware/adminRole</a><ul class='methods'><li data-type='method'><a href="module-middleware_adminRole.html#~adminRole">adminRole</a></li></ul></li><li><a href="module-middleware_authMiddleware.html">middleware/authMiddleware</a><ul class='methods'><li data-type='method'><a href="module-middleware_authMiddleware.html#~authMiddleware">authMiddleware</a></li></ul></li><li><a href="module-middleware_errorHandler.html">middleware/errorHandler</a><ul class='methods'><li data-type='method'><a href="module-middleware_errorHandler.html#~errorHandler">errorHandler</a></li></ul></li><li><a href="module-models_account.html">models/account</a></li><li><a href="module-models_action.html">models/action</a></li><li><a href="module-models_building.html">models/building</a></li><li><a href="module-models_confirmationCode.html">models/confirmationCode</a></li><li><a href="module-models_contact.html">models/contact</a></li><li><a href="module-models_discount.html">models/discount</a></li><li><a href="module-models_hardware.html">models/hardware</a></li><li><a href="module-models_invoice.html">models/invoice</a></li><li><a href="module-models_invoiceInfo.html">models/invoiceInfo</a></li><li><a href="module-models_kit.html">models/kit</a></li><li><a href="module-models_meeting.html">models/meeting</a></li><li><a href="module-models_order.html">models/order</a></li><li><a href="module-models_paymentMethod.html">models/paymentMethod</a></li><li><a href="module-models_product.html">models/product</a></li><li><a href="module-models_property.html">models/property</a></li><li><a href="module-models_settings.html">models/settings</a></li><li><a href="module-models_shipment.html">models/shipment</a></li><li><a href="module-models_subscription.html">models/subscription</a></li><li><a href="module-models_transaction.html">models/transaction</a></li><li><a href="module-models_user.html">models/user</a></li><li><a href="module-routes_account.html">routes/account</a></li><li><a href="module-routes_agents.html">routes/agents</a></li><li><a href="module-routes_button.html">routes/button</a></li><li><a href="module-routes_camera.html">routes/camera</a></li><li><a href="module-routes_contact.html">routes/contact</a><ul class='methods'><li data-type='method'><a href="module-routes_contact.html#.get/">get/</a></li><li data-type='method'><a href="module-routes_contact.html#.get/:id?">get/:id?</a></li><li data-type='method'><a href="module-routes_contact.html#.get/toCsv">get/toCsv</a></li><li data-type='method'><a href="module-routes_contact.html#.post/validateid/load">post/validateid/load</a></li><li data-type='method'><a href="module-routes_contact.html#.put/update/:id?">put/update/:id?</a></li><li data-type='method'><a href="module-routes_contact.html#.subscription/:id">subscription/:id</a></li></ul></li><li><a href="module-routes_contactVerified.html">routes/contactVerified</a></li><li><a href="module-routes_dashboard.html">routes/dashboard</a></li><li><a href="module-routes_discount.html">routes/discount</a><ul class='methods'><li data-type='method'><a href="module-routes_discount.html#.get/">get/</a></li><li data-type='method'><a href="module-routes_discount.html#.get/:code">get/:code</a></li><li data-type='method'><a href="module-routes_discount.html#.get/generate-code">get/generate-code</a></li><li data-type='method'><a href="module-routes_discount.html#.post/">post/</a></li></ul></li><li><a href="module-routes_documents.html">routes/documents</a></li><li><a href="module-routes_hardware.html">routes/hardware</a><ul class='methods'><li data-type='method'><a href="module-routes_hardware.html#.delete/:id">delete/:id</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id/admin/sync">get/:id/admin/sync</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id/stream">get/:id/stream</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/:id?">get/:id?</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/list/cameras">get/list/cameras</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/session/:property/:uid/agent">get/session/:property/:uid/agent</a></li><li data-type='method'><a href="module-routes_hardware.html#.get/session/:property/:uid/manager">get/session/:property/:uid/manager</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/">post/</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/:id">post/:id</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/:id/stream/test">post/:id/stream/test</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/admin/buzzer">post/admin/buzzer</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/admin/sync">post/admin/sync</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/app/ping">post/app/ping</a></li><li data-type='method'><a href="module-routes_hardware.html#.post/bulk">post/bulk</a></li><li data-type='method'><a href="module-routes_hardware.html#~generateStreamUrl">generateStreamUrl</a></li><li data-type='method'><a href="module-routes_hardware.html#~sendPN">sendPN</a></li></ul></li><li><a href="module-routes_index.html">routes/index</a><ul class='methods'><li data-type='method'><a href="module-routes_index.html#.get/logout">get/logout</a></li><li data-type='method'><a href="module-routes_index.html#.use/admin">use/admin</a></li><li data-type='method'><a href="module-routes_index.html#.use/public">use/public</a></li><li data-type='method'><a href="module-routes_index.html#.use/public/images/contact">use/public/images/contact</a></li><li data-type='method'><a href="module-routes_index.html#.use/public/images/property">use/public/images/property</a></li></ul></li><li><a href="module-routes_invoice.html">routes/invoice</a></li><li><a href="module-routes_invoiceInfo.html">routes/invoiceInfo</a><ul class='methods'><li data-type='method'><a href="module-routes_invoiceInfo.html#.CreateInvoiceInfo">CreateInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.DeleteInvoiceInfo">DeleteInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.GetInvoiceInfo">GetInvoiceInfo</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.GetInvoiceInfoAdmin">GetInvoiceInfoAdmin</a></li><li data-type='method'><a href="module-routes_invoiceInfo.html#.UpdateInvoiceInfo">UpdateInvoiceInfo</a></li></ul></li><li><a href="module-routes_keypad.html">routes/keypad</a><ul class='methods'><li data-type='method'><a href="module-routes_keypad.html#.PasscodeRoutes">PasscodeRoutes</a></li></ul></li><li><a href="module-routes_kit.html">routes/kit</a><ul class='methods'><li data-type='method'><a href="module-routes_kit.html#.ConfirmKit">ConfirmKit</a></li><li data-type='method'><a href="module-routes_kit.html#.CreateKit">CreateKit</a></li><li data-type='method'><a href="module-routes_kit.html#.DeleteKit">DeleteKit</a></li><li data-type='method'><a href="module-routes_kit.html#.GetAllKits">GetAllKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetKitById">GetKitById</a></li><li data-type='method'><a href="module-routes_kit.html#.GetOrderKits">GetOrderKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetOrderKits">GetOrderKits</a></li><li data-type='method'><a href="module-routes_kit.html#.GetUserKits">GetUserKits</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateKit">UpdateKit</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateKitState">UpdateKitState</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateMultipleKits">UpdateMultipleKits</a></li><li data-type='method'><a href="module-routes_kit.html#.UpdateShippingAddress">UpdateShippingAddress</a></li></ul></li><li><a href="module-routes_lock.html">routes/lock</a><ul class='methods'><li data-type='method'><a href="module-routes_lock.html#.ConfirmLockToken">ConfirmLockToken</a></li><li data-type='method'><a href="module-routes_lock.html#.GetLockLogs">GetLockLogs</a></li><li data-type='method'><a href="module-routes_lock.html#.GetLockStatus">GetLockStatus</a></li><li data-type='method'><a href="module-routes_lock.html#.SendLockCommand">SendLockCommand</a></li><li data-type='method'><a href="module-routes_lock.html#.StartLockTokenSession">StartLockTokenSession</a></li><li data-type='method'><a href="module-routes_lock.html#.ValidateLockToken">ValidateLockToken</a></li></ul></li><li><a href="module-routes_meeting.html">routes/meeting</a><ul class='methods'><li data-type='method'><a href="module-routes_meeting.html#.CancelMeeting">CancelMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.CreateMeeting">CreateMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.ExecuteTempLockCommand">ExecuteTempLockCommand</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetCancellationPage">GetCancellationPage</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetingDetails">GetMeetingDetails</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetingStats">GetMeetingStats</a></li><li data-type='method'><a href="module-routes_meeting.html#.GetMeetings">GetMeetings</a></li><li data-type='method'><a href="module-routes_meeting.html#.HandleMeetingAction">HandleMeetingAction</a></li><li data-type='method'><a href="module-routes_meeting.html#.HandleMeetingCancellation">HandleMeetingCancellation</a></li><li data-type='method'><a href="module-routes_meeting.html#.RescheduleMeeting">RescheduleMeeting</a></li><li data-type='method'><a href="module-routes_meeting.html#.RetrieveMeetings">RetrieveMeetings</a></li><li data-type='method'><a href="module-routes_meeting.html#.UpdateMeeting">UpdateMeeting</a></li></ul></li><li><a href="module-routes_notification.html">routes/notification</a><ul class='methods'><li data-type='method'><a href="module-routes_notification.html#.SendConfirmationEmail">SendConfirmationEmail</a></li><li data-type='method'><a href="module-routes_notification.html#.SendConfirmationSMS">SendConfirmationSMS</a></li></ul></li><li><a href="module-routes_order.html">routes/order</a><ul class='methods'><li data-type='method'><a href="module-routes_order.html#.CreateOrder">CreateOrder</a></li><li data-type='method'><a href="module-routes_order.html#.DeleteAllOrders">DeleteAllOrders</a></li><li data-type='method'><a href="module-routes_order.html#.GetAllOrders">GetAllOrders</a></li><li data-type='method'><a href="module-routes_order.html#.GetOrderById">GetOrderById</a></li><li data-type='method'><a href="module-routes_order.html#.GetOrderItems">GetOrderItems</a></li><li data-type='method'><a href="module-routes_order.html#.GetSessionInfo">GetSessionInfo</a></li><li data-type='method'><a href="module-routes_order.html#.GetSubscriptionInfo">GetSubscriptionInfo</a></li><li data-type='method'><a href="module-routes_order.html#.GetUserOrders">GetUserOrders</a></li><li data-type='method'><a href="module-routes_order.html#.ListOrdersWithUserInfo">ListOrdersWithUserInfo</a></li><li data-type='method'><a href="module-routes_order.html#.UpdateOrderState">UpdateOrderState</a></li></ul></li><li><a href="module-routes_product.html">routes/product</a><ul class='methods'><li data-type='method'><a href="module-routes_product.html#.CreateProduct">CreateProduct</a></li><li data-type='method'><a href="module-routes_product.html#.GetProducts">GetProducts</a></li></ul></li><li><a href="module-routes_property.html">routes/property</a><ul class='methods'><li data-type='method'><a href="module-routes_property.html#.CustomSearchProperties">CustomSearchProperties</a></li><li data-type='method'><a href="module-routes_property.html#.GetPropertiesByUser">GetPropertiesByUser</a></li><li data-type='method'><a href="module-routes_property.html#.GetPropertyById">GetPropertyById</a></li><li data-type='method'><a href="module-routes_property.html#.ListAgentProperties">ListAgentProperties</a></li><li data-type='method'><a href="module-routes_property.html#.ListProperties">ListProperties</a></li><li data-type='method'><a href="module-routes_property.html#.PingProperty">PingProperty</a></li><li data-type='method'><a href="module-routes_property.html#.PingPropertySession">PingPropertySession</a></li><li data-type='method'><a href="module-routes_property.html#.PingPropertySessionById">PingPropertySessionById</a></li></ul></li><li><a href="module-routes_shipment.html">routes/shipment</a><ul class='methods'><li data-type='method'><a href="module-routes_shipment.html#.ConfirmShipmentDelivery">ConfirmShipmentDelivery</a></li><li data-type='method'><a href="module-routes_shipment.html#.CreateShipment">CreateShipment</a></li><li data-type='method'><a href="module-routes_shipment.html#.DeleteAllShipments">DeleteAllShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.GetShipmentById">GetShipmentById</a></li><li data-type='method'><a href="module-routes_shipment.html#.ListAllShipments">ListAllShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.ListUserShipments">ListUserShipments</a></li><li data-type='method'><a href="module-routes_shipment.html#.UpdateShipmentState">UpdateShipmentState</a></li></ul></li><li><a href="module-routes_subscription.html">routes/subscription</a><ul class='methods'><li data-type='method'><a href="module-routes_subscription.html#.CreateSubscription">CreateSubscription</a></li><li data-type='method'><a href="module-routes_subscription.html#.DeleteAllSubscriptions">DeleteAllSubscriptions</a></li><li data-type='method'><a href="module-routes_subscription.html#.EndTrial">EndTrial</a></li><li data-type='method'><a href="module-routes_subscription.html#.GetAllSubscriptions">GetAllSubscriptions</a></li><li data-type='method'><a href="module-routes_subscription.html#.GetSubscriptionByUserId">GetSubscriptionByUserId</a></li></ul></li><li><a href="module-routes_transactions.html">routes/transactions</a><ul class='methods'><li data-type='method'><a href="module-routes_transactions.html#.GetAllTransactions">GetAllTransactions</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionById">GetTransactionById</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionsByHardware">GetTransactionsByHardware</a></li><li data-type='method'><a href="module-routes_transactions.html#.GetTransactionsByProperty">GetTransactionsByProperty</a></li></ul></li><li><a href="module-routes_users.html">routes/users</a><ul class='methods'><li data-type='method'><a href="module-routes_users.html#.CreateAdmin">CreateAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.CreateAgent">CreateAgent</a></li><li data-type='method'><a href="module-routes_users.html#.DeleteAdmin">DeleteAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.ForgotPassword">ForgotPassword</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdmin">GetAdmin</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdminAccountList">GetAdminAccountList</a></li><li data-type='method'><a href="module-routes_users.html#.GetAdminList">GetAdminList</a></li><li data-type='method'><a href="module-routes_users.html#.GetOrgs">GetOrgs</a></li><li data-type='method'><a href="module-routes_users.html#.GetStripe">GetStripe</a></li><li data-type='method'><a href="module-routes_users.html#.GetTimezone">GetTimezone</a></li><li data-type='method'><a href="module-routes_users.html#.GetUser">GetUser</a></li><li data-type='method'><a href="module-routes_users.html#.Login">Login</a></li><li data-type='method'><a href="module-routes_users.html#.Logout">Logout</a></li><li data-type='method'><a href="module-routes_users.html#.Register">Register</a></li><li data-type='method'><a href="module-routes_users.html#.RequestCode">RequestCode</a></li><li data-type='method'><a href="module-routes_users.html#.ResetPassword">ResetPassword</a></li><li data-type='method'><a href="module-routes_users.html#.ResetUserPassword">ResetUserPassword</a></li><li data-type='method'><a href="module-routes_users.html#.SuperadminRegister">SuperadminRegister</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateAgent">UpdateAgent</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateProfile">UpdateProfile</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateSettings">UpdateSettings</a></li><li data-type='method'><a href="module-routes_users.html#.UpdateUser">UpdateUser</a></li></ul></li><li><a href="module-routes_webhook.html">routes/webhook</a></li></ul><h3>Events</h3><ul><li><a href="module-routes_contactVerified.html#~event:CVWaitList">CVWaitList</a></li><li><a href="module-routes_contactVerified.html#~event:cleanupCVWaitList">cleanupCVWaitList</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">routes/users.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This module configures routes for managing user accounts and interactions.
 * It includes routes for user registration, authentication, password management, and administrative actions.
 * The routes also cover operations for managing user profiles, settings, and related entities like properties and subscriptions.
 *
 * @module routes/users
 */
const User = require('../models/user');
const Property = require('../models/property');
const Meeting = require('../models/meeting');
const Contact = require('../models/contact');
const Subscription = require('../models/subscription');
const Order = require('../models/order');
const Kit = require('../models/kit');
const router = require('express').Router();
const config = require('../config');
const notification = require('../controllers/notification');
const crypto = require('node:crypto');
const { uploadS3, getFileExtensionFromBase64 } = require('../helpers/aws-s3');
const { v4: uuidv4 } = require('uuid');

const { sendEmail } = require('../controllers/notification');
const { CognitoIdentityProviderClient, AdminSetUserPasswordCommand } = require('@aws-sdk/client-cognito-identity-provider');

const { parse } = require('json2csv')
const fs = require('fs')
const adminRole = require('../middlewares/adminRole')
const {
  cognitoSignUp,
  signInCognito,
  setPermanentUserPassword,
  deleteUserFromCognito,
  getSingleCognitoUser,
} = require('../helpers/cognito')
const errors = require('../errors')
const { cognitoUserGroups } = require('../constants')
const { authMiddleware } = require('../middlewares/authMiddleware')
const { ObjectId } = require('mongodb')
const { assignPropertyToUser } = require('../controllers/property');
const ConformationCode = require('../models/confirmationCode');

const stripe = require('stripe')(process.env.stripe_sk_live)







const client = new CognitoIdentityProviderClient({
  region: process.env.cognito_aws_region,
  credentials: {
    accessKeyId: process.env.aws_access_key_id,
    secretAccessKey: process.env.aws_secret_access_key
  }
});

/**
 * Handles password reset requests. Generates a reset token, saves it to the user record, and sends a password reset email.
 *
 * @name ForgotPassword
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the user's email address.
 * @param {Object} res - Express response object to send back the status of the password reset email.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post('/forgot-password', async (req, res) => {
  try {
    const { email } = req.body;
    const user = await User.findOne({ email });

    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    const resetToken = uuidv4();
    user.resetPasswordToken = resetToken;
    user.resetPasswordExpires = Date.now() + 3600000; // 1 hour
    await user.save();

    const resetUrl = `${process.env.APP_URL}/reset-password/${resetToken}`;
    const message = `
      &lt;h1>Password Reset Request&lt;/h1>
      &lt;p>Please click the link below to reset your password:&lt;/p>
      &lt;a href="${resetUrl}">Reset Password&lt;/a>
    `;

    await sendEmail({
      to: user.email,
      subject: 'Password Reset Request',
      body: message,
    });

    res.status(200).json({ message: 'Password reset email sent' });
  } catch (error) {
    console.log(error);
    res.status(500).json({ message: 'Error sending password reset email' });
  }
});

/**
 * Handles password reset using a token. Validates the token and updates the user's password.
 *
 * @name ResetPassword
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the reset token and new password.
 * @param {Object} res - Express response object to send back the status of the password reset.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post('/reset-password/:token', async (req, res) => {
  try {
    const { token } = req.params;
    const { password } = req.body;

    const user = await User.findOne({
      resetPasswordToken: token,
      resetPasswordExpires: { $gt: Date.now() },
    });

    if (!user) {
      return res.status(400).json({ message: 'Invalid or expired token' });
    }

    const params = {
      Username: user.email,
      UserPoolId: process.env.cognito_user_pool_id,
      Password: password,
      Permanent: true,
    };

    try {
      const command = new AdminSetUserPasswordCommand(params);
      await client.send(command);
    } catch (err) {
      console.error(err);
      return res.status(500).json({ message: 'Error resetting password' });
    }

    user.resetPasswordToken = undefined;
    user.resetPasswordExpires = undefined;
    await user.save();

    res.status(200).json({ message: 'Password reset successful' });
  } catch (error) {
    console.log(error);
    res.status(500).json({ message: 'Error resetting password' });
  }
});























/**
 * Retrieves Stripe subscription details for the authenticated user.
 *
 * @name GetStripe
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object to send back the subscription details.
 */
router.get('/stripe', authMiddleware, async (req, res) => {
  try {
    const user = await User.findById(req.user._id, { stripe: 1 })

    if (user.stripe.added) {
      // Retrieve customer's subscriptions
      const subscriptions = await stripe.subscriptions.list({
        customer: user.stripe.customerId,
      })
      if (subscriptions.data.length > 0) {
        // Retrieve subscription product
        const product = await stripe.products.retrieve(
          subscriptions.data[0].plan.product
        )
        const response = {
          name: product.name,
          description: product.description,
          status: subscriptions.data[0].status,
          amount: subscriptions.data[0].plan.amount / 100,
          currency: subscriptions.data[0].plan.currency,
          interval: subscriptions.data[0].plan.interval,
          period_start: subscriptions.data[0].current_period_start,
          period_end: subscriptions.data[0].current_period_end,
          created: subscriptions.data[0].created,
        }
        res.status(200).json(response)
      } else {
        res.status(404).json({ message: 'Stripe config not added' })
      }
    } else {
      res.status(404).json({ message: 'Stripe config not added' })
    }
  } catch (error) {
    console.log(error)
    res.status(500).json({ message: 'Error getting stripe config' })
  }
})

/**
 * Registers a new user with the provided information and confirmation code.
 *
 * @name Register
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing user information and confirmation code.
 * @param {Object} res - Express response object to send back the registration status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post('/register', async function (req, res, next) {
 try {
  if (!req.body.email) throw new Error('Email is required');
  if (!req.body.code) throw new Error("Confirmation code is required!");

  const codeRecord = await ConformationCode.findOne({ email: req.body.email });
  if (!codeRecord)
    throw new errors.NotFound("Code is not generated for given email!");
  const isValidCode = await ConformationCode.findOne({
    email: req.body.email,
    code: req.body.code,
  });
  if (!isValidCode) throw new errors.NotFound("Invalid code");

  var user = new User({
    email: req.body.email,
    firstName: req.body.firstName ?? '',
    lastName: req.body.lastName ?? '',
    jobTitle: req.body.jobTitle ?? '',
    phone: req.body.phone ?? '',
    role: cognitoUserGroups.admin,
    company: {
      name: req.body.companyName ?? '',
      website: req.body.website ?? '',
      units: req.body.units ?? '',
    },
  })

  let newUser = await User.findOne({ email: req.body.email }).then((res) => res)

  if (newUser) throw new errors.NotFound('User already exists')

  await User.create(user)

  const userId = await User.findOne({ email: req.body.email }).then((res) =>
    new ObjectId(res._id).toString()
  )

  const cognitoUser = { ...req.body, _id: userId }

  await cognitoSignUp(cognitoUser,cognitoUserGroups.admin)

  const tokens = await signInCognito(req.body.email, req.body.password)

  res.status(201).json({ role: cognitoUserGroups.agent, token: tokens.IdToken })
 } catch (error) {
  throw new errors.BadRequest(error)
 }
})

/**
 * Registers a new superadmin with the provided information and confirmation code.
 *
 * @name SuperadminRegister
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing user information and confirmation code.
 * @param {Object} res - Express response object to send back the registration status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post("/superadmin/register", async function (req, res, next) {
 try {
  if (!req.body.email) throw new Error("Email is required!");
  if (!req.body.code) throw new Error("Confirmation code is required!");
  if (!req.body.email.includes("delet.com")) throw new Error('Email must be associated with a delet employee');

  const codeRecord = await ConformationCode.findOne({ email: req.body.email });
  if (!codeRecord)
    throw new errors.NotFound("Code is not generated for given email!");
  const isValidCode = await ConformationCode.findOne({
    email: req.body.email,
    code: req.body.code,
  });
  if (!isValidCode) throw new errors.NotFound("Invalid code");

  var user = new User({
    email: req.body.email,
    firstName: req.body.firstName ?? "",
    lastName: req.body.lastName ?? "",
    jobTitle: req.body.jobTitle ?? "",
    phone: req.body.phone ?? "",
    role: cognitoUserGroups.admin,
    company: {
      name: req.body.companyName ?? "",
      website: req.body.website ?? "",
      units: req.body.units ?? "",
    },
  });
  await User.create(user);

  const userId = await User.findOne({ email: req.body.email }).then((res) =>
    new ObjectId(res._id).toString()
  );

  const cognitoUser = { ...req.body, _id: userId };

  await cognitoSignUp(cognitoUser, cognitoUserGroups.superadmin);

  const tokens = await signInCognito(req.body.email, req.body.password);

  res
    .status(201)
    .json({ role: cognitoUserGroups.superadmin, token: tokens.IdToken });
 } catch (error) {
  console.log(error);
    throw new errors.BadRequest(error)
 }
});

/**
 * Requests a confirmation code for user registration.
 *
 * @name RequestCode
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the user's email.
 * @param {Object} res - Express response object to send back the status of the request.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post("/request-code", async function (req, res, next) {
  const { email } = req.body;
  if (!email) throw new Error("Email is required");
  let isUserExits = await User.findOne({ email: req.body.email }).then(
    (res) => res
  );
  if (isUserExits) throw new errors.NotFound("User already exists");

  const code = Math.floor(100000 + Math.random() * 900000).toString();

  await ConformationCode.findOneAndUpdate(
    { email },
    { email, code },
    { new: true, upsert: true }
  );
  const emailBody = `
  &lt;body>
      &lt;p>Dear User,&lt;/p>
      &lt;p>Your confirmation code is: &lt;strong>${code}&lt;/strong>&lt;/p>
      &lt;p>Please enter this code to verify your email address.&lt;/p>
      &lt;br>
      &lt;p>Thank you!&lt;/p>
  &lt;/body>`;

  sendEmail({
    to: email,
    subject: `Confirmation Email`,
    body: emailBody,
  });
  res.status(200).send({
    role: cognitoUserGroups.superadmin,
    message: "Conformation code sent successfully",
  });
});
;

/**
 * Logs in a user with the provided email and password.
 *
 * @name Login
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the user's email and password.
 * @param {Object} res - Express response object to send back the login status and token.
 */
router.post('/login', async function (req, res) {
  const { email, password } = req.body

  const user = await User.findOne({ email: req.body.email.toLowerCase() }).then(
    (res) => res
  )

  let tokens = undefined

  if (!user) throw new errors.NotFound(`No user found with email : ${email}`)

  const formattedPassword =
    typeof password === 'number' ? String(password) : password

  try {
    await getSingleCognitoUser(user.email)

    tokens = await signInCognito(email, formattedPassword)

    return res.status(200).json({ role: user.role, token: tokens.IdToken })
  } catch (error) {
    if (error.__type === 'UserNotFoundException') {
      const hashVerify = crypto
        .pbkdf2Sync(password, user.salt, 25000, 512, 'sha256')
        .toString('hex')

      if (user.hash === hashVerify) {
        const registerCognitoUser = {
          _id: new ObjectId(user._id).toString(),
          email: user.email,
          firstName: user.firstName,
          lastName: user.lastName,
          phone: user.phone,
          role: user.role,
          password: formattedPassword,
        }

        await cognitoSignUp(registerCognitoUser, user.role)

        tokens = await signInCognito(email, formattedPassword)

        return res.status(200).json({ role: user.role, token: tokens.IdToken })
      } else {
        throw new errors.BadRequest('Invalid password')
      }
    } else {
      throw new errors.BadRequest(error.message)
    }
  }
})

/**
 * Resets a user's password. Requires admin authentication.
 *
 * @name ResetUserPassword
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the user's ID and new password.
 * @param {Object} res - Express response object to send back the status of the password reset.
 */
router.post('/admin/:id/reset', authMiddleware, async (req, res) => {
  try {
    const user = await User.findById(req.params.id, { email: 1 }).exec()
    if (!user) {
      throw new errors.NotFound('User not found')
    } else {
      await setPermanentUserPassword(user.email, req.body.password)

      res.status(200).json({ title: 'Success', message: 'Password updated' })
    }
  } catch (error) {
    console.log(error)
    if (error.message === 'User does not exist.') {
      const user = await User.findById(req.params.id)
      const registerCognitoUser = {
        _id: new ObjectId(user._id).toString(),
        email: user.email,
        firstName: user.firstName,
        lastName: user.lastName,
        phone: user.phone,
        role: user.role,
        password: req.body.password,
      }

      await cognitoSignUp(registerCognitoUser, user.role)
      res.status(200).json({ title: 'Success', message: 'Password updated' })
    } else {
      throw new errors.BadRequest('Invalid user')
    }
  }
})

/**
 * Updates user settings for the authenticated user.
 *
 * @name UpdateSettings
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the new settings.
 * @param {Object} res - Express response object to send back the updated settings.
 */
router.patch('/settings', authMiddleware, function (req, res, next) {
  let body = req.body
  User.findOneAndUpdate(
    { _id: req.user._id },
    { $set: { settings: body } },
    { upsert: false, multi: false, new: true }
  ).exec(function (err, user) {
    if (err) {
      return next(err)
    }
    return res.status(200).send(user.settings)
  })
})

/**
 * Updates the profile of the authenticated user.
 *
 * @name UpdateProfile
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the new profile information.
 * @param {Object} res - Express response object to send back the update status.
 */
router.patch('/profile', authMiddleware, async function (req, res, next) {
  let body = req.body

  let set = {
    firstName: body.firstName,
    lastName: body.lastName,
  }

  if (body?.profileImage) {

    const extension = getFileExtensionFromBase64(body.profileImage);
    const fileName = `public/images/profile/${uuidv4()}-profile.${extension}`;
    const uploaded = await uploadS3(body.profileImage, fileName);
    if (!uploaded.status) {
      res.status(500).send(uploaded.message)
      return
    }
    set['profileImage'] = `/${fileName}`
  }

  if (body.company !== undefined) {
    set['company.name'] = body.company.name
  }

  if (body?.company &amp;&amp; body?.company.idImage) {
    const idImageExtension = getFileExtensionFromBase64(body.company.idImage)
    const fileNameCompany = `public/images/company/${uuidv4()}-company.${idImageExtension}`

    const uploadedIdImage = await uploadS3(
      body.company.idImage,
      fileNameCompany
    )
    if (!uploadedIdImage.status) {
      res.status(500).send(uploadedIdImage.message)
      return
    }
    set['company.idImage'] = `/${fileNameCompany}`
  }

  for (let index in set) {
    if (!set[index]) {
      delete set[index]
    }
  }
  User.findOneAndUpdate(
    { _id: req.user._id },
    { $set: set },
    { upsert: false, multi: false, new: true }
  ).exec(function (err, property) {
    if (err) {
      return next(err)
    }
    return res.status(200).end()
  })
})

/**
 * Retrieves the authenticated user's details.
 *
 * @name GetUser
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object to send back the user's details.
 */
router.get('/', authMiddleware, function (req, res, next) {
  User.findOne({ _id: req.user._id })
    .populate('company', 'name idImage')
    .exec(function (err, user) {
      if (err) {
        return next(err)
      }

      return res.status(200).json(user)
    })
})

/**
 * Retrieves the authenticated user's timezone settings.
 *
 * @name GetTimezone
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object to send back the timezone settings.
 */
router.get('/timezone', authMiddleware, async function (req, res, next) {
  const user = await User.findOne({ _id: req.user._id })

  return res.status(200).json({ timezone: user.settings.meetings.timezone })
})

/**
 * Retrieves a list of organizations for admin users.
 *
 * @name GetOrgs
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object to send back the list of organizations.
 * @param {function} next - The next middleware function in the call stack.
 */
router.get(
  '/orgs',
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }

    next()
  },
  function (req, res, next) {
    User.find({ role: 'org' }, { email: 1, company: 1 }).exec(function (
      err,
      user
    ) {
      if (err) {
        return next(err)
      }
      const orgs = user.map((user) => {
        return { _id: user._id, name: `${user.email} | ${user.company.name}` }
      })
      return res.status(200).json(orgs)
    })
  }
)


router.get(
  '/orgs',
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }

    next()
  },
  function (req, res, next) {
    User.find({ role: 'org' }, { email: 1, company: 1 }).exec(function (
      err,
      user
    ) {
      if (err) {
        return next(err)
      }
      const orgs = user.map((user) => {
        return { _id: user._id, name: `${user.email} | ${user.company.name}` }
      })
      return res.status(200).json(orgs)
    })
  }
)

/**
 * Retrieves a list of admin users.
 *
 * @name GetAdminList
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object to send back the list of admin users.
 * @param {function} next - The next middleware function in the call stack.
 */
router.get(
  '/admin/list',
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }

    next()
  },
  function (req, res, next) {
    let fields = {}
    let query = {}
    if (req.query.format == 'minimal') {
      fields = {
        _id: 1,
        firstName: 1,
        lastName: 1,
        company: 1,
        email: 1,
      }
    }

    if (['admin', 'agent', 'org'].indexOf(req.query.role) != -1) {
      query.role = req.query.role
    }

    User.find(query, fields)
      .populate('org', 'company, email')
      .exec(function (err, users) {
        if (err) {
          return next(err)
        }
        return res.status(200).json(users)
      })
  }
)

/**
 * Retrieves a list of users associated with the authenticated admin.
 * This route requires the user to have an admin or superadmin role.
 *
 * @name GetAdminAccountList
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing query parameters for filtering and formatting the user list.
 * @param {Object} res - Express response object to send back the list of users.
 * @param {function} next - The next middleware function in the call stack.
 */
router.get(
  '/account/admin/list',
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)) {
      return res.status(403).end()
    }

    next()
  },
  function (req, res, next) {
    let fields = {}
    let query = {}
    if (req.query.format == 'minimal') {
      fields = {
        _id: 1,
        firstName: 1,
        lastName: 1,
        company: 1,
        email: 1,
      }
    }

    if (['admin', 'agent', 'org'].indexOf(req.query.role) != -1) {
      query.role = req.query.role
    }
    query.adminId = req.user._id

    User.find(query, fields)
      .populate('org', 'company, email')
      .exec(function (err, users) {
        if (err) {
          return next(err)
        }
        return res.status(200).json(users)
      })
  }
)

/**
 * Retrieves the details of a specific admin user.
 *
 * @name GetAdmin
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the admin user's ID.
 * @param {Object} res - Express response object to send back the admin user's details.
 * @param {function} next - The next middleware function in the call stack.
 */
router.get(
  '/admin/:id',
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }

    next()
  },
  function (req, res, next) {
    User.findOne({ _id: req.params.id }, { hash: 0, salt: 0 }).exec(function (
      err,
      user
    ) {
      if (err) {
        console.log(err)
        res.status(500).send(err)
      } else if (user === null) {
        res.status(404).json({ message: 'User not found' })
      } else {
        res.status(200).json(user)
      }
    })
  }
)


/**
 * Deletes a specific admin user and related data.
 *
 * @name DeleteAdmin
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the admin user's ID.
 * @param {Object} res - Express response object to send back the deletion status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.delete(
  '/admin/:id',
  authMiddleware,
  async function (req, res, next) {
      if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }

    const user = await User.findOne({ _id: req.params.id }).then((res) => res)

    User.findByIdAndRemove({ _id: req.params.id }).exec(function (err, count) {
      console.log(count)
    })

    await deleteUserFromCognito(user.email)

    Property.remove({ user: req.params.id }).exec(function (err, count) {
      console.log(count)
    })

    Contact.remove({ user: req.params.id }).exec(function (err, count) {
      console.log(count)
    })

    Meeting.remove({ user: req.params.id }).exec(function (err, count) {
      console.log(count)
    })
    next()
  },
  function (req, res, next) {
    res.status(200).end()
  }
)

/**
 * Creates a new admin user.
 *
 * @name CreateAdmin
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the new admin user's information.
 * @param {Object} res - Express response object to send back the creation status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post(
  '/admin/create',
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }
    next()
  },
  async function (req, res) {
    try {
      const user = new User({
        email: req.body.email,
        firstName: req.body.firstName,
        lastName: req.body.lastName,
        phone: req.body.phone,
        description: req.body.description,
        role: req.body.role,
        company: req.body.company,
      })

      await User.create(user)

      const userId = await User.findOne({ email: req.body.email }).then((res) =>
        new ObjectId(res._id).toString()
      )

      const userRole = await User.findOne({ email: req.body.email }).then(
        (res) => res.role
      )

      const cognitoUser = { ...req.body, _id: userId }

      await cognitoSignUp(cognitoUser, userRole)

      res.status(201).json({ role: userRole })
    } catch (error) {
      throw new errors.BadRequest(error)
    }
  }
)

/**
 * Creates a new agent and sends a notification email.
 *
 * @name CreateAgent
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the new agent's information.
 * @param {Object} res - Express response object to send back the creation status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post('/account/admin/create', authMiddleware, async function (req, res) { //create agent and notify
  try {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }
    const isUserExists = await User.findOne({
      email: req.body.email,
    }).then((res) => res);
    if (isUserExists) throw new errors.NotFound("User already exists");

    const newUser = new User({
      email: req.body.email,
      firstName: req.body.firstName,
      lastName: req.body.lastName,
      phone: req.body.phone,
      description: req.body.description,
      role: req.body.role,
      company: req.body.company,
      adminId: req.user._id,
    })
    await newUser.save()
    const emailBody = `
    &lt;body>
        &lt;p>Your account has been created!. You can login using these credentials&lt;/p>
        Username: &lt;b>${req.body.email}&lt;/b> &lt;br>
        Password: &lt;b>${req.body.password}&lt;/b> &lt;br>&lt;br>
    &lt;/body>`;

    sendEmail({
      to: req.body.email,
      subject: `Account created!`,
      body: emailBody
    })
    const userId = await User.findOne({ email: req.body.email }).then((res) =>
      new ObjectId(res._id).toString()
    )

    const userRole = await User.findOne({ email: req.body.email }).then(
      (res) => res.role
    )
    const cognitoUser = { ...req.body, _id: userId }

    await cognitoSignUp(cognitoUser, userRole)
    res.status(201).json({ role: newUser.role })
  } catch (error) {
    throw new errors.BadRequest(error)
  }
})

/**
 * Updates a specific agent.
 *
 * @name UpdateAgent
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the agent's ID and updated information.
 * @param {Object} res - Express response object to send back the update status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post(
  '/admin/:id', // update user
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }

    next()
  },
  function (req, res, next) {
    User.findOneAndUpdate(
      { _id: req.params.id },
      { $set: req.body },
      { upsert: false, new: true }
    ).exec((e, user) => {
      if (!user) {
        return res.status(403).end()
      }
      if (req.body.password &amp;&amp; req.body.password.length) {
        user.setPassword(req.body.password, function (err, user) {
          user.save(function (err) {
            if (err) {
              return next(err)
            }
            res.status(200).end()
          })
        })
      } else {
        res.json(user)
      }
    })
  }
)

/**
 * Updates a specific user.
 *
 * @name UpdateUser
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object containing the user's ID and updated information.
 * @param {Object} res - Express response object to send back the update status.
 * @param {function} next - The next middleware function in the call stack.
 */
router.post(
  '/account/admin/:id', // update agent
  authMiddleware,
  function (req, res, next) {
    if (![cognitoUserGroups.admin,cognitoUserGroups.superadmin].includes(req.user.role)){
      return res.status(403).end()
    }
    next()
  },
  function (req, res, next) {
    User.findOneAndUpdate(
      { _id: req.params.id },
      { $set: req.body },
      { upsert: false, new: true }
    ).exec((e, user) => {
      if (!user) {
        return res.status(403).end()
      }
      if (req.body.password &amp;&amp; req.body.password.length) {
        user.setPassword(req.body.password, function (err, user) {
          user.save(function (err) {
            if (err) {
              return next(err)
            }
            assignPropertyToUser(req, res, next, user)
          })
        })
      } else {
        assignPropertyToUser(req, res, next, user)
      }
    })
  }
)

/**
 * Logs out the user by ending the session.
 *
 * @name Logout
 * @function
 * @memberof module:routes/users
 * @param {Object} req - Express request object.
 * @param {Object} res - Express response object to redirect the user.
 */
router.get('/logout', function (req, res) {
  req.logout()
  res.redirect('/')
})

//======================================Rahman Test Routes ======================================//
//fetch user kits
router.get('/getS3Links', authMiddleware, async function (req, res, next) {
  try {
    let query = {
      user: req.user._id,
    }

    const kits = await Kit.find(query).exec()

    return res.status(200).json(kits)
  } catch (err) {
    return next(err)
  }
})

router.get('/:id/orders-and-subs', authMiddleware, async (req, res) => {
  const user = req.params.id
  try {
    const [subscription, orders] = await Promise.all([
      Subscription.findOne({ user }),
      Order.find({ user }),
    ])
    res.status(200).json({ subscription, orders })
  } catch (error) {
    console.log('Error getting subscriptions or orders: ', error)
  }
})

router.get('/export', authMiddleware, adminRole, async (req, res) => {
  const userList = await User.find()
  const formatUsers = userList.map((user) => ({
    'First Name': user.firstName,
    'Last Name': user.lastName,
    Email: user.email,
    Subscriptions: user.subscriptions,
    Role: user.role,
    'Job Title': user.jobTitle,
    Description: user.description,
    Phone: user.phone,
    Company: user.company,
  }))
  console.log(formatUsers)
  const csv = convertJsonToCsv(formatUsers)
  const filename = 'users.csv'

  res.header('Content-Type', 'text/csv')
  res.attachment(filename)
  res.send(csv)
})

router.get(
  "/company/agent",
  authMiddleware,
  function (req, res, next) {
    if (req.user.role !== cognitoUserGroups.agent) {
      return res.status(403).end();
    }
    next();
  },
  async (req, res, next) => {
    try {
      if (req.user.role !== cognitoUserGroups.agent) {
        return res.status(403).end();
      }

      const user = await User.findOne({
        role: "agent",
        _id: req.user._id,
      }).exec();
      if (!user) {
        return res.status(404).json({ message: "User not found" });
      }

      const admin = await User.findById(user.adminId).exec();
      if (!admin) {
        return res.status(404).json({ message: "Admin not found" });
      }

      return res.status(200).json(admin);
    } catch (err) {
      next(err);
    }
  }
);
function convertJsonToCsv(jsonData) {
  try {
    const csv = parse(jsonData)
    return csv
  } catch (err) {
    console.error('Error converting JSON to CSV:', err)
    throw err
  }
}
router.post('/change-password/:id', authMiddleware, async (req, res) => {
  try {
    const user = await User.findById(req.params.id, { email: 1 }).exec()
    if (!user) {
      throw new errors.NotFound('User not found')
    } else {
      await setPermanentUserPassword(user.email, req.body.password)

      res.status(200).json({ title: 'Success', message: 'Password updated' })
    }
  } catch (error) {
    console.log(error)
    if (error.message === 'User does not exist.') {
      const user = await User.findById(req.params.id)
      const registerCognitoUser = {
        _id: new ObjectId(user._id).toString(),
        email: user.email,
        firstName: user.firstName,
        lastName: user.lastName,
        phone: user.phone,
        role: user.role,
        password: req.body.password,
      }

      await cognitoSignUp(registerCognitoUser, user.role)
      res.status(200).json({ title: 'Success', message: 'Password updated' })
    } else {
      throw new errors.BadRequest('Invalid user')
    }
  }
})
//======================================Rahman Test Routes ======================================//

module.exports = router
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Jun 18 2024 16:15:44 GMT-0700 (北美太平洋夏令时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
